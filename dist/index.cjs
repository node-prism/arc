var ce=Object.create;var B=Object.defineProperty;var le=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var de=Object.getPrototypeOf,pe=Object.prototype.hasOwnProperty;var he=(e,t)=>{for(var r in t)B(e,r,{get:t[r],enumerable:!0})},gt=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of ue(t))!pe.call(e,i)&&i!==r&&B(e,i,{get:()=>t[i],enumerable:!(n=le(t,i))||n.enumerable});return e};var b=(e,t,r)=>(r=e!=null?ce(de(e)):{},gt(t||!e||!e.__esModule?B(r,"default",{value:e,enumerable:!0}):r,e)),me=e=>gt(B({},"__esModule",{value:!0}),e);var we={};he(we,{Collection:()=>D,EncryptedFSAdapter:()=>R,FSAdapter:()=>Q,LocalStorageAdapter:()=>M,ShardedCollection:()=>W});module.exports=me(we);var H=b(require("dot-wild"),1);var J=b(require("lodash"),1),ae=b(require("dot-wild"),1);var O=b(require("dot-wild"),1),_=b(require("lodash"),1);var bt=b(require("dot-wild"),1);function d(e){return Array.isArray(e)?e:e==null?[]:[e]}function u(e){return!!e&&Object.prototype.toString.call(e)==="[object Object]"}function x(e){return u(e)&&g(e).length===0}var v=Object.values,g=Object.keys,A=(e,t)=>e?Object.prototype.hasOwnProperty.call(e,t):!1;function Tt(e){return typeof e=="function"}function k(e){return u(e)&&g(e).forEach(t=>{!e[t]||!u(e[t])||(k(e[t]),g(e[t]).length===0&&delete e[t])}),e}function I(e){let t=bt.default.flatten(e);return Object.keys(t).reduce((r,n)=>{let i=n.replace(/\\./g,".");return r[i]=t[n],r},{})}var ge=e=>e.map(t=>r=>r[t]),be=e=>e.map(t=>t===1?"asc":"desc"),Te=(e,t)=>{let r={$floor:(n,i)=>{let o=O.default.get(n,i);return typeof o=="number"?Math.floor(o):0},$ceil:(n,i)=>{let o=O.default.get(n,i);return typeof o=="number"?Math.ceil(o):0},$sub:(n,i)=>{let o;for(let s of i){let a=typeof s=="number"?s:Number(O.default.get(n,s)??0);o=o===void 0?a:o-a}return o},$add:(n,i)=>i.reduce((o,s)=>{let a=Number(O.default.get(n,s)??0);return typeof s=="number"?o===void 0?s:o+s:o===void 0?a:o+a},void 0),$mult:(n,i)=>i.reduce((o,s)=>typeof s=="number"?Number(o)*s:Number(o)*(Number(O.default.get(n,s))||1),1),$div:(n,i)=>i.reduce((o,s)=>{let a=typeof s=="number"?s:Number(O.default.get(n,s)??1);return o===void 0?a:o/a},void 0),$fn:(n,i)=>i(n)};return g(t.aggregate).forEach(n=>{typeof t.aggregate[n]=="object"&&g(t.aggregate[n]).forEach(i=>{i[0]==="$"&&(!r[i]||(e=e.map(o=>(o[n]=r[i](o,t.aggregate[n][i]),o))))})}),e},S=(e,t)=>{if(t.aggregate&&(e=Te(e,t)),t.project){let o=Object.keys(t.project).reduce((a,f)=>{if(typeof t.project[f]=="number"&&typeof a=="number")return a+t.project[f]},0),s=o===Object.keys(t.project).length?1:o===0?2:0;if(s===1)e=e.map(a=>_.default.pick(a,g(t.project)));else if(s===2)e=e.map(a=>_.default.omit(a,g(t.project)));else if(s===0){let a=Object.keys(t.project).filter(f=>t.project[f]===0);e=e.map(f=>_.default.omit(f,a))}}t.sort&&(e=_.default.orderBy(e,ge(g(t.sort)),be(v(t.sort)))),t.skip&&typeof t.skip=="number"&&(e=e.slice(t.skip)),t.take&&typeof t.take=="number"&&(e=e.slice(0,t.take));let r=(o,s)=>s.reduce((a,f)=>{if(!f.collection)throw new Error("Missing required field in join: collection");if(!f.from)throw new Error("Missing required field in join: from");if(!f.on)throw new Error("Missing required field in join: on");if(!f.as)throw new Error("Missing required field in join: as");let c=f.options||{},l=f.collection,h=l.createId(),y=f.as.includes(".")&&f.as.includes("*");return a.map(p=>{y||(p=O.default.set(p,f.as,d(O.default.get(p,f.as)))),p[h]=[];let j=f.from.includes(".")?O.default.get(p,f.from):p[f.from];if(j===void 0)return p;if(p=O.default.set(p,f.as,[]),Array.isArray(j))return j.forEach((Z,z)=>{let mt={[`${f.on}`]:Z};y?p=O.default.set(p,f.as.replaceAll("*",z.toString()),l.find(mt,c)[0]):p[h]=p[h].concat(l.find(mt,c))}),y||(p=O.default.set(p,f.as,O.default.get(p,f.as).concat(p[h]))),delete p[h],p;let F={[`${f.on}`]:j};return y||(p[h]=l.find(F,c),p=O.default.set(p,f.as,O.default.get(p,f.as).concat(p[h]))),delete p[h],p})},o);t.join&&(e=r(e,t.join));let n=(o,s)=>{for(let a in s){let f=O.default.get(o,a);f==null&&(typeof s[a]=="function"?o=O.default.set(o,a,s[a](o)):o=O.default.set(o,a,s[a]))}return o},i=(o,s)=>{let a={array:f=>Array.isArray(f)&&f.length===0,string:f=>typeof f=="string"&&f.trim().length===0,object:f=>typeof f=="object"&&Object.keys(f).length===0};return Object.entries(s).reduce((f,[c,l])=>{let h=O.default.get(o,c);if(Object.values(a).some(p=>p(h))){let p=typeof l=="function"?l(o):l;return O.default.set(f,c,p)}return f},o)};return t.ifNull&&(e=e.map(o=>n(o,t.ifNull))),t.ifEmpty&&(e=e.map(o=>i(o,t.ifEmpty))),t.ifNullOrEmpty?e.map(o=>n(o,t.ifNullOrEmpty)).map(o=>i(o,t.ifNullOrEmpty)):e};var ot=b(require("dot-wild"),1);var yt=b(require("dot-wild"),1);function Y(e,t,r){return Object.entries(t).map(([n,i])=>{let o=d(i[r]),s=yt.default.get(e,n);return s===void 0?!1:o.some(a=>{if(typeof s=="string"||typeof s=="number")switch(r){case"$gt":return s>a;case"$gte":return s>=a;case"$lt":return s<a;case"$lte":return s<=a;default:return!1}else if(Array.isArray(s))switch(r){case"$gt":return s.length>a;case"$gte":return s.length>=a;case"$lt":return s.length<a;case"$lte":return s.length<=a;default:return!1}return!1})}).every(Boolean)}function Ot(e,t){return Y(e,t,"$gt")}function jt(e,t){return Y(e,t,"$gte")}function xt(e,t){return Y(e,t,"$lt")}function $t(e,t){return Y(e,t,"$lte")}var At=b(require("dot-wild"),1);function Et(e,t){if(!u(t))return!0;let r=d(t.$and);return r?r.every(n=>Object.keys(n).every(i=>{let o=n[i];if(typeof o=="function")return o(At.default.get(e,i));{let s=$(e,{[i]:o},{deep:!0,returnKey:m,clonedData:!0},e);return Boolean(s&&s.length)}})):!0}var vt=b(require("dot-wild"),1);function It(e,t){if(!u(t)||!t.$or)return!1;let r=d(t.$or);for(let n of r){let i=[];for(let[o,s]of Object.entries(n)){let a=vt.default.get(e,o);if(typeof s=="function"&&a!==void 0)i.push(s(a));else{let f=$(e,n,{deep:!0,returnKey:m,clonedData:!0},e);i.push(Boolean(f&&f.length))}}if(i.length&&i.includes(!0))return!0}return!1}var Ct=b(require("dot-wild"),1);function wt(e,t){if(!u(t))return!1;let r=d(t.$xor);if(r.length!==2)throw new Error(`invalid $xor query. expected exactly two values, found ${r.length}.`);return r.map(i=>Object.entries(i).map(([o,s])=>{let a=Ct.default.get(e,o)??e[o];if(typeof s=="function")return a!==void 0&&s(a);{let f=$(e,i,{deep:!0,returnKey:m,clonedData:!0},e);return Boolean(f&&f.length)}})).flat().filter(i=>i).length===1}var St=b(require("dot-wild"),1);function Dt(e,t){let r;return u(t)&&g(t).forEach(n=>{if(u(t[n])){let i=St.default.get(e,n);if(i===void 0)return;g(t[n]).forEach(o=>{o==="$fn"&&(r=!0,d(t[n][o]).forEach(s=>{s(i)||(r=!1)}))})}}),r!==void 0?r:!1}var _t=b(require("dot-wild"),1);function Vt(e,t){return u(t)?g(t).some(r=>{let n=_t.default.get(e,r);return u(t[r])&&n!==void 0&&t[r].$re?d(t[r].$re).every(i=>i.test(n)):!1}):!1}var Nt=b(require("dot-wild"),1);function Kt(e,t){let r=Object.entries(t).flatMap(([n,i])=>d(i.$includes).map(s=>Nt.default.get(e,n)?.includes(s))).filter(n=>n!==void 0);return r.length>0&&r.every(Boolean)}var Pt=b(require("dot-wild"),1);function Qt(e,t){let r=[];return u(t)&&g(t).forEach(n=>{if(t[n].$oneOf===void 0)return;let i=d(t[n].$oneOf),o=Pt.default.get(e,n);r.push(i.includes(o))}),!(!r.length||r.includes(!1))}var Rt=b(require("dot-wild"),1);function Mt(e,t){return u(t)?Object.entries(t).some(([r,n])=>{let i=Rt.default.get(e,r);return i!==void 0&&(Array.isArray(i)||typeof i=="string")&&i.length===n.$length}):!1}function Ft(e,t){let r=[];return u(t)&&g(t).forEach(n=>{if(n!=="$not")return;if(!u(t[n]))throw new Error(`$not operator requires an object as its value, received: ${t[n]}`);let i=d(t[n]);r.push(i.every(o=>{if(u(o)){let s=$(e,o,{deep:!0,returnKey:m,clonedData:!0},e);return!(s&&s.length)}return!A(e,o)}))}),r.every(n=>!n)}var Bt=b(require("dot-wild"),1);function Yt(e,t){let r=!1;return u(t)&&g(t).forEach(n=>{if(n!=="$has")return;let i=t[n];i=d(i),r=i.every(o=>Bt.default.get(e,o)!==void 0)}),r}var Ut=b(require("dot-wild"),1);function Jt(e,t){return d(t.$hasAny).some(n=>Ut.default.get(e,n))}var q=b(require("dot-wild"),1);var Lt=b(require("lodash"),1);var V=(e,t,r,n=!1)=>{if(!e)return;let i=o=>{if(!u(o))return o;let s=Lt.default.cloneDeep(o);for(let a of Object.keys(r))E(s,t)&&(n||A(s,a))&&(s[a]=r[a]);for(let a of Object.keys(s))(u(s[a])||Array.isArray(s[a]))&&(s[a]=V(s[a],t,r,n));return s};return u(e)&&!x(t)&&!x(r)?i(e):Array.isArray(e)&&!x(t)&&!x(r)?e.map(i):e};function Gt(e,t,r,n){return d(t).forEach(o=>{if(!u(o)){let s=I(r);g(s).forEach(a=>{e=e.map(f=>q.default.set(f,a,o))});return}if(u(o)){g(o).forEach(s=>{e=e.map(a=>q.default.set(a,s,o[s]))});return}e=V(e,r,o,!0)}),e}var Ht=b(require("dot-wild"),1);function tt(e,t,r,n){return d(t).forEach(o=>{if(Array.isArray(o))return tt(e,o,r,n);e=e.map(s=>Ht.default.set(s,o,void 0))}),e}var N=b(require("dot-wild"),1);function Wt(e,t,r,n){return d(t).forEach(o=>{if(!u(o)&&!Array.isArray(o)){let s=I(r);g(s).forEach(a=>{e=e.map(f=>N.default.get(f,a)!==void 0?N.default.set(f,a,o[a]):f)});return}if(u(o)){g(o).forEach(s=>{e=e.map(a=>N.default.get(a,s)!==void 0?N.default.set(a,s,o[s]):a)});return}e=V(e,r,o,!1)}),e}var T=b(require("dot-wild"),1);function U(e,t,r,n,i){let o=d(t);return e=e.map(s=>(o.forEach(a=>{if(u(a)){let f=I(a);g(f).forEach(c=>{let l=T.default.get(s,c),h=Number(a[c]);switch(n){case 0:l===void 0?s=T.default.set(s,c,h):s=T.default.set(s,c,Number(l)+h);break;case 1:l===void 0?s=T.default.set(s,c,-h):s=T.default.set(s,c,Number(l)-h);break;case 2:l===void 0?s=T.default.set(s,c,h):s=T.default.set(s,c,Number(l)*h);break;case 3:l===void 0?s=T.default.set(s,c,h):s=T.default.set(s,c,Number(l)/h);break}})}else if(typeof a=="number"){let f=I(r);f=Object.keys(f).reduce((c,l)=>{if(l.match(/\.\$has\.\d+$/)||l.match(/\.\$hasAny\.\d+$/)){let y=f[l];return y=d(y),y.forEach(p=>{if(l.match(/\.\$hasAny\.\d+$/)){let j=T.default.get(s,l.replace(/\.\$hasAny\.\d+$/,`.${p}`));j!==void 0&&typeof j=="number"&&(c[l.replace(/\.\$hasAny\.\d+$/,`.${p}`)]=j)}else c[l.replace(/\.\$has\.\d+$/,`.${p}`)]=T.default.get(s,l.replace(/\.\$has\.\d+$/,`.${p}`))??0}),c}if(l.match(/\$has/)||l.match(/\$hasAny/)){let y=f[l];return y=d(y),y.forEach(p=>{if(l.match(/\$hasAny/)){let j=T.default.get(s,l.replace(/\.\$hasAny/,`.${p}`));j!==void 0&&typeof j=="number"&&(c[l.replace(/\.\$hasAny/,`.${p}`)]=j)}else c[l.replace(/\.\$has/,`.${p}`)]=T.default.get(s,l.replace(/\.\$has/,`.${p}`))}),c}let h=l.replace(/\.\$.*$/,"");return c[h]=f[l],c},{}),g(f).forEach(c=>{let l=T.default.get(s,c);if(!(l!==void 0&&typeof l!="number"))switch(n){case 0:l===void 0?s=T.default.set(s,c,a):s=T.default.set(s,c,Number(l)+a);break;case 1:l===void 0?s=T.default.set(s,c,-a):s=T.default.set(s,c,Number(l)-a);break;case 2:l===void 0?s=T.default.set(s,c,a):s=T.default.set(s,c,Number(l)*a);break;case 3:l===void 0?s=T.default.set(s,c,a):s=T.default.set(s,c,Number(l)/a);break}})}}),s)),e}function Xt(e,t,r,n){return U(e,t,r,0,n)}function Zt(e,t,r,n){return U(e,t,r,1,n)}function zt(e,t,r,n){return U(e,t,r,2,n)}function kt(e,t,r,n){return U(e,t,r,3,n)}var et=b(require("lodash"),1);function qt(e,t,r,n=!1){if(e===void 0)return;let i=o=>{if(!u(o))return o;let s=et.default.cloneDeep(o);E(s,t)&&(n?et.default.merge(s,r):Object.assign(s,r));for(let a of Object.keys(s))(u(s[a])||Array.isArray(s[a]))&&(s[a]=i(s[a]));return s};return(Array.isArray(e)||u(e))&&!x(t)&&!x(r)?Array.isArray(e)?e.map(i):i(e):e}function te(e,t,r,n){return d(t).forEach(o=>{e=qt(e,r,o,!0)}),e}function ee(e,t,r,n){if(typeof t!="function")throw new Error("$map expected a function, e.g. { $map: (doc) => doc }");return e.map((i,o,s)=>t(i,o,s))}var rt=b(require("dot-wild"),1);function re(e,t,r,n){if(Tt(t))return e.filter((i,o,s)=>t(i,o,s)?!0:(i[m]&&n.remove({[m]:i[m]}),!1));if(u(t))return e.map(i=>(Object.keys(t).forEach(o=>{let s=rt.default.get(i,o);if(!Array.isArray(s))throw new Error(`$filter when providing an object to filter on, the key being operated on in the source document must be an array: ${o} was not an array`);let a=s.filter((f,c,l)=>t[o](f,c,l));i=rt.default.set(i,o,a)}),i));throw new Error("$filter expected either a function, e.g. { $filter: (doc) => doc }, or an array path with a function key, e.g. { $filter: { anArray: (doc) => doc } }")}var nt=b(require("dot-wild"),1);function ne(e,t,r,n){return d(t).reduce((o,s)=>u(s)?Object.keys(s).reduce((a,f)=>a.map(c=>{let l=nt.default.get(c,f),h=s[f];if(l!==void 0){let y=Array.isArray(h)?l.concat(h):l.concat([h]);return nt.default.set(c,f,y)}return c}),o):o,e)}var it=b(require("dot-wild"),1);function ie(e,t,r,n){return d(t).reduce((o,s)=>(u(s)&&Object.keys(s).forEach(a=>{o=o.map(f=>{let c=it.default.get(f,a);if(c!==void 0){let l=s[a],h=Array.isArray(l)?l.concat(c):[l].concat(c);return it.default.set(f,a,h)}return f})}),o),e)}var K={$gt:Ot,$gte:jt,$lt:xt,$lte:$t,$and:Et,$or:It,$xor:wt,$includes:Kt,$oneOf:Qt,$fn:Dt,$re:Vt,$length:Mt,$not:Ft,$has:Yt,$hasAny:Jt},oe={$merge:te,$map:ee,$filter:re,$push:ne,$unshift:ie,$set:Gt,$unset:tt,$change:Wt,$inc:Xt,$dec:Zt,$mult:zt,$div:kt};function se(e,t,r,n){return g(t).forEach(i=>{if(!oe[i]){console.warn(`unknown operator: ${i}`);return}e=oe[i](e,t[i],r,n)}),e}var E=(e,t)=>{if(typeof e!=typeof t)return!1;let r=(n,i)=>{if(n[i]===t[i])return!0;let o=[];return i.startsWith("$")&&o.push(i),i!=="$not"&&u(t[i])&&!x(t[i])&&(o=o.concat(g(t[i]).filter(s=>s.startsWith("$")))),o.length?o.every(s=>s==="$not"?!K[s](n,t):K[s](n,t)):i.includes(".")?ot.default.get(n,i)===t[i]:A(n,i)&&E(n[i],t[i])};return Array.isArray(e)&&Array.isArray(t)?e.some(n=>u(n)||Array.isArray(n))||t.some(n=>u(n)||Array.isArray(n))?e.every((n,i)=>E(e[i],t[i])):[...e].map(n=>`${n}`).sort().join(",")===[...t].map(n=>`${n}`).sort().join(","):Array.isArray(e)&&u(t)?Object.keys(t).every(n=>r(e,n)):u(e)&&u(t)?g(t).every(n=>r(e,n)):e===t},$=(e,t,r,n=null)=>{if(e===void 0)return;e.internal&&delete e.internal,A(e,r.returnKey)&&(n=e);let i,o=Object.keys(t).some(f=>f.startsWith("$")),s=f=>{if(!(!f||x(f))){if(i=d(i),f=d(f),Array.isArray(i)&&Array.isArray(f)){let c=i.map(l=>l[r.returnKey]);if(f.some(l=>c.includes(l[r.returnKey])))return}i=i.concat(f)}},a=f=>{!f||(A(f,r.returnKey)&&(n=f),E(f,t)?s(n):r.deep&&!o&&g(f).forEach(c=>{(u(f[c])||Array.isArray(f[c]))&&(A(t,c)?s($(f[c],t[c],r,n)):s($(f[c],t,r,n)))}))};if(e=d(e),u(t)&&Array.isArray(e)&&!o&&e.forEach((f,c)=>{A(f,r.returnKey)&&(n=f),g(t).forEach(l=>{if(typeof l=="string"&&l.includes(".")){let h=ot.default.get(f,l);h!==void 0&&s($(h,t[l],r,n))}else u(f)?E(e[c],t[l])&&s(n):E(e,t[l])&&s(n)})}),!x(t)&&Array.isArray(e))e.forEach(f=>a(f));else return e;return i};var ye=(e,t)=>{let r=new Map,n;return e=d(e),e.filter(i=>{if(i!==void 0)return n=r.get(i[t]),n!==void 0?!1:(r.set(i[t],!0),!0)})};function st(e,t,r,n,i){if(r={...L(),...r},t=d(t),t=t.filter(c=>Object.keys(c).length>0),!t.length){if(r.clonedData){let c=[];for(let l in e)l!=="internal"&&c.push(J.default.cloneDeep(e[l]));return S(c,r)}return S([...v(e)],r)}let o=[...v(e)].slice(1),s=[];for(let c of t){let l=[];if(c[m]&&!u(c[m])&&!n.integerIds)l.push(e[c[m]]);else if(c[m]&&!u(c[m])&&n.integerIds){let h=e.internal.id_map[c[m]];h&&l.push(e[h])}else{let h=at(J.default.cloneDeep(c)),y=Object.fromEntries(Object.entries(ae.default.flatten(h)).map(([p,j])=>[p.replace(/\\./g,"."),j]));Object.keys(y).some(p=>i.indices[p])?Object.keys(i.indices).forEach(p=>{let j=p.includes(".")?y[p]:c[p];if(j){let F=e.internal.index.valuesToId?.[p]?.[j];if(F){let Z=F?.map(z=>e[z]);l.push(...$(Z,c,r,n))}else l.push(...$(o,c,r,i))}}):(l=$(o,c,r,null),l===void 0&&(l=[]),l=d(l))}s.push(...l)}let a=ye(s,m);if(s=S(a,r),!r.clonedData)return s;let f=[];for(let c of s)f.push(J.default.cloneDeep(c));return f}var G=class{collection;inserted=[];removed=[];updated=[];operations=[];constructor(t){this.collection=t}insert(t){let r=this.collection.insert(t);return this.inserted.push(r),this.operations.push("insert"),r}update(t,r,n={}){let i=this.collection.find(t,{...n,project:void 0,join:void 0});return this.updated.push({documents:i,operations:r,options:n}),this.operations.push("update"),this.collection.update(t,r,n)}remove(t,r={}){let n=this.collection.find(t,{...r,project:void 0,join:void 0});return this.collection.remove(t,r),this.removed.push(n),this.operations.push("remove"),n}rollback(){let t=i=>{i.forEach(o=>{o[m]!==void 0?this.collection.remove({[m]:o[m]}):this.collection.remove({...o})})},r=i=>{i.documents.forEach(o=>{o[m]!==void 0?this.collection.assign(o[m],o):this.collection.update({...o},i.operations,i.options)})},n=i=>{i.forEach(o=>{o[m]!==void 0&&this.collection.assign(o[m],o)})};this.operations.reverse().forEach(i=>{switch(i){case"insert":t(this.inserted.pop());break;case"update":r(this.updated.pop());break;case"remove":n(this.removed.pop());break}}),this.inserted=[],this.updated=[],this.removed=[],this.operations=[]}commit(){this.inserted=[],this.updated=[],this.removed=[],this.collection._transaction=null}};var ft=b(require("dot-wild"),1);function ct(e,t,r,n,i,o){n={...L(),...n},t=d(t);let s=[];for(let a of t){let f=[];f=$([...v(e)],a,n,null),f=d(f),s.push(...se(f,r,a,o))}return n.returnKey===m&&i.timestamps&&s.forEach(a=>{let f;if(i.integerIds){let c=a[m];f=e.internal.id_map[c]}else f=a[m];Object.keys(o.indices).forEach(c=>{if(!ft.default.get(a,c))return;let l=e.internal.index.idToValues[f][c],h=String(ft.default.get(a,c));l!==h&&(e.internal.index.valuesToId[c][h]=e.internal.index.valuesToId[c][h]||[],e.internal.index.valuesToId[c][h].push(f),e.internal.index.valuesToId[c][l]=e.internal.index.valuesToId[c][l].filter(y=>y!==y),e.internal.index.valuesToId[c][l].length===0&&delete e.internal.index.valuesToId[c][l],e.internal.index.idToValues[f][c]=h)}),a[lt]=Date.now(),o.merge(a[m],a)}),S(s,n)}var ut=[];for(let e=0;e<256;e++)ut[e]=(e+256).toString(16).substring(1);function Oe(e,t){let r="000000"+e;return r.substring(r.length-t)}var je=32;function fe(e){let t=e.len||16,r="",n=0,i=1679616,o=e.init+Math.ceil(i/2);function s(){return o=o<=i?o:0,o++,(o-1).toString(16)}return()=>{if(!r||n===256){for(r="",n=(1+t)/2|0;n--;)r+=ut[256*Math.random()|0];r=r.substring(n=0,t)}let a=Date.now().toString(36),f=Oe(s(),6),c=ut[n++],l=parseInt(c,16)%je;return`a${a}${f}${c}${r}${l}`}}function L(){return{deep:!0,returnKey:m,clonedData:!0,sort:void 0,skip:void 0,project:void 0}}function at(e){let t=new Set(g(K)),r=n=>Object.entries(n).reduce((i,[o,s])=>{if(u(s)){let a=r(s);x(a)||(i[o]=a)}else t.has(o)||(i[o]=s);return i},{});return k(r(e))}var m="_id",xe="_created_at",lt="_updated_at",dt=e=>e!==void 0&&(typeof e=="string"||typeof e=="number"||typeof e=="boolean"),D=class{options;data={};_transaction=null;indices={};createId;constructor(t={}){if(t.autosync=t.autosync??!0,t.timestamps=t.timestamps??!0,t.integerIds=t.integerIds??!1,!t.adapter)throw new Error("No adapter provided.");this.options=t;let r=()=>({current:0,next_id:0,id_map:{},index:{valuesToId:{},idToValues:{}}});this.adapterRead(),this.data.internal||(this.data.internal=r()),this.createId=fe({init:this.data.internal.current,len:4})}adapterRead(){this.data=this.options.adapter.read()}assign(t,r){if(t!==void 0){if(this.options.integerIds){let n=t,i=this.data.internal.id_map[n];return i?(this.data[i]=r,this.data[i]):this.insert({...r,[m]:n})[0]}if(typeof t=="string"||typeof t=="number")return this.data[t]=r,this.data[t]}}filter(t){let r=Object.assign({},this.data);return delete r.internal,Object.values(r).filter(n=>{try{return t(n)}catch{return!1}})}find(t,r={}){return st(this.data,t,r,this.options,this)}update(t,r,n={}){return ct(this.data,t,r,n,this.options,this)}upsert(t,r,n={}){let i=this.update(t,r,n);if(i.length)return i;t=at(t);let o=this.insert(t);return ct(o,t,r,n,this.options,this)}remove(t,r={}){let n=this.find(t,{...r,clonedData:!1}),i=n.map(o=>Object.assign({},o));return n.forEach(o=>{let s;if(this.options.integerIds){let a=o[m];s=this.data.internal.id_map[a],delete this.data.internal.id_map[a]}else s=o[m];Object.keys(this.indices).forEach(a=>{let f=H.default.get(o,a);dt(f)&&(this.data.internal.index.valuesToId[a][f]=this.data.internal.index.valuesToId[a][f].filter(c=>c!==s),this.data.internal.index.valuesToId[a][f].length===0&&delete this.data.internal.index.valuesToId[a][f],delete this.data.internal.index.idToValues[s]),f===void 0&&Object.keys(this.data.internal.index.valuesToId[a]).forEach(c=>{this.data.internal.index.valuesToId[a][c]=this.data.internal.index.valuesToId[a][c].filter(l=>l!==s),this.data.internal.index.valuesToId[a][c].length===0&&delete this.data.internal.index.valuesToId[a][c]})}),delete this.data[s]}),this.sync(),i}insert(t){return Array.isArray(t)||(t=[t]),t.length?(t=t.map(r=>{let n=this.getId();if(this.data.internal.current++,this.options.timestamps&&(r[xe]=Date.now(),r[lt]=Date.now()),r[m]===void 0&&(r[m]=n,this.options.integerIds)){let i=this.nextIntegerId();this.data.internal.id_map[i]=n,r[m]=i}return this.data[n]=r,Object.keys(this.indices).forEach(i=>{let o=String(H.default.get(r,i));if(dt(o)){if(this.indices[i].unique&&this.data.internal.index.valuesToId?.[i]?.[o]!==void 0)throw new Error(`Unique index violation for key "${i}" and value "${o}"`);this.data.internal.index.valuesToId[i]=this.data.internal.index.valuesToId[i]||{},this.data.internal.index.valuesToId[i][o]=this.data.internal.index.valuesToId[i][o]||[],this.data.internal.index.valuesToId[i][o].push(n),this.data.internal.index.idToValues[n]=this.data.internal.index.idToValues[n]||{},this.data.internal.index.idToValues[n][i]=o}}),r}),this.options.autosync&&this.sync(),t):[]}merge(t,r){if(!!t){if(this.options.integerIds){let n=this.data.internal.id_map[t];if(!n||this.data[n]===void 0)return;Object.assign(this.data[n],x(r)?{}:r),this.sync();return}this.data[t]!==void 0&&(Object.assign(this.data[t],x(r)?{}:r),this.sync())}}sync(){return this.options.adapter.write(this.data)}drop(){this.data={internal:{current:0,next_id:0,id_map:{},index:{valuesToId:{},idToValues:{}}}}}getId(){return this.createId()}createIndex(t={}){if(!t.key)throw new Error("createIndex requires a key");t={key:t.key,unique:t.unique??!1};let{key:r,unique:n}=t;if(r.split(".").some(i=>!isNaN(Number(i))))throw new Error(`Cannot use a numeric property as an index key: ${r}`);if(this.indices[r]={unique:n},!this.data.internal.index.valuesToId[r])return Object.keys(this.data).forEach(i=>{if(i==="internal")return;let o=String(H.default.get(this.data[i],r));if(dt(o)){if(n&&this.data.internal.index.valuesToId?.[r]?.[o]!==void 0)throw new Error(`Unique index violation for key "${r}" and value "${o}"`);this.data.internal.index.valuesToId[r]=this.data.internal.index.valuesToId[r]||{},this.data.internal.index.valuesToId[r][o]=this.data.internal.index.valuesToId[r][o]||[],this.data.internal.index.valuesToId[r][o].push(i),this.data.internal.index.idToValues[i]=this.data.internal.index.idToValues[i]||{},this.data.internal.index.idToValues[i][r]=o}else throw new Error(`Invalid index value for property ${r}: ${o}`)}),this.sync(),this}removeIndex(t){return this.indices[t]?(delete this.indices[t],this.data.internal.index.valuesToId[t]&&delete this.data.internal.index.valuesToId[t],Object.keys(this.data.internal.index.idToValues).forEach(r=>{this.data.internal.index.idToValues[r][t]!==void 0&&delete this.data.internal.index.idToValues[r][t],x(this.data.internal.index.idToValues[r])&&delete this.data.internal.index.idToValues[r]}),this.sync(),!0):!1}nextIntegerId(){return this.data.internal.next_id++}transaction(t){this._transaction=new G(this);try{t(this._transaction)}catch(r){throw this._transaction.rollback(),r}this._transaction.commit()}};var W=class{collectionOptions;shards={};shardKey;shardCount;adapter;adapterOptions;constructor(t,r){this.collectionOptions=t,this.shardKey=r.shardKey,this.shardCount=r.shardCount,this.adapter=r.adapter,this.adapterOptions=r.adapterOptions}getShard(t){let r=t[this.shardKey];if(r===void 0)throw new Error(`Shard key ${this.shardKey} is not found in document`);let n=this.hashCode(r.toString())%this.shardCount;if(this.shards[n]===void 0){let i={...this.adapterOptions,name:`${this.adapterOptions?.name||"collection"}_shard${n}.json`};this.shards[n]=new D({...this.collectionOptions,adapter:new this.adapter(i)})}return this.shards[n]}hashCode(t){let r=0;if(t.length===0)return r;for(let n=0;n<t.length;n++){let i=t.charCodeAt(n);r=(r<<5)-r+i,r=r&r}return r}find(t,r={}){let n=[];for(let i of Object.keys(this.shards)){let o=this.shards[i].find(t,r);n.push(...o)}return n}insert(t){Array.isArray(t)||(t=[t]);let r=[];for(let n of t){let i=this.getShard(n);r.push(...i.insert(n))}return r}update(t,r,n={}){let i=[];for(let o of Object.keys(this.shards)){let s=this.shards[o].update(t,r,n);i.push(...s)}return i}upsert(t,r,n={}){let i=[];for(let o of Object.keys(this.shards)){let s=this.shards[o].upsert(t,r,n);i.push(...s)}return i}remove(t,r={}){let n=[];for(let i of Object.keys(this.shards)){let o=this.shards[i].remove(t,r);n.push(...o)}return n}drop(){for(let t of Object.keys(this.shards))this.shards[t].drop()}sync(){for(let t of Object.keys(this.shards))this.shards[t].sync()}};var C=b(require("fs"),1),pt=b(require("path"),1),P=class{elements=[];push(...t){this.elements.push(...t)}shift(){return this.elements.shift()}length(){return this.elements.length}},Q=class{storagePath;name;filePath;queue;constructor({storagePath:t,name:r}){r.endsWith(".json")||(r+=".json"),this.storagePath=t,this.name=r,this.queue=new P,this.filePath=pt.default.join(this.storagePath,this.name),this.prepareStorage()}prepareStorage(){C.default.existsSync(this.storagePath)||C.default.mkdirSync(this.storagePath),C.default.existsSync(this.filePath)||C.default.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{return Object.assign({},JSON.parse(C.default.readFileSync(this.filePath,"utf8"))||{})}catch{return{}}}write(t){for(this.queue.push([r=>{$e(r,this.filePath)},t]);this.queue.length();){let r=this.queue.shift();r[0](r[1])}}};function $e(e,...t){let n=(process.env.NODE_ENV||"development")==="development"?2:0,i=JSON.stringify(e,null,n);return Ae(i,...t)}function Ae(e,...t){let r=pt.default.join(...t);return C.default.writeFileSync(r,e)}var w=b(require("fs"),1),ht=b(require("path"),1);var X=b(require("crypto"),1),R=class{storagePath;name;filePath;queue;key;constructor({storagePath:t,name:r,key:n="Mahpsee2X7TKLe1xwJYmar91pCSaZIY7"}){r.endsWith(".json")||(r+=".json"),this.storagePath=t,this.name=r,this.queue=new P,this.filePath=ht.default.join(this.storagePath,this.name),this.key=n,this.prepareStorage()}prepareStorage(){w.default.existsSync(this.storagePath)||w.default.mkdirSync(this.storagePath),w.default.existsSync(this.filePath)||w.default.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{let t=w.default.readFileSync(this.filePath,"utf8"),r=Ce(t,this.key);return Object.assign({},JSON.parse(r)||{})}catch{return{}}}write(t){for(this.queue.push([r=>{Ee(r,this.key,this.filePath)},t]);this.queue.length();){let r=this.queue.shift();r[0](r[1])}}},Ee=(e,t,...r)=>{let n=JSON.stringify(e,null,0);return ve(Ie(n,t),...r)},ve=(e,...t)=>w.default.writeFileSync(ht.default.join(...t),e),Ie=(e,t)=>{let r=Buffer.from(X.default.randomBytes(16)).toString("hex").slice(0,16),n=X.default.createCipheriv("aes-256-cbc",Buffer.from(t),r),i=Buffer.concat([n.update(e),n.final()]);return`${r}:${i.toString("hex")}`},Ce=(e,t)=>{let r=e.includes(":")?e.split(":"):[],n=Buffer.from(r.shift()||"","binary"),i=Buffer.from(r.join(":"),"hex"),o=X.default.createDecipheriv("aes-256-cbc",Buffer.from(t),n);return Buffer.concat([o.update(i),o.final()]).toString()};var M=class{storageKey;constructor({storagePath:t}){this.storageKey=`arc_${t}`}read(){try{return Object.assign({},JSON.parse(localStorage.getItem(`arc_${this.storageKey}`)||"{}"))}catch(t){return console.error(`arc: failed to read from key: ${this.storageKey}: ${t}`),{}}}write(t){localStorage.setItem(this.storageKey,JSON.stringify(t))}};0&&(module.exports={Collection,EncryptedFSAdapter,FSAdapter,LocalStorageAdapter,ShardedCollection});
