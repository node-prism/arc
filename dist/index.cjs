var ft=Object.create;var F=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var ct=Object.getOwnPropertyNames;var ut=Object.getPrototypeOf,dt=Object.prototype.hasOwnProperty;var pt=(t,e)=>{for(var r in e)F(t,r,{get:e[r],enumerable:!0})},be=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ct(e))!dt.call(t,i)&&i!==r&&F(t,i,{get:()=>e[i],enumerable:!(n=lt(e,i))||n.enumerable});return t};var b=(t,e,r)=>(r=t!=null?ft(ut(t)):{},be(e||!t||!t.__esModule?F(r,"default",{value:t,enumerable:!0}):r,t)),ht=t=>be(F({},"__esModule",{value:!0}),t);var wt={};pt(wt,{Collection:()=>H,EncryptedFSAdapter:()=>Q,FSAdapter:()=>K,LocalStorageAdapter:()=>M});module.exports=ht(wt);var G=b(require("dot-wild"),1);var U=b(require("lodash"),1),st=b(require("dot-wild"),1);var T=b(require("dot-wild"),1),S=b(require("lodash"),1);var Te=b(require("dot-wild"),1);function d(t){return Array.isArray(t)?t:t==null?[]:[t]}function u(t){return!!t&&Object.prototype.toString.call(t)==="[object Object]"}function $(t){return u(t)&&g(t).length===0}var v=Object.values,g=Object.keys,E=(t,e)=>t?Object.prototype.hasOwnProperty.call(t,e):!1;function ye(t){return typeof t=="function"}function z(t){return u(t)&&g(t).forEach(e=>{!t[e]||!u(t[e])||(z(t[e]),g(t[e]).length===0&&delete t[e])}),t}function I(t){let e=Te.default.flatten(t);return Object.keys(e).reduce((r,n)=>{let i=n.replace(/\\./g,".");return r[i]=e[n],r},{})}var mt=t=>t.map(e=>r=>r[e]),gt=t=>t.map(e=>e===1?"asc":"desc");function bt(t,e){let r={$floor:(n,i)=>{let o=T.default.get(n,i);return typeof o=="number"?Math.floor(o):0},$ceil:(n,i)=>{let o=T.default.get(n,i);return typeof o=="number"?Math.ceil(o):0},$sub:(n,i)=>{let o;for(let s of i)typeof s=="number"?o===void 0?o=s:o-=s:o===void 0?o=Number(T.default.get(n,s)??0):o-=Number(T.default.get(n,s)??0);return o},$add:(n,i)=>i.reduce((o,s)=>typeof s=="number"?o===void 0?s:Number(o)+s:o===void 0?Number(T.default.get(n,s)??0):Number(o)+Number(T.default.get(n,s)??0),void 0),$mult:(n,i)=>i.reduce((o,s)=>typeof s=="number"?Number(o)*s:Number(o)*(Number(T.default.get(n,s))||1),1),$div:(n,i)=>i.reduce((o,s)=>{let f=typeof s=="number"?s:Number(T.default.get(n,s)??1);return o===void 0?f:o/f},void 0),$fn:(n,i)=>i(n)};return g(e.aggregate).forEach(n=>{typeof e.aggregate[n]=="object"&&g(e.aggregate[n]).forEach(i=>{i[0]==="$"&&(!r[i]||(t=t.map(o=>(o[n]=r[i](o,e.aggregate[n][i]),o))))})}),t}function D(t,e){if(e.aggregate&&(t=bt(t,e)),e.project){let o=Object.keys(e.project).reduce((f,a)=>{if(typeof e.project[a]=="number"&&typeof f=="number")return f+e.project[a]},0),s=o===Object.keys(e.project).length?1:o===0?2:0;if(s===1)t=t.map(f=>S.default.pick(f,g(e.project)));else if(s===2)t=t.map(f=>S.default.omit(f,g(e.project)));else if(s===0){let f=Object.keys(e.project).filter(a=>e.project[a]===0);t=t.map(a=>S.default.omit(a,f))}}e.sort&&(t=S.default.orderBy(t,mt(g(e.sort)),gt(v(e.sort)))),e.skip&&typeof e.skip=="number"&&(t=t.slice(e.skip)),e.take&&typeof e.take=="number"&&(t=t.slice(0,e.take));function r(o,s){return s.reduce((f,a)=>{if(!a.collection)throw new Error("Missing required field in join: collection");if(!a.from)throw new Error("Missing required field in join: from");if(!a.on)throw new Error("Missing required field in join: on");if(!a.as)throw new Error("Missing required field in join: as");let l=a.options||{},c=a.collection,h=c.createId(),O=a.as.includes(".")&&a.as.includes("*");return f.map(p=>{O||(p=T.default.set(p,a.as,d(T.default.get(p,a.as)))),p[h]=[];let j=a.from.includes(".")?T.default.get(p,a.from):p[a.from];if(j===void 0)return p;if(p=T.default.set(p,a.as,[]),Array.isArray(j))return j.forEach((X,Z)=>{let ge={[`${a.on}`]:X};O?p=T.default.set(p,a.as.replaceAll("*",Z.toString()),c.find(ge,l)[0]):p[h]=p[h].concat(c.find(ge,l))}),O||(p=T.default.set(p,a.as,T.default.get(p,a.as).concat(p[h]))),delete p[h],p;let R={[`${a.on}`]:j};return O||(p[h]=c.find(R,l),p=T.default.set(p,a.as,T.default.get(p,a.as).concat(p[h]))),delete p[h],p})},o)}e.join&&(t=r(t,e.join));function n(o,s){for(let f in s){let a=T.default.get(o,f);a==null&&(typeof s[f]=="function"?o=T.default.set(o,f,s[f](o)):o=T.default.set(o,f,s[f]))}return o}function i(o,s){let f={array:a=>Array.isArray(a)&&a.length===0,string:a=>typeof a=="string"&&a.trim().length===0,object:a=>typeof a=="object"&&Object.keys(a).length===0};return Object.entries(s).reduce((a,[l,c])=>{let h=T.default.get(o,l);if(Object.values(f).some(p=>p(h))){let p=typeof c=="function"?c(o):c;return T.default.set(a,l,p)}return a},o)}return e.ifNull&&(t=t.map(o=>n(o,e.ifNull))),e.ifEmpty&&(t=t.map(o=>i(o,e.ifEmpty))),e.ifNullOrEmpty?t.map(o=>n(o,e.ifNullOrEmpty)).map(o=>i(o,e.ifNullOrEmpty)):t}var oe=b(require("dot-wild"),1);var Oe=b(require("dot-wild"),1);function B(t,e,r){return Object.entries(e).map(([n,i])=>{let o=d(i[r]),s=Oe.default.get(t,n);return s===void 0?!1:o.some(f=>{if(typeof s=="string"||typeof s=="number")switch(r){case"$gt":return s>f;case"$gte":return s>=f;case"$lt":return s<f;case"$lte":return s<=f;default:return!1}else if(Array.isArray(s))switch(r){case"$gt":return s.length>f;case"$gte":return s.length>=f;case"$lt":return s.length<f;case"$lte":return s.length<=f;default:return!1}return!1})}).every(Boolean)}function je(t,e){return B(t,e,"$gt")}function xe(t,e){return B(t,e,"$gte")}function $e(t,e){return B(t,e,"$lt")}function Ee(t,e){return B(t,e,"$lte")}var Ae=b(require("dot-wild"),1);function ve(t,e){if(!u(e))return!0;let r=d(e.$and);return r?r.every(n=>Object.keys(n).every(i=>{let o=n[i],s=Ae.default.get(t,i);if(typeof o=="function")return o(s);{let f=x(t,{[i]:o},{deep:!0,returnKey:m,clonedData:!0},t);return Boolean(f&&f.length)}})):!0}var Ie=b(require("dot-wild"),1);function we(t,e){if(!u(e)||!e.$or)return!1;let r=d(e.$or);for(let n of r){let i=[];for(let[o,s]of Object.entries(n)){let f=Ie.default.get(t,o);if(typeof s=="function"&&f!==void 0)i.push(s(f));else{let a=x(t,n,{deep:!0,returnKey:m,clonedData:!0},t);i.push(Boolean(a&&a.length))}}if(i.length&&i.includes(!0))return!0}return!1}var Ce=b(require("dot-wild"),1);function Se(t,e){if(!u(e))return!1;let r=d(e.$xor);if(r.length!==2)throw new Error(`invalid $xor query. expected exactly two values, found ${r.length}.`);return r.map(i=>Object.entries(i).map(([o,s])=>{let f=Ce.default.get(t,o)??t[o];if(typeof s=="function")return f!==void 0&&s(f);{let a=x(t,i,{deep:!0,returnKey:m,clonedData:!0},t);return Boolean(a&&a.length)}})).flat().filter(i=>i).length===1}var De=b(require("dot-wild"),1);function _e(t,e){let r;return u(e)&&g(e).forEach(n=>{if(u(e[n])){let i=De.default.get(t,n);if(i===void 0)return;g(e[n]).forEach(o=>{o==="$fn"&&(r=!0,d(e[n][o]).forEach(s=>{s(i)||(r=!1)}))})}}),r!==void 0?r:!1}var Ve=b(require("dot-wild"),1);function Ne(t,e){let r=[];return u(e)&&g(e).forEach(n=>{if(u(e[n])){let i=Ve.default.get(t,n);i!==void 0&&g(e[n]).forEach(o=>{o==="$re"&&r.push(d(e[n][o]).every(s=>s.test(i)))})}}),r.length?!!(r.length&&r.includes(!0)):!1}var Pe=b(require("dot-wild"),1);function Ke(t,e){let r=Object.entries(e).flatMap(([n,i])=>d(i.$includes).map(s=>Pe.default.get(t,n)?.includes(s))).filter(n=>n!==void 0);return r.length>0&&r.every(Boolean)}var Qe=b(require("dot-wild"),1);function Me(t,e){let r=[];return u(e)&&g(e).forEach(n=>{if(e[n].$oneOf===void 0)return;let i=d(e[n].$oneOf),o=Qe.default.get(t,n);r.push(i.includes(o))}),!(!r.length||r.includes(!1))}var Re=b(require("dot-wild"),1);function Fe(t,e){return u(e)?Object.entries(e).some(([r,n])=>{let i=Re.default.get(t,r);return i!==void 0&&(Array.isArray(i)||typeof i=="string")&&i.length===n.$length}):!1}function Be(t,e){let r=[];return u(e)&&g(e).forEach(n=>{if(n!=="$not")return;if(!u(e[n]))throw new Error(`$not operator requires an object as its value, received: ${e[n]}`);let i=d(e[n]);r.push(i.every(o=>{if(u(o)){let s=x(t,o,{deep:!0,returnKey:m,clonedData:!0},t);return!(s&&s.length)}return!E(t,o)}))}),r.every(n=>!n)}var Ye=b(require("dot-wild"),1);function Ue(t,e){let r=!1;return u(e)&&g(e).forEach(n=>{if(n!=="$has")return;let i=e[n];i=d(i),r=i.every(o=>Ye.default.get(t,o)!==void 0)}),r}var Je=b(require("dot-wild"),1);function Le(t,e){return d(e.$hasAny).some(n=>Je.default.get(t,n))}var k=b(require("dot-wild"),1);var _=(t,e,r,n=!1)=>{if(t===void 0)return;let i=o=>{if(!u(o))return o;let s={...o};for(let f of Object.keys(r))A(s,e)&&(n||E(s,f))&&(s[f]=r[f]);for(let f of Object.keys(s))(u(s[f])||Array.isArray(s[f]))&&(s[f]=_(s[f],e,r,n));return s};return(Array.isArray(t)||u(t))&&!$(e)&&!$(r)?Array.isArray(t)?t.map(i):i(t):t};function Ge(t,e,r,n){return d(e).forEach(o=>{if(!u(o)){let s=I(r);g(s).forEach(f=>{t=t.map(a=>k.default.set(a,f,o))});return}if(u(o)){g(o).forEach(s=>{t=t.map(f=>k.default.set(f,s,o[s]))});return}t=_(t,r,o,!0)}),t}var He=b(require("dot-wild"),1);function q(t,e,r,n){return d(e).forEach(o=>{if(Array.isArray(o))return q(t,o,r,n);t=t.map(s=>He.default.set(s,o,void 0))}),t}var V=b(require("dot-wild"),1);function We(t,e,r,n){return d(e).forEach(o=>{if(!u(o)&&!Array.isArray(o)){let s=I(r);g(s).forEach(f=>{t=t.map(a=>V.default.get(a,f)!==void 0?V.default.set(a,f,o[f]):a)});return}if(u(o)){g(o).forEach(s=>{t=t.map(f=>V.default.get(f,s)!==void 0?V.default.set(f,s,o[s]):f)});return}t=_(t,r,o,!1)}),t}var y=b(require("dot-wild"),1);function Y(t,e,r,n,i){let o=d(e);return t=t.map(s=>(o.forEach(f=>{if(u(f)){let a=I(f);g(a).forEach(l=>{let c=y.default.get(s,l),h=Number(f[l]);switch(n){case 0:c===void 0?s=y.default.set(s,l,h):s=y.default.set(s,l,Number(c)+h);break;case 1:c===void 0?s=y.default.set(s,l,-h):s=y.default.set(s,l,Number(c)-h);break;case 2:c===void 0?s=y.default.set(s,l,h):s=y.default.set(s,l,Number(c)*h);break;case 3:c===void 0?s=y.default.set(s,l,h):s=y.default.set(s,l,Number(c)/h);break}})}else if(typeof f=="number"){let a=I(r);a=Object.keys(a).reduce((l,c)=>{if(c.match(/\.\$has\.\d+$/)||c.match(/\.\$hasAny\.\d+$/)){let O=a[c];return O=d(O),O.forEach(p=>{if(c.match(/\.\$hasAny\.\d+$/)){let j=y.default.get(s,c.replace(/\.\$hasAny\.\d+$/,`.${p}`));j!==void 0&&typeof j=="number"&&(l[c.replace(/\.\$hasAny\.\d+$/,`.${p}`)]=j)}else l[c.replace(/\.\$has\.\d+$/,`.${p}`)]=y.default.get(s,c.replace(/\.\$has\.\d+$/,`.${p}`))??0}),l}if(c.match(/\$has/)||c.match(/\$hasAny/)){let O=a[c];return O=d(O),O.forEach(p=>{if(c.match(/\$hasAny/)){let j=y.default.get(s,c.replace(/\.\$hasAny/,`.${p}`));j!==void 0&&typeof j=="number"&&(l[c.replace(/\.\$hasAny/,`.${p}`)]=j)}else l[c.replace(/\.\$has/,`.${p}`)]=y.default.get(s,c.replace(/\.\$has/,`.${p}`))}),l}let h=c.replace(/\.\$.*$/,"");return l[h]=a[c],l},{}),g(a).forEach(l=>{let c=y.default.get(s,l);if(!(c!==void 0&&typeof c!="number"))switch(n){case 0:c===void 0?s=y.default.set(s,l,f):s=y.default.set(s,l,Number(c)+f);break;case 1:c===void 0?s=y.default.set(s,l,-f):s=y.default.set(s,l,Number(c)-f);break;case 2:c===void 0?s=y.default.set(s,l,f):s=y.default.set(s,l,Number(c)*f);break;case 3:c===void 0?s=y.default.set(s,l,f):s=y.default.set(s,l,Number(c)/f);break}})}}),s)),t}function Xe(t,e,r,n){return Y(t,e,r,0,n)}function Ze(t,e,r,n){return Y(t,e,r,1,n)}function ze(t,e,r,n){return Y(t,e,r,2,n)}function ke(t,e,r,n){return Y(t,e,r,3,n)}var ee=b(require("lodash"),1);function te(t,e,r,n=!1){if(t===void 0)return;let i=o=>{if(!u(o))return o;let s=ee.default.cloneDeep(o);A(s,e)&&(n?ee.default.merge(s,r):Object.assign(s,r));for(let f of Object.keys(s))(u(s[f])||Array.isArray(s[f]))&&(s[f]=te(s[f],e,r));return s};return(Array.isArray(t)||u(t))&&!$(e)&&!$(r)?Array.isArray(t)?t.map(i):i(t):t}function qe(t,e,r,n){return d(e).forEach(o=>{t=te(t,r,o,!0)}),t}function et(t,e,r,n){if(typeof e!="function")throw new Error("$map expected a function, e.g. { $map: (doc) => doc }");return t.map((i,o,s)=>e(i,o,s))}var re=b(require("dot-wild"),1);function tt(t,e,r,n){if(ye(e))return t.filter((i,o,s)=>e(i,o,s)?!0:(i[m]&&n.remove({[m]:i[m]}),!1));if(u(e))return t.map(i=>(Object.keys(e).forEach(o=>{let s=re.default.get(i,o);if(!Array.isArray(s))throw new Error(`$filter when providing an object to filter on, the key being operated on in the source document must be an array: ${o} was not an array`);let f=s.filter((a,l,c)=>e[o](a,l,c));i=re.default.set(i,o,f)}),i));throw new Error("$filter expected either a function, e.g. { $filter: (doc) => doc }, or an array path with a function key, e.g. { $filter: { anArray: (doc) => doc } }")}var ne=b(require("dot-wild"),1);function rt(t,e,r,n){return d(e).reduce((o,s)=>u(s)?Object.keys(s).reduce((f,a)=>f.map(l=>{let c=ne.default.get(l,a),h=s[a];if(c!==void 0){let O=Array.isArray(h)?c.concat(h):c.concat([h]);return ne.default.set(l,a,O)}return l}),o):o,t)}var ie=b(require("dot-wild"),1);function nt(t,e,r,n){return d(e).reduce((o,s)=>(u(s)&&Object.keys(s).forEach(f=>{o=o.map(a=>{let l=ie.default.get(a,f);if(l!==void 0){let c=s[f],h=Array.isArray(c)?c.concat(l):[c].concat(l);return ie.default.set(a,f,h)}return a})}),o),t)}var N={$gt:je,$gte:xe,$lt:$e,$lte:Ee,$and:ve,$or:we,$xor:Se,$includes:Ke,$oneOf:Me,$fn:_e,$re:Ne,$length:Fe,$not:Be,$has:Ue,$hasAny:Le},it={$merge:qe,$map:et,$filter:tt,$push:rt,$unshift:nt,$set:Ge,$unset:q,$change:We,$inc:Xe,$dec:Ze,$mult:ze,$div:ke};function ot(t,e,r,n){return g(e).forEach(i=>{if(!it[i]){console.warn(`unknown operator: ${i}`);return}t=it[i](t,e[i],r,n)}),t}function A(t,e){if(typeof t!=typeof e)return!1;let r=(n,i)=>{if(n[i]===e[i])return!0;let o=[];return i.startsWith("$")&&o.push(i),i!=="$not"&&u(e[i])&&!$(e[i])&&(o=o.concat(g(e[i]).filter(s=>s.startsWith("$")))),o.length?o.every(s=>s==="$not"?!N[s](n,e):N[s](n,e)):i.includes(".")?oe.default.get(n,i)===e[i]:E(n,i)&&A(n[i],e[i])};return Array.isArray(t)&&Array.isArray(e)?t.some(n=>u(n)||Array.isArray(n))||e.some(n=>u(n)||Array.isArray(n))?t.every((n,i)=>A(t[i],e[i])):[...t].map(n=>`${n}`).sort().join(",")===[...e].map(n=>`${n}`).sort().join(","):Array.isArray(t)&&u(e)?Object.keys(e).every(n=>r(t,n)):u(t)&&u(e)?g(e).every(n=>r(t,n)):t===e}function x(t,e,r,n=null){if(t===void 0)return;t.internal&&delete t.internal,E(t,r.returnKey)&&(n=t);let i,o=Object.keys(e).some(a=>a.startsWith("$"));function s(a){if(!(!a||$(a))){if(i=d(i),a=d(a),Array.isArray(i)&&Array.isArray(a)){let l=i.map(c=>c[r.returnKey]);if(a.some(c=>l.includes(c[r.returnKey])))return}i=i.concat(a)}}function f(a){!a||(E(a,r.returnKey)&&(n=a),A(a,e)?s(n):r.deep&&!o&&g(a).forEach(l=>{(u(a[l])||Array.isArray(a[l]))&&(E(e,l)?s(x(a[l],e[l],r,n)):s(x(a[l],e,r,n)))}))}if(t=d(t),u(e)&&Array.isArray(t)&&!o&&t.forEach((a,l)=>{E(a,r.returnKey)&&(n=a),g(e).forEach(c=>{if(typeof c=="string"&&c.includes(".")){let h=oe.default.get(a,c);h!==void 0&&s(x(h,e[c],r,n))}else u(a)?A(t[l],e[c])&&s(n):A(t,e[c])&&s(n)})}),!$(e)&&Array.isArray(t))t.forEach(a=>f(a));else return t;return i}var Tt=(t,e)=>{let r=new Map,n;return t=d(t),t.filter(i=>{if(i!==void 0)return n=r.get(i[e]),n?i[e]!=n?(r.delete(i[e]),r.set(i[e],i[e]),!0):!1:(r.set(i[e],i[e]),!0)})};function se(t,e,r,n,i){if(r={...J(),...r},e=d(e),e=e.filter(l=>Object.keys(l).length>0),!e.length){if(r.clonedData){let l=[];for(let c in t)c!=="internal"&&l.push(U.default.cloneDeep(t[c]));return l}return D([...v(t)],r)}let o=[...v(t)].slice(1),s=[];for(let l of e){let c=[];if(l[m]&&!u(l[m])&&!n.integerIds)c.push(t[l[m]]);else if(l[m]&&!u(l[m])&&n.integerIds){let h=t.internal.id_map[l[m]];h&&c.push(t[h])}else{let h=ae(U.default.cloneDeep(l)),O=Object.fromEntries(Object.entries(st.default.flatten(h)).map(([p,j])=>[p.replace(/\\./g,"."),j]));Object.keys(O).some(p=>i.indices[p])?Object.keys(i.indices).forEach(p=>{let j=p.includes(".")?O[p]:l[p];if(j){let R=t.internal.index.valuesToId?.[p]?.[j];if(R){let X=R?.map(Z=>t[Z]);c.push(...x(X,l,r,n))}else c.push(...x(o,l,r,i))}}):(c=x(o,l,r,null),c===void 0&&(c=[]),c=d(c))}s.push(...c)}let f=Tt(s,m);if(s=D(f,r),!r.clonedData)return s;let a=[];for(let l of s)a.push(U.default.cloneDeep(l));return a}var L=class{collection;inserted=[];removed=[];updated=[];operations=[];constructor(e){this.collection=e}insert(e){let r=this.collection.insert(e);return this.inserted.push(r),this.operations.push("insert"),r}update(e,r,n={}){let i=this.collection.find(e,{...n,project:void 0,join:void 0});return this.updated.push({documents:i,operations:r,options:n}),this.operations.push("update"),this.collection.update(e,r,n)}remove(e,r={}){let n=this.collection.find(e,{...r,project:void 0,join:void 0});return this.collection.remove(e,r),this.removed.push(n),this.operations.push("remove"),n}rollback(){let e=i=>{i.forEach(o=>{o[m]!==void 0?this.collection.remove({[m]:o[m]}):this.collection.remove({...o})})},r=i=>{i.documents.forEach(o=>{o[m]!==void 0?this.collection.assign(o[m],o):this.collection.update({...o},i.operations,i.options)})},n=i=>{i.forEach(o=>{o[m]!==void 0&&this.collection.assign(o[m],o)})};this.operations.reverse().forEach(i=>{switch(i){case"insert":e(this.inserted.pop());break;case"update":r(this.updated.pop());break;case"remove":n(this.removed.pop());break}}),this.inserted=[],this.updated=[],this.removed=[],this.operations=[]}commit(){this.inserted=[],this.updated=[],this.removed=[],this.collection._transaction=null}};var fe=b(require("dot-wild"),1);function le(t,e,r,n,i,o){n={...J(),...n},e=d(e);let s=[];for(let f of e){let a=[];a=x([...v(t)],f,n,null),a=d(a),s.push(...ot(a,r,f,o))}return n.returnKey===m&&i.timestamps&&s.forEach(f=>{let a;if(i.integerIds){let l=f[m];a=t.internal.id_map[l]}else a=f[m];Object.keys(o.indices).forEach(l=>{if(!fe.default.get(f,l))return;let c=t.internal.index.idToValues[a][l],h=String(fe.default.get(f,l));c!==h&&(t.internal.index.valuesToId[l][h]=t.internal.index.valuesToId[l][h]||[],t.internal.index.valuesToId[l][h].push(a),t.internal.index.valuesToId[l][c]=t.internal.index.valuesToId[l][c].filter(O=>O!==O),t.internal.index.valuesToId[l][c].length===0&&delete t.internal.index.valuesToId[l][c],t.internal.index.idToValues[a][l]=h)}),f[ce]=Date.now(),o.merge(f[m],f)}),D(s,n)}var ue=256,de=[];for(;ue--;)de[ue]=(ue+256).toString(16).substring(1);function yt(t,e){let r="000000"+t;return r.substring(r.length-e)}var Ot=32;function at(t){let e=t.len||16,r="",n=0,i=Math.pow(36,4),o=t.init+Math.ceil(i/2);function s(){return o=o<=i?o:0,o++,(o-1).toString(16)}return function(){if(!r||n===256){for(r="",n=(1+e)/2|0;n--;)r+=de[256*Math.random()|0];r=r.substring(n=0,e)}let f=Date.now().toString(36),a=yt(s(),6),l=de[n++],c=parseInt(String(l),16)%Ot;return`a-${f}-${a}-${l}-${r}-${c}`}}function J(){return{deep:!0,returnKey:m,clonedData:!0,sort:void 0,skip:void 0,project:void 0}}function ae(t){let e=new Set(g(N)),r=n=>Object.entries(n).reduce((i,[o,s])=>{if(u(s)){let f=r(s);$(f)||(i[o]=f)}else e.has(o)||(i[o]=s);return i},{});return z(r(t))}var m="_id",jt="_created_at",ce="_updated_at",pe=t=>t!==void 0&&(typeof t=="string"||typeof t=="number"||typeof t=="boolean"),H=class{options;data={};_transaction=null;indices={};createId;constructor(e={}){if(e.autosync=e.autosync??!0,e.timestamps=e.timestamps??!0,e.integerIds=e.integerIds??!1,!e.adapter)throw new Error("No adapter provided.");this.options=e;let r=()=>({current:0,next_id:0,id_map:{},index:{valuesToId:{},idToValues:{}}});this.adapterRead(),this.data.internal||(this.data.internal=r()),this.createId=at({init:this.data.internal.current,len:4})}adapterRead(){this.data=this.options.adapter.read()}assign(e,r){if(e!==void 0){if(this.options.integerIds){let n=e,i=this.data.internal.id_map[n];return i?(this.data[i]=r,this.data[i]):this.insert({...r,[m]:n})[0]}if(typeof e=="string"||typeof e=="number")return this.data[e]=r,this.data[e]}}filter(e){let r=Object.assign({},this.data);return delete r.internal,Object.values(r).filter(n=>{try{return e(n)}catch{return!1}})}find(e,r={}){return se(this.data,e,r,this.options,this)}update(e,r,n={}){return le(this.data,e,r,n,this.options,this)}upsert(e,r,n={}){let i=this.update(e,r,n);if(i.length)return i;e=ae(e);let o=this.insert(e);return le(o,e,r,n,this.options,this)}remove(e,r={}){let n=this.find(e,{...r,clonedData:!1}),i=n.map(o=>Object.assign({},o));return n.forEach(o=>{let s;if(this.options.integerIds){let f=o[m];s=this.data.internal.id_map[f],delete this.data.internal.id_map[f]}else s=o[m];Object.keys(this.indices).forEach(f=>{let a=G.default.get(o,f);pe(a)&&(this.data.internal.index.valuesToId[f][a]=this.data.internal.index.valuesToId[f][a].filter(l=>l!==s),this.data.internal.index.valuesToId[f][a].length===0&&delete this.data.internal.index.valuesToId[f][a],delete this.data.internal.index.idToValues[s]),a===void 0&&Object.keys(this.data.internal.index.valuesToId[f]).forEach(l=>{this.data.internal.index.valuesToId[f][l]=this.data.internal.index.valuesToId[f][l].filter(c=>c!==s),this.data.internal.index.valuesToId[f][l].length===0&&delete this.data.internal.index.valuesToId[f][l]})}),delete this.data[s]}),this.sync(),i}insert(e){return Array.isArray(e)||(e=[e]),e.length?(e=e.map(r=>{let n=this.getId();if(this.data.internal.current++,this.options.timestamps&&(r[jt]=Date.now(),r[ce]=Date.now()),r[m]===void 0&&(r[m]=n,this.options.integerIds)){let i=this.nextIntegerId();this.data.internal.id_map[i]=n,r[m]=i}return this.data[n]=r,Object.keys(this.indices).forEach(i=>{let o=String(G.default.get(r,i));if(pe(o)){if(this.indices[i].unique&&this.data.internal.index.valuesToId?.[i]?.[o]!==void 0)throw new Error(`Unique index violation for key "${i}" and value "${o}"`);this.data.internal.index.valuesToId[i]=this.data.internal.index.valuesToId[i]||{},this.data.internal.index.valuesToId[i][o]=this.data.internal.index.valuesToId[i][o]||[],this.data.internal.index.valuesToId[i][o].push(n),this.data.internal.index.idToValues[n]=this.data.internal.index.idToValues[n]||{},this.data.internal.index.idToValues[n][i]=o}}),r}),this.options.autosync&&this.sync(),e):[]}merge(e,r){if(!!e){if(this.options.integerIds){let n=this.data.internal.id_map[e];if(!n||this.data[n]===void 0)return;Object.assign(this.data[n],$(r)?{}:r),this.sync();return}this.data[e]!==void 0&&(Object.assign(this.data[e],$(r)?{}:r),this.sync())}}sync(){return this.options.adapter.write(this.data)}drop(){this.data={internal:{current:0,next_id:0,id_map:{},index:{valuesToId:{},idToValues:{}}}}}getId(){return this.createId()}createIndex(e={}){if(!e.key)throw new Error("createIndex requires a key");e={key:e.key,unique:e.unique??!1};let{key:r,unique:n}=e;if(r.split(".").some(i=>!isNaN(Number(i))))throw new Error(`Cannot use a numeric property as an index key: ${r}`);if(this.indices[r]={unique:n},!this.data.internal.index.valuesToId[r])return Object.keys(this.data).forEach(i=>{if(i==="internal")return;let o=String(G.default.get(this.data[i],r));if(pe(o)){if(n&&this.data.internal.index.valuesToId?.[r]?.[o]!==void 0)throw new Error(`Unique index violation for key "${r}" and value "${o}"`);this.data.internal.index.valuesToId[r]=this.data.internal.index.valuesToId[r]||{},this.data.internal.index.valuesToId[r][o]=this.data.internal.index.valuesToId[r][o]||[],this.data.internal.index.valuesToId[r][o].push(i),this.data.internal.index.idToValues[i]=this.data.internal.index.idToValues[i]||{},this.data.internal.index.idToValues[i][r]=o}else throw new Error(`Invalid index value for property ${r}: ${o}`)}),this.sync(),this}removeIndex(e){return this.indices[e]?(delete this.indices[e],this.data.internal.index.valuesToId[e]&&delete this.data.internal.index.valuesToId[e],Object.keys(this.data.internal.index.idToValues).forEach(r=>{this.data.internal.index.idToValues[r][e]!==void 0&&delete this.data.internal.index.idToValues[r][e],$(this.data.internal.index.idToValues[r])&&delete this.data.internal.index.idToValues[r]}),this.sync(),!0):!1}nextIntegerId(){return this.data.internal.next_id++}transaction(e){this._transaction=new L(this);try{e(this._transaction)}catch(r){throw this._transaction.rollback(),r}this._transaction.commit()}};var w=b(require("fs"),1),he=b(require("path"),1),P=class{elements=[];push(...e){this.elements.push(...e)}shift(){return this.elements.shift()}length(){return this.elements.length}},K=class{storagePath;name;filePath;queue;constructor(e,r){r.endsWith(".json")||(r+=".json"),this.storagePath=e,this.name=r,this.queue=new P,this.filePath=he.default.join(this.storagePath,this.name),this.prepareStorage()}prepareStorage(){w.default.existsSync(this.storagePath)||w.default.mkdirSync(this.storagePath),w.default.existsSync(this.filePath)||w.default.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{return Object.assign({},JSON.parse(w.default.readFileSync(this.filePath,"utf8"))||{})}catch{return{}}}write(e){for(this.queue.push([r=>{xt(r,this.filePath)},e]);this.queue.length();){let r=this.queue.shift();r[0](r[1])}}};function xt(t,...e){let n=(process.env.NODE_ENV||"development")==="development"?2:0,i=JSON.stringify(t,null,n);return $t(i,...e)}function $t(t,...e){let r=he.default.join(...e);return w.default.writeFileSync(r,t)}var C=b(require("fs"),1),me=b(require("path"),1);var W=b(require("crypto"),1),Q=class{storagePath;name;filePath;queue;key;constructor(e,r,n="Mahpsee2X7TKLe1xwJYmar91pCSaZIY7"){r.endsWith(".json")||(r+=".json"),this.storagePath=e,this.name=r,this.queue=new P,this.filePath=me.default.join(this.storagePath,this.name),this.key=n,this.prepareStorage()}prepareStorage(){C.default.existsSync(this.storagePath)||C.default.mkdirSync(this.storagePath),C.default.existsSync(this.filePath)||C.default.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{let e=C.default.readFileSync(this.filePath,"utf8"),r=It(e,this.key);return Object.assign({},JSON.parse(r)||{})}catch{return{}}}write(e){for(this.queue.push([r=>{Et(r,this.key,this.filePath)},e]);this.queue.length();){let r=this.queue.shift();r[0](r[1])}}},Et=(t,e,...r)=>{let n=JSON.stringify(t,null,0);return At(vt(n,e),...r)},At=(t,...e)=>C.default.writeFileSync(me.default.join(...e),t),vt=(t,e)=>{let r=Buffer.from(W.default.randomBytes(16)).toString("hex").slice(0,16),n=W.default.createCipheriv("aes-256-cbc",Buffer.from(e),r),i=Buffer.concat([n.update(t),n.final()]);return`${r}:${i.toString("hex")}`},It=(t,e)=>{let r=t.includes(":")?t.split(":"):[],n=Buffer.from(r.shift()||"","binary"),i=Buffer.from(r.join(":"),"hex"),o=W.default.createDecipheriv("aes-256-cbc",Buffer.from(e),n);return Buffer.concat([o.update(i),o.final()]).toString()};var M=class{storageKey;constructor(e){this.storageKey=`arc_${e}`}read(){try{return Object.assign({},JSON.parse(localStorage.getItem(`arc_${this.storageKey}`)||"{}"))}catch(e){return console.error(`arc: failed to read from key: ${this.storageKey}: ${e}`),{}}}write(e){localStorage.setItem(this.storageKey,JSON.stringify(e))}};0&&(module.exports={Collection,EncryptedFSAdapter,FSAdapter,LocalStorageAdapter});
