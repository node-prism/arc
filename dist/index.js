import q from"dot-wild";import H from"lodash";import at from"dot-wild";import y from"dot-wild";import N from"lodash";import Je from"dot-wild";function p(t){return Array.isArray(t)?t:t==null?[]:[t]}function u(t){return!!t&&Object.prototype.toString.call(t)==="[object Object]"}function j(t){return u(t)&&g(t).length===0}var A=Object.values,g=Object.keys,$=(t,e)=>t?Object.prototype.hasOwnProperty.call(t,e):!1;function ie(t){return typeof t=="function"}function L(t){return u(t)&&g(t).forEach(e=>{!t[e]||!u(t[e])||(L(t[e]),g(t[e]).length===0&&delete t[e])}),t}function v(t){let e=Je.flatten(t);return Object.keys(e).reduce((r,n)=>{let o=n.replace(/\\./g,".");return r[o]=e[n],r},{})}var Le=t=>t.map(e=>r=>r[e]),Ge=t=>t.map(e=>e===1?"asc":"desc"),He=(t,e)=>{let r={$floor:(n,o)=>{let i=y.get(n,o);return typeof i=="number"?Math.floor(i):0},$ceil:(n,o)=>{let i=y.get(n,o);return typeof i=="number"?Math.ceil(i):0},$sub:(n,o)=>{let i;for(let s of o){let a=typeof s=="number"?s:Number(y.get(n,s)??0);i=i===void 0?a:i-a}return i},$add:(n,o)=>o.reduce((i,s)=>{let a=Number(y.get(n,s)??0);return typeof s=="number"?i===void 0?s:i+s:i===void 0?a:i+a},void 0),$mult:(n,o)=>o.reduce((i,s)=>typeof s=="number"?Number(i)*s:Number(i)*(Number(y.get(n,s))||1),1),$div:(n,o)=>o.reduce((i,s)=>{let a=typeof s=="number"?s:Number(y.get(n,s)??1);return i===void 0?a:i/a},void 0),$fn:(n,o)=>o(n)};return g(e.aggregate).forEach(n=>{typeof e.aggregate[n]=="object"&&g(e.aggregate[n]).forEach(o=>{o[0]==="$"&&(!r[o]||(t=t.map(i=>(i[n]=r[o](i,e.aggregate[n][o]),i))))})}),t},C=(t,e)=>{if(e.aggregate&&(t=He(t,e)),e.project){let i=Object.keys(e.project).reduce((a,f)=>{if(typeof e.project[f]=="number"&&typeof a=="number")return a+e.project[f]},0),s=i===Object.keys(e.project).length?1:i===0?2:0;if(s===1)t=t.map(a=>N.pick(a,g(e.project)));else if(s===2)t=t.map(a=>N.omit(a,g(e.project)));else if(s===0){let a=Object.keys(e.project).filter(f=>e.project[f]===0);t=t.map(f=>N.omit(f,a))}}e.sort&&(t=N.orderBy(t,Le(g(e.sort)),Ge(A(e.sort)))),e.skip&&typeof e.skip=="number"&&(t=t.slice(e.skip)),e.take&&typeof e.take=="number"&&(t=t.slice(0,e.take));let r=(i,s)=>s.reduce((a,f)=>{if(!f.collection)throw new Error("Missing required field in join: collection");if(!f.from)throw new Error("Missing required field in join: from");if(!f.on)throw new Error("Missing required field in join: on");if(!f.as)throw new Error("Missing required field in join: as");let l=f.options||{},c=f.collection,h=c.createId(),T=f.as.includes(".")&&f.as.includes("*");return a.map(d=>{T||(d=y.set(d,f.as,p(y.get(d,f.as)))),d[h]=[];let O=f.from.includes(".")?y.get(d,f.from):d[f.from];if(O===void 0)return d;if(d=y.set(d,f.as,[]),Array.isArray(O))return O.forEach((U,J)=>{let ne={[`${f.on}`]:U};T?d=y.set(d,f.as.replaceAll("*",J.toString()),c.find(ne,l)[0]):d[h]=d[h].concat(c.find(ne,l))}),T||(d=y.set(d,f.as,y.get(d,f.as).concat(d[h]))),delete d[h],d;let V={[`${f.on}`]:O};return T||(d[h]=c.find(V,l),d=y.set(d,f.as,y.get(d,f.as).concat(d[h]))),delete d[h],d})},i);e.join&&(t=r(t,e.join));let n=(i,s)=>{for(let a in s){let f=y.get(i,a);f==null&&(typeof s[a]=="function"?i=y.set(i,a,s[a](i)):i=y.set(i,a,s[a]))}return i},o=(i,s)=>{let a={array:f=>Array.isArray(f)&&f.length===0,string:f=>typeof f=="string"&&f.trim().length===0,object:f=>typeof f=="object"&&Object.keys(f).length===0};return Object.entries(s).reduce((f,[l,c])=>{let h=y.get(i,l);if(Object.values(a).some(d=>d(h))){let d=typeof c=="function"?c(i):c;return y.set(f,l,d)}return f},i)};return e.ifNull&&(t=t.map(i=>n(i,e.ifNull))),e.ifEmpty&&(t=t.map(i=>o(i,e.ifEmpty))),e.ifNullOrEmpty?t.map(i=>n(i,e.ifNullOrEmpty)).map(i=>o(i,e.ifNullOrEmpty)):t};import Me from"dot-wild";import We from"dot-wild";function P(t,e,r){return Object.entries(e).map(([n,o])=>{let i=p(o[r]),s=We.get(t,n);return s===void 0?!1:i.some(a=>{if(typeof s=="string"||typeof s=="number")switch(r){case"$gt":return s>a;case"$gte":return s>=a;case"$lt":return s<a;case"$lte":return s<=a;default:return!1}else if(Array.isArray(s))switch(r){case"$gt":return s.length>a;case"$gte":return s.length>=a;case"$lt":return s.length<a;case"$lte":return s.length<=a;default:return!1}return!1})}).every(Boolean)}function oe(t,e){return P(t,e,"$gt")}function se(t,e){return P(t,e,"$gte")}function ae(t,e){return P(t,e,"$lt")}function fe(t,e){return P(t,e,"$lte")}import Xe from"dot-wild";function le(t,e){if(!u(e))return!0;let r=p(e.$and);return r?r.every(n=>Object.keys(n).every(o=>{let i=n[o];if(typeof i=="function")return i(Xe.get(t,o));{let s=x(t,{[o]:i},{deep:!0,returnKey:m,clonedData:!0},t);return Boolean(s&&s.length)}})):!0}import Ze from"dot-wild";function ce(t,e){if(!u(e)||!e.$or)return!1;let r=p(e.$or);for(let n of r){let o=[];for(let[i,s]of Object.entries(n)){let a=Ze.get(t,i);if(typeof s=="function"&&a!==void 0)o.push(s(a));else{let f=x(t,n,{deep:!0,returnKey:m,clonedData:!0},t);o.push(Boolean(f&&f.length))}}if(o.length&&o.includes(!0))return!0}return!1}import ze from"dot-wild";function ue(t,e){if(!u(e))return!1;let r=p(e.$xor);if(r.length!==2)throw new Error(`invalid $xor query. expected exactly two values, found ${r.length}.`);return r.map(o=>Object.entries(o).map(([i,s])=>{let a=ze.get(t,i)??t[i];if(typeof s=="function")return a!==void 0&&s(a);{let f=x(t,o,{deep:!0,returnKey:m,clonedData:!0},t);return Boolean(f&&f.length)}})).flat().filter(o=>o).length===1}import ke from"dot-wild";function pe(t,e){let r;return u(e)&&g(e).forEach(n=>{if(u(e[n])){let o=ke.get(t,n);if(o===void 0)return;g(e[n]).forEach(i=>{i==="$fn"&&(r=!0,p(e[n][i]).forEach(s=>{s(o)||(r=!1)}))})}}),r!==void 0?r:!1}import qe from"dot-wild";function de(t,e){let r=[];return u(e)&&g(e).forEach(n=>{if(u(e[n])){let o=qe.get(t,n);o!==void 0&&g(e[n]).forEach(i=>{i==="$re"&&r.push(p(e[n][i]).every(s=>s.test(o)))})}}),r.length?!!(r.length&&r.includes(!0)):!1}import et from"dot-wild";function he(t,e){let r=Object.entries(e).flatMap(([n,o])=>p(o.$includes).map(s=>et.get(t,n)?.includes(s))).filter(n=>n!==void 0);return r.length>0&&r.every(Boolean)}import tt from"dot-wild";function me(t,e){let r=[];return u(e)&&g(e).forEach(n=>{if(e[n].$oneOf===void 0)return;let o=p(e[n].$oneOf),i=tt.get(t,n);r.push(o.includes(i))}),!(!r.length||r.includes(!1))}import rt from"dot-wild";function ge(t,e){return u(e)?Object.entries(e).some(([r,n])=>{let o=rt.get(t,r);return o!==void 0&&(Array.isArray(o)||typeof o=="string")&&o.length===n.$length}):!1}function be(t,e){let r=[];return u(e)&&g(e).forEach(n=>{if(n!=="$not")return;if(!u(e[n]))throw new Error(`$not operator requires an object as its value, received: ${e[n]}`);let o=p(e[n]);r.push(o.every(i=>{if(u(i)){let s=x(t,i,{deep:!0,returnKey:m,clonedData:!0},t);return!(s&&s.length)}return!$(t,i)}))}),r.every(n=>!n)}import nt from"dot-wild";function Te(t,e){let r=!1;return u(e)&&g(e).forEach(n=>{if(n!=="$has")return;let o=e[n];o=p(o),r=o.every(i=>nt.get(t,i)!==void 0)}),r}import it from"dot-wild";function ye(t,e){return p(e.$hasAny).some(n=>it.get(t,n))}import Oe from"dot-wild";import ot from"lodash";var S=(t,e,r,n=!1)=>{if(!t)return;let o=i=>{if(!u(i))return i;let s=ot.cloneDeep(i);for(let a of Object.keys(r))E(s,e)&&(n||$(s,a))&&(s[a]=r[a]);for(let a of Object.keys(s))(u(s[a])||Array.isArray(s[a]))&&(s[a]=S(s[a],e,r,n));return s};return u(t)&&!j(e)&&!j(r)?o(t):Array.isArray(t)&&!j(e)&&!j(r)?t.map(o):t};function je(t,e,r,n){return p(e).forEach(i=>{if(!u(i)){let s=v(r);g(s).forEach(a=>{t=t.map(f=>Oe.set(f,a,i))});return}if(u(i)){g(i).forEach(s=>{t=t.map(a=>Oe.set(a,s,i[s]))});return}t=S(t,r,i,!0)}),t}import st from"dot-wild";function G(t,e,r,n){return p(e).forEach(i=>{if(Array.isArray(i))return G(t,i,r,n);t=t.map(s=>st.set(s,i,void 0))}),t}import K from"dot-wild";function xe(t,e,r,n){return p(e).forEach(i=>{if(!u(i)&&!Array.isArray(i)){let s=v(r);g(s).forEach(a=>{t=t.map(f=>K.get(f,a)!==void 0?K.set(f,a,i[a]):f)});return}if(u(i)){g(i).forEach(s=>{t=t.map(a=>K.get(a,s)!==void 0?K.set(a,s,i[s]):a)});return}t=S(t,r,i,!1)}),t}import b from"dot-wild";function Q(t,e,r,n,o){let i=p(e);return t=t.map(s=>(i.forEach(a=>{if(u(a)){let f=v(a);g(f).forEach(l=>{let c=b.get(s,l),h=Number(a[l]);switch(n){case 0:c===void 0?s=b.set(s,l,h):s=b.set(s,l,Number(c)+h);break;case 1:c===void 0?s=b.set(s,l,-h):s=b.set(s,l,Number(c)-h);break;case 2:c===void 0?s=b.set(s,l,h):s=b.set(s,l,Number(c)*h);break;case 3:c===void 0?s=b.set(s,l,h):s=b.set(s,l,Number(c)/h);break}})}else if(typeof a=="number"){let f=v(r);f=Object.keys(f).reduce((l,c)=>{if(c.match(/\.\$has\.\d+$/)||c.match(/\.\$hasAny\.\d+$/)){let T=f[c];return T=p(T),T.forEach(d=>{if(c.match(/\.\$hasAny\.\d+$/)){let O=b.get(s,c.replace(/\.\$hasAny\.\d+$/,`.${d}`));O!==void 0&&typeof O=="number"&&(l[c.replace(/\.\$hasAny\.\d+$/,`.${d}`)]=O)}else l[c.replace(/\.\$has\.\d+$/,`.${d}`)]=b.get(s,c.replace(/\.\$has\.\d+$/,`.${d}`))??0}),l}if(c.match(/\$has/)||c.match(/\$hasAny/)){let T=f[c];return T=p(T),T.forEach(d=>{if(c.match(/\$hasAny/)){let O=b.get(s,c.replace(/\.\$hasAny/,`.${d}`));O!==void 0&&typeof O=="number"&&(l[c.replace(/\.\$hasAny/,`.${d}`)]=O)}else l[c.replace(/\.\$has/,`.${d}`)]=b.get(s,c.replace(/\.\$has/,`.${d}`))}),l}let h=c.replace(/\.\$.*$/,"");return l[h]=f[c],l},{}),g(f).forEach(l=>{let c=b.get(s,l);if(!(c!==void 0&&typeof c!="number"))switch(n){case 0:c===void 0?s=b.set(s,l,a):s=b.set(s,l,Number(c)+a);break;case 1:c===void 0?s=b.set(s,l,-a):s=b.set(s,l,Number(c)-a);break;case 2:c===void 0?s=b.set(s,l,a):s=b.set(s,l,Number(c)*a);break;case 3:c===void 0?s=b.set(s,l,a):s=b.set(s,l,Number(c)/a);break}})}}),s)),t}function $e(t,e,r,n){return Q(t,e,r,0,n)}function Ee(t,e,r,n){return Q(t,e,r,1,n)}function Ae(t,e,r,n){return Q(t,e,r,2,n)}function ve(t,e,r,n){return Q(t,e,r,3,n)}import Ie from"lodash";function we(t,e,r,n=!1){if(t===void 0)return;let o=i=>{if(!u(i))return i;let s=Ie.cloneDeep(i);E(s,e)&&(n?Ie.merge(s,r):Object.assign(s,r));for(let a of Object.keys(s))(u(s[a])||Array.isArray(s[a]))&&(s[a]=o(s[a]));return s};return(Array.isArray(t)||u(t))&&!j(e)&&!j(r)?Array.isArray(t)?t.map(o):o(t):t}function Ce(t,e,r,n){return p(e).forEach(i=>{t=we(t,r,i,!0)}),t}function Se(t,e,r,n){if(typeof e!="function")throw new Error("$map expected a function, e.g. { $map: (doc) => doc }");return t.map((o,i,s)=>e(o,i,s))}import De from"dot-wild";function _e(t,e,r,n){if(ie(e))return t.filter((o,i,s)=>e(o,i,s)?!0:(o[m]&&n.remove({[m]:o[m]}),!1));if(u(e))return t.map(o=>(Object.keys(e).forEach(i=>{let s=De.get(o,i);if(!Array.isArray(s))throw new Error(`$filter when providing an object to filter on, the key being operated on in the source document must be an array: ${i} was not an array`);let a=s.filter((f,l,c)=>e[i](f,l,c));o=De.set(o,i,a)}),o));throw new Error("$filter expected either a function, e.g. { $filter: (doc) => doc }, or an array path with a function key, e.g. { $filter: { anArray: (doc) => doc } }")}import Ve from"dot-wild";function Ne(t,e,r,n){return p(e).reduce((i,s)=>u(s)?Object.keys(s).reduce((a,f)=>a.map(l=>{let c=Ve.get(l,f),h=s[f];if(c!==void 0){let T=Array.isArray(h)?c.concat(h):c.concat([h]);return Ve.set(l,f,T)}return l}),i):i,t)}import Pe from"dot-wild";function Ke(t,e,r,n){return p(e).reduce((i,s)=>(u(s)&&Object.keys(s).forEach(a=>{i=i.map(f=>{let l=Pe.get(f,a);if(l!==void 0){let c=s[a],h=Array.isArray(c)?c.concat(l):[c].concat(l);return Pe.set(f,a,h)}return f})}),i),t)}var D={$gt:oe,$gte:se,$lt:ae,$lte:fe,$and:le,$or:ce,$xor:ue,$includes:he,$oneOf:me,$fn:pe,$re:de,$length:ge,$not:be,$has:Te,$hasAny:ye},Qe={$merge:Ce,$map:Se,$filter:_e,$push:Ne,$unshift:Ke,$set:je,$unset:G,$change:xe,$inc:$e,$dec:Ee,$mult:Ae,$div:ve};function Re(t,e,r,n){return g(e).forEach(o=>{if(!Qe[o]){console.warn(`unknown operator: ${o}`);return}t=Qe[o](t,e[o],r,n)}),t}var E=(t,e)=>{if(typeof t!=typeof e)return!1;let r=(n,o)=>{if(n[o]===e[o])return!0;let i=[];return o.startsWith("$")&&i.push(o),o!=="$not"&&u(e[o])&&!j(e[o])&&(i=i.concat(g(e[o]).filter(s=>s.startsWith("$")))),i.length?i.every(s=>s==="$not"?!D[s](n,e):D[s](n,e)):o.includes(".")?Me.get(n,o)===e[o]:$(n,o)&&E(n[o],e[o])};return Array.isArray(t)&&Array.isArray(e)?t.some(n=>u(n)||Array.isArray(n))||e.some(n=>u(n)||Array.isArray(n))?t.every((n,o)=>E(t[o],e[o])):[...t].map(n=>`${n}`).sort().join(",")===[...e].map(n=>`${n}`).sort().join(","):Array.isArray(t)&&u(e)?Object.keys(e).every(n=>r(t,n)):u(t)&&u(e)?g(e).every(n=>r(t,n)):t===e},x=(t,e,r,n=null)=>{if(t===void 0)return;t.internal&&delete t.internal,$(t,r.returnKey)&&(n=t);let o,i=Object.keys(e).some(f=>f.startsWith("$")),s=f=>{if(!(!f||j(f))){if(o=p(o),f=p(f),Array.isArray(o)&&Array.isArray(f)){let l=o.map(c=>c[r.returnKey]);if(f.some(c=>l.includes(c[r.returnKey])))return}o=o.concat(f)}},a=f=>{!f||($(f,r.returnKey)&&(n=f),E(f,e)?s(n):r.deep&&!i&&g(f).forEach(l=>{(u(f[l])||Array.isArray(f[l]))&&($(e,l)?s(x(f[l],e[l],r,n)):s(x(f[l],e,r,n)))}))};if(t=p(t),u(e)&&Array.isArray(t)&&!i&&t.forEach((f,l)=>{$(f,r.returnKey)&&(n=f),g(e).forEach(c=>{if(typeof c=="string"&&c.includes(".")){let h=Me.get(f,c);h!==void 0&&s(x(h,e[c],r,n))}else u(f)?E(t[l],e[c])&&s(n):E(t,e[c])&&s(n)})}),!j(e)&&Array.isArray(t))t.forEach(f=>a(f));else return t;return o};var ft=(t,e)=>{let r=new Map,n;return t=p(t),t.filter(o=>{if(o!==void 0)return n=r.get(o[e]),n!==void 0?!1:(r.set(o[e],!0),!0)})};function W(t,e,r,n,o){if(r={...R(),...r},e=p(e),e=e.filter(l=>Object.keys(l).length>0),!e.length){if(r.clonedData){let l=[];for(let c in t)c!=="internal"&&l.push(H.cloneDeep(t[c]));return l}return C([...A(t)],r)}let i=[...A(t)].slice(1),s=[];for(let l of e){let c=[];if(l[m]&&!u(l[m])&&!n.integerIds)c.push(t[l[m]]);else if(l[m]&&!u(l[m])&&n.integerIds){let h=t.internal.id_map[l[m]];h&&c.push(t[h])}else{let h=X(H.cloneDeep(l)),T=Object.fromEntries(Object.entries(at.flatten(h)).map(([d,O])=>[d.replace(/\\./g,"."),O]));Object.keys(T).some(d=>o.indices[d])?Object.keys(o.indices).forEach(d=>{let O=d.includes(".")?T[d]:l[d];if(O){let V=t.internal.index.valuesToId?.[d]?.[O];if(V){let U=V?.map(J=>t[J]);c.push(...x(U,l,r,n))}else c.push(...x(i,l,r,o))}}):(c=x(i,l,r,null),c===void 0&&(c=[]),c=p(c))}s.push(...c)}let a=ft(s,m);if(s=C(a,r),!r.clonedData)return s;let f=[];for(let l of s)f.push(H.cloneDeep(l));return f}var M=class{collection;inserted=[];removed=[];updated=[];operations=[];constructor(e){this.collection=e}insert(e){let r=this.collection.insert(e);return this.inserted.push(r),this.operations.push("insert"),r}update(e,r,n={}){let o=this.collection.find(e,{...n,project:void 0,join:void 0});return this.updated.push({documents:o,operations:r,options:n}),this.operations.push("update"),this.collection.update(e,r,n)}remove(e,r={}){let n=this.collection.find(e,{...r,project:void 0,join:void 0});return this.collection.remove(e,r),this.removed.push(n),this.operations.push("remove"),n}rollback(){let e=o=>{o.forEach(i=>{i[m]!==void 0?this.collection.remove({[m]:i[m]}):this.collection.remove({...i})})},r=o=>{o.documents.forEach(i=>{i[m]!==void 0?this.collection.assign(i[m],i):this.collection.update({...i},o.operations,o.options)})},n=o=>{o.forEach(i=>{i[m]!==void 0&&this.collection.assign(i[m],i)})};this.operations.reverse().forEach(o=>{switch(o){case"insert":e(this.inserted.pop());break;case"update":r(this.updated.pop());break;case"remove":n(this.removed.pop());break}}),this.inserted=[],this.updated=[],this.removed=[],this.operations=[]}commit(){this.inserted=[],this.updated=[],this.removed=[],this.collection._transaction=null}};import Fe from"dot-wild";function Z(t,e,r,n,o,i){n={...R(),...n},e=p(e);let s=[];for(let a of e){let f=[];f=x([...A(t)],a,n,null),f=p(f),s.push(...Re(f,r,a,i))}return n.returnKey===m&&o.timestamps&&s.forEach(a=>{let f;if(o.integerIds){let l=a[m];f=t.internal.id_map[l]}else f=a[m];Object.keys(i.indices).forEach(l=>{if(!Fe.get(a,l))return;let c=t.internal.index.idToValues[f][l],h=String(Fe.get(a,l));c!==h&&(t.internal.index.valuesToId[l][h]=t.internal.index.valuesToId[l][h]||[],t.internal.index.valuesToId[l][h].push(f),t.internal.index.valuesToId[l][c]=t.internal.index.valuesToId[l][c].filter(T=>T!==T),t.internal.index.valuesToId[l][c].length===0&&delete t.internal.index.valuesToId[l][c],t.internal.index.idToValues[f][l]=h)}),a[z]=Date.now(),i.merge(a[m],a)}),C(s,n)}var k=[];for(let t=0;t<256;t++)k[t]=(t+256).toString(16).substring(1);function lt(t,e){let r="000000"+t;return r.substring(r.length-e)}var ct=32;function Be(t){let e=t.len||16,r="",n=0,o=1679616,i=t.init+Math.ceil(o/2);function s(){return i=i<=o?i:0,i++,(i-1).toString(16)}return()=>{if(!r||n===256){for(r="",n=(1+e)/2|0;n--;)r+=k[256*Math.random()|0];r=r.substring(n=0,e)}let a=Date.now().toString(36),f=lt(s(),6),l=k[n++],c=parseInt(l,16)%ct;return`a${a}${f}${l}${r}${c}`}}function R(){return{deep:!0,returnKey:m,clonedData:!0,sort:void 0,skip:void 0,project:void 0}}function X(t){let e=new Set(g(D)),r=n=>Object.entries(n).reduce((o,[i,s])=>{if(u(s)){let a=r(s);j(a)||(o[i]=a)}else e.has(i)||(o[i]=s);return o},{});return L(r(t))}var m="_id",ut="_created_at",z="_updated_at",ee=t=>t!==void 0&&(typeof t=="string"||typeof t=="number"||typeof t=="boolean"),te=class{options;data={};_transaction=null;indices={};createId;constructor(e={}){if(e.autosync=e.autosync??!0,e.timestamps=e.timestamps??!0,e.integerIds=e.integerIds??!1,!e.adapter)throw new Error("No adapter provided.");this.options=e;let r=()=>({current:0,next_id:0,id_map:{},index:{valuesToId:{},idToValues:{}}});this.adapterRead(),this.data.internal||(this.data.internal=r()),this.createId=Be({init:this.data.internal.current,len:4})}adapterRead(){this.data=this.options.adapter.read()}assign(e,r){if(e!==void 0){if(this.options.integerIds){let n=e,o=this.data.internal.id_map[n];return o?(this.data[o]=r,this.data[o]):this.insert({...r,[m]:n})[0]}if(typeof e=="string"||typeof e=="number")return this.data[e]=r,this.data[e]}}filter(e){let r=Object.assign({},this.data);return delete r.internal,Object.values(r).filter(n=>{try{return e(n)}catch{return!1}})}find(e,r={}){return W(this.data,e,r,this.options,this)}update(e,r,n={}){return Z(this.data,e,r,n,this.options,this)}upsert(e,r,n={}){let o=this.update(e,r,n);if(o.length)return o;e=X(e);let i=this.insert(e);return Z(i,e,r,n,this.options,this)}remove(e,r={}){let n=this.find(e,{...r,clonedData:!1}),o=n.map(i=>Object.assign({},i));return n.forEach(i=>{let s;if(this.options.integerIds){let a=i[m];s=this.data.internal.id_map[a],delete this.data.internal.id_map[a]}else s=i[m];Object.keys(this.indices).forEach(a=>{let f=q.get(i,a);ee(f)&&(this.data.internal.index.valuesToId[a][f]=this.data.internal.index.valuesToId[a][f].filter(l=>l!==s),this.data.internal.index.valuesToId[a][f].length===0&&delete this.data.internal.index.valuesToId[a][f],delete this.data.internal.index.idToValues[s]),f===void 0&&Object.keys(this.data.internal.index.valuesToId[a]).forEach(l=>{this.data.internal.index.valuesToId[a][l]=this.data.internal.index.valuesToId[a][l].filter(c=>c!==s),this.data.internal.index.valuesToId[a][l].length===0&&delete this.data.internal.index.valuesToId[a][l]})}),delete this.data[s]}),this.sync(),o}insert(e){return Array.isArray(e)||(e=[e]),e.length?(e=e.map(r=>{let n=this.getId();if(this.data.internal.current++,this.options.timestamps&&(r[ut]=Date.now(),r[z]=Date.now()),r[m]===void 0&&(r[m]=n,this.options.integerIds)){let o=this.nextIntegerId();this.data.internal.id_map[o]=n,r[m]=o}return this.data[n]=r,Object.keys(this.indices).forEach(o=>{let i=String(q.get(r,o));if(ee(i)){if(this.indices[o].unique&&this.data.internal.index.valuesToId?.[o]?.[i]!==void 0)throw new Error(`Unique index violation for key "${o}" and value "${i}"`);this.data.internal.index.valuesToId[o]=this.data.internal.index.valuesToId[o]||{},this.data.internal.index.valuesToId[o][i]=this.data.internal.index.valuesToId[o][i]||[],this.data.internal.index.valuesToId[o][i].push(n),this.data.internal.index.idToValues[n]=this.data.internal.index.idToValues[n]||{},this.data.internal.index.idToValues[n][o]=i}}),r}),this.options.autosync&&this.sync(),e):[]}merge(e,r){if(!!e){if(this.options.integerIds){let n=this.data.internal.id_map[e];if(!n||this.data[n]===void 0)return;Object.assign(this.data[n],j(r)?{}:r),this.sync();return}this.data[e]!==void 0&&(Object.assign(this.data[e],j(r)?{}:r),this.sync())}}sync(){return this.options.adapter.write(this.data)}drop(){this.data={internal:{current:0,next_id:0,id_map:{},index:{valuesToId:{},idToValues:{}}}}}getId(){return this.createId()}createIndex(e={}){if(!e.key)throw new Error("createIndex requires a key");e={key:e.key,unique:e.unique??!1};let{key:r,unique:n}=e;if(r.split(".").some(o=>!isNaN(Number(o))))throw new Error(`Cannot use a numeric property as an index key: ${r}`);if(this.indices[r]={unique:n},!this.data.internal.index.valuesToId[r])return Object.keys(this.data).forEach(o=>{if(o==="internal")return;let i=String(q.get(this.data[o],r));if(ee(i)){if(n&&this.data.internal.index.valuesToId?.[r]?.[i]!==void 0)throw new Error(`Unique index violation for key "${r}" and value "${i}"`);this.data.internal.index.valuesToId[r]=this.data.internal.index.valuesToId[r]||{},this.data.internal.index.valuesToId[r][i]=this.data.internal.index.valuesToId[r][i]||[],this.data.internal.index.valuesToId[r][i].push(o),this.data.internal.index.idToValues[o]=this.data.internal.index.idToValues[o]||{},this.data.internal.index.idToValues[o][r]=i}else throw new Error(`Invalid index value for property ${r}: ${i}`)}),this.sync(),this}removeIndex(e){return this.indices[e]?(delete this.indices[e],this.data.internal.index.valuesToId[e]&&delete this.data.internal.index.valuesToId[e],Object.keys(this.data.internal.index.idToValues).forEach(r=>{this.data.internal.index.idToValues[r][e]!==void 0&&delete this.data.internal.index.idToValues[r][e],j(this.data.internal.index.idToValues[r])&&delete this.data.internal.index.idToValues[r]}),this.sync(),!0):!1}nextIntegerId(){return this.data.internal.next_id++}transaction(e){this._transaction=new M(this);try{e(this._transaction)}catch(r){throw this._transaction.rollback(),r}this._transaction.commit()}};import I from"fs";import Ye from"path";var _=class{elements=[];push(...e){this.elements.push(...e)}shift(){return this.elements.shift()}length(){return this.elements.length}},F=class{storagePath;name;filePath;queue;constructor({storagePath:e,name:r}){r.endsWith(".json")||(r+=".json"),this.storagePath=e,this.name=r,this.queue=new _,this.filePath=Ye.join(this.storagePath,this.name),this.prepareStorage()}prepareStorage(){I.existsSync(this.storagePath)||I.mkdirSync(this.storagePath),I.existsSync(this.filePath)||I.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{return Object.assign({},JSON.parse(I.readFileSync(this.filePath,"utf8"))||{})}catch{return{}}}write(e){for(this.queue.push([r=>{pt(r,this.filePath)},e]);this.queue.length();){let r=this.queue.shift();r[0](r[1])}}};function pt(t,...e){let n=(process.env.NODE_ENV||"development")==="development"?2:0,o=JSON.stringify(t,null,n);return dt(o,...e)}function dt(t,...e){let r=Ye.join(...e);return I.writeFileSync(r,t)}import w from"fs";import Ue from"path";import re from"crypto";var B=class{storagePath;name;filePath;queue;key;constructor({storagePath:e,name:r,key:n="Mahpsee2X7TKLe1xwJYmar91pCSaZIY7"}){r.endsWith(".json")||(r+=".json"),this.storagePath=e,this.name=r,this.queue=new _,this.filePath=Ue.join(this.storagePath,this.name),this.key=n,this.prepareStorage()}prepareStorage(){w.existsSync(this.storagePath)||w.mkdirSync(this.storagePath),w.existsSync(this.filePath)||w.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{let e=w.readFileSync(this.filePath,"utf8"),r=bt(e,this.key);return Object.assign({},JSON.parse(r)||{})}catch{return{}}}write(e){for(this.queue.push([r=>{ht(r,this.key,this.filePath)},e]);this.queue.length();){let r=this.queue.shift();r[0](r[1])}}},ht=(t,e,...r)=>{let n=JSON.stringify(t,null,0);return mt(gt(n,e),...r)},mt=(t,...e)=>w.writeFileSync(Ue.join(...e),t),gt=(t,e)=>{let r=Buffer.from(re.randomBytes(16)).toString("hex").slice(0,16),n=re.createCipheriv("aes-256-cbc",Buffer.from(e),r),o=Buffer.concat([n.update(t),n.final()]);return`${r}:${o.toString("hex")}`},bt=(t,e)=>{let r=t.includes(":")?t.split(":"):[],n=Buffer.from(r.shift()||"","binary"),o=Buffer.from(r.join(":"),"hex"),i=re.createDecipheriv("aes-256-cbc",Buffer.from(e),n);return Buffer.concat([i.update(o),i.final()]).toString()};var Y=class{storageKey;constructor({storagePath:e}){this.storageKey=`arc_${e}`}read(){try{return Object.assign({},JSON.parse(localStorage.getItem(`arc_${this.storageKey}`)||"{}"))}catch(e){return console.error(`arc: failed to read from key: ${this.storageKey}: ${e}`),{}}}write(e){localStorage.setItem(this.storageKey,JSON.stringify(e))}};export{te as Collection,B as EncryptedFSAdapter,F as FSAdapter,Y as LocalStorageAdapter};
