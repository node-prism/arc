import _t from"cuid";import ut from"lodash";import Ot from"cuid";import*as g from"dot-wild";import D from"lodash";function p(e){return Array.isArray(e)?e:e==null?[]:[e]}function c(e){return!!e&&Object.prototype.toString.call(e)==="[object Object]"}function O(e){return c(e)&&l(e).length===0}var T=Object.values,l=Object.keys,h=(e,t)=>e?Object.prototype.hasOwnProperty.call(e,t):!1;function R(e){return c(e)&&l(e).forEach(t=>{!e[t]||!c(e[t])||(R(e[t]),l(e[t]).length===0&&delete e[t])}),e}var yt=e=>e.map(t=>r=>r[t]),gt=e=>e.map(t=>t===1?"asc":"desc");function jt(e,t){let r={$floor:(n,i)=>{let o=g.get(n,i);return typeof o=="number"?Math.floor(o):0},$ceil:(n,i)=>{let o=g.get(n,i);return typeof o=="number"?Math.ceil(o):0},$sub:(n,i)=>{let o;for(let s of i)typeof s=="number"?o===void 0?o=s:o-=s:o===void 0?o=Number(g.get(n,s)??0):o-=Number(g.get(n,s)??0);return o},$add:(n,i)=>{let o;for(let s of i)typeof s=="number"?o===void 0?o=s:o+=s:o===void 0?o=Number(g.get(n,s)??0):o+=Number(g.get(n,s)??0);return o},$mult:(n,i)=>{let o=1;for(let s of i)typeof s=="number"?o*=s:o*=Number(g.get(n,s)??1);return o},$div:(n,i)=>{let o;for(let s of i)typeof s=="number"?o===void 0?o=s:o/=s:o===void 0?o=Number(g.get(n,s)??1):o/=Number(g.get(n,s)??1);return o},$fn:(n,i)=>i(n)};return l(t.aggregate).forEach(n=>{typeof t.aggregate[n]=="object"&&l(t.aggregate[n]).forEach(i=>{i[0]==="$"&&(!r[i]||(e=e.map(o=>(o[n]=r[i](o,t.aggregate[n][i]),o))))})}),e}function $(e,t){if(t.aggregate&&(e=jt(e,t)),t.project){let i=Object.keys(t.project).reduce((s,a)=>{if(typeof t.project[a]=="number"&&typeof s=="number")return s+t.project[a]},0),o=i===Object.keys(t.project).length?1:i===0?2:0;if(t.project[u]===void 0&&(t.project[u]=1),o===1)e=e.map(s=>D.pick(s,l(t.project)));else if(o===2)e=e.map(s=>D.omit(s,l(t.project)));else if(o===0){let s=Object.keys(t.project).filter(a=>t.project[a]===0);e=e.map(a=>D.omit(a,s))}}t.sort&&(e=D.orderBy(e,yt(l(t.sort)),gt(T(t.sort)))),t.skip&&typeof t.skip=="number"&&(e=e.slice(t.skip)),t.take&&typeof t.take=="number"&&(e=e.slice(0,t.take)),t.join&&Array.isArray(t.join)&&t.join.forEach(i=>{if(!i.collection)throw new Error("Missing required field in join: collection");if(!i.from)throw new Error("Missing required field in join: from");if(!i.on)throw new Error("Missing required field in join: on");if(!i.as)throw new Error("Missing required field in join: as");let o=i?.options||{},s=i.collection,a=Ot();e=e.map(f=>{f[i.as]=p(f[i.as]),f[a]=[];let d=i.from.includes(".")?g.get(f,i.from):f[i.from];if(d===void 0)return f;if(Array.isArray(d))return d.forEach(Q=>{let m={[`${i.on}`]:Q};f[a]=f[a].concat(s.find(m,o))}),f[i.as]=f[a],delete f[a],f;let j={[`${i.on}`]:d};return f[a]=s.find(j,o),f[i.as]=f[a],delete f[a],f})});function r(i,o){for(let s in o)(i[s]===null||i[s]===void 0)&&(typeof o[s]=="function"?i[s]=o[s](i):i[s]=o[s]);return i}function n(i,o){for(let s in o)Array.isArray(i[s])&&i[s].length===0&&(typeof o[s]=="function"?i[s]=o[s](i):i[s]=o[s]),typeof i[s]=="string"&&i[s].trim().length===0&&(typeof o[s]=="function"?i[s]=o[s](i):i[s]=o[s]),typeof i[s]=="object"&&Object.keys(i[s]).length===0&&(typeof o[s]=="function"?i[s]=o[s](i):i[s]=o[s]);return i}return t.ifNull&&(e=e.map(i=>r(i,t.ifNull))),t.ifEmpty&&(e=e.map(i=>n(i,t.ifEmpty))),t.ifNullOrEmpty&&(e=e.map(i=>r(i,t.ifNullOrEmpty)).map(i=>n(i,t.ifNullOrEmpty))),e}function F(e,t){let r=!1;return c(t)&&l(t).forEach(n=>{let i=t[n].$gt;i=p(i),h(e,n)&&i.forEach(o=>{e[n]>o&&(r=!0)})}),r}function U(e,t){let r=!1;return c(t)&&l(t).forEach(n=>{let i=t[n].$gte;i=p(i),h(e,n)&&i.forEach(o=>{e[n]>=o&&(r=!0)})}),r}function J(e,t){let r=!1;return c(t)&&l(t).forEach(n=>{let i=t[n].$lt;i=p(i),h(e,n)&&i.forEach(o=>{e[n]<o&&(r=!0)})}),r}function V(e,t){let r=!1;return c(t)&&l(t).forEach(n=>{let i=t[n].$lte;i=p(i),h(e,n)&&i.forEach(o=>{e[n]<=o&&(r=!0)})}),r}function W(e,t){let r=[];return c(t)&&l(t).forEach(n=>{if(n!=="$and")return;let i=t[n];i=p(i),i.forEach(o=>{l(o).forEach(s=>{typeof o[s]=="function"&&e[s]!==void 0?r.push(o[s](e[s])):r.push(b(e,o))})})}),!(!r.length||r.length&&r.includes(!1))}function B(e,t){let r=[];return c(t)&&l(t).forEach(n=>{if(n!=="$or")return;let i=t[n];i=p(i),i.forEach(o=>{l(o).forEach(s=>{typeof o[s]=="function"&&e[s]!==void 0?r.push(o[s](e[s])):r.push(b(e,o))})})}),r.length?!!(r.length&&r.includes(!0)):!1}function G(e,t){let r=[];return c(t)&&l(t).forEach(n=>{if(n!=="$xor")return;let i=t[n];if(i=p(i),i.length!==2)throw new Error(`invalid $xor query. expected exactly two values, found ${i.length}.`);i.forEach(o=>{l(o).forEach(s=>{typeof o[s]=="function"&&e[s]!==void 0?r.push(o[s](e[s])):r.push(b(e,o))})})}),r.length===2?r.filter(n=>n).length===1:!1}function L(e,t){let r;return c(t)&&l(t).forEach(n=>{if(c(t[n])){if(e[n]===void 0)return;l(t[n]).forEach(i=>{i==="$fn"&&(r=!0,p(t[n][i]).forEach(o=>{o(e[n])||(r=!1)}))})}}),r!==void 0?r:!1}function X(e,t){let r;return c(t)&&l(t).forEach(n=>{if(c(t[n])){if(e[n]===void 0)return;l(t[n]).forEach(i=>{i==="$re"&&(r=!0,p(t[n][i]).forEach(o=>{o.test(e[n])||(r=!1)}))})}}),r!==void 0?r:!1}function Z(e,t){let r=[];return c(t)&&l(t).forEach(n=>{let i=t[n].$includes;i=p(i),h(e,n)&&i.forEach(o=>{r.push(e[n].includes(o))})}),!(!r.length||r.length&&r.includes(!1))}function k(e,t){let r=[];return c(t)&&l(t).forEach(n=>{let i=t[n].$oneOf;i=p(i),h(e,n)&&r.push(i.includes(e[n]))}),!(!r.length||r.length&&r.includes(!1))}function z(e,t){let r=!1;return c(t)&&l(t).forEach(n=>{let i=t[n].$length;h(e,n)&&(Array.isArray(e[n])||typeof e[n]=="string")&&e[n].length===i&&(r=!0)}),r}function q(e,t){let r=[];return c(t)&&l(t).forEach(n=>{if(n!=="$not")return;if(!c(t[n]))throw new Error(`$not operator requires an object as its value, received: ${t[n]}`);let i=p(t[n]);r.push(i.every(o=>{if(c(o)){let s=y(e,o,{deep:!0,returnKey:u,clonedData:!0},e);return!(s&&s.length)}return h(e,o)}))}),r.every(n=>!n)??!1}function tt(e,t){let r=!1;return c(t)&&l(t).forEach(n=>{if(n!=="$has")return;let i=t[n];i=p(i),r=i.every(o=>h(e,o))}),r}function et(e,t){let r=!1;return c(t)&&l(t).forEach(n=>{if(n!=="$hasAny")return;let i=t[n];i=p(i),r=i.some(o=>h(e,o))}),r}var E=(e,t,r,n=!1)=>{if(e===void 0)return;let i=o=>{if(!c(o))return o;let s={...o};return b(s,t)&&l(r).forEach(a=>{n?s={...s,[a]:r[a]}:h(s,a)&&(s={...s,[a]:r[a]})}),l(s).forEach(a=>{(c(s[a])||Array.isArray(s[a]))&&(s={...s,[a]:E(s[a],t,r,n)})}),s};return(Array.isArray(e)||c(e))&&!O(t)&&!O(r)?Array.isArray(e)?e.map(o=>i(o)):i(e):e};function rt(e,t,r,n){return p(t).forEach(o=>{if(!c(o)&&!Array.isArray(o)){let s={};l(r).forEach(a=>{s[a]=o}),e=E(e,r,s,!0);return}e=E(e,r,o,!0)}),e}import Tt from"lodash";function N(e,t,r,n){return p(t).forEach(o=>{if(Array.isArray(o))return N(e,o,r,n);e=e.map(s=>Tt.set(s,o,void 0))}),e}function nt(e,t,r,n){return p(t).forEach(o=>{if(!c(o)&&!Array.isArray(o)){let s={};l(r).forEach(a=>{s[a]=o}),e=E(e,r,s,!1)}else e=E(e,r,o,!1)}),e}function I(e,t,r,n,i){let o=p(t),s=y(e,r,{deep:!0,returnKey:u,clonedData:!1});return o.forEach(a=>{if(c(a)&&l(a).forEach(f=>{s.forEach(d=>{let j=y([d],r,{returnKey:f,deep:!0,clonedData:!1});(j?.length?j:s).forEach(m=>{if(h(m,f))n===0?m[f]+=a[f]:n===1?m[f]-=a[f]:n===2?m[f]*=a[f]:n===3&&(m[f]/=a[f]);else{let bt=l(r)[0],Y=y([m],r,{returnKey:bt,deep:!0,clonedData:!1});Y&&Y.forEach(w=>{n===0?w[f]=a[f]:n===1?w[f]=-a[f]:n===2?w[f]=a[f]:n===3&&(w[f]=1/a[f])})}})})}),!c(a)){if(!s||!s.length)return;l(r).forEach(f=>{s.forEach(d=>{let j=y([d],r,{returnKey:f,deep:!0,clonedData:!1});(j?.length?j:s).forEach(m=>{h(m,f)?n===0?m[f]+=a:n===1?m[f]-=a:n===2?m[f]*=a:n===3&&(m[f]/=a):n===0?m[f]=a:n===1?m[f]=-a:n===2?m[f]=a:n===3&&(m[f]=1/a)})})})}}),e}function it(e,t,r,n){return I(e,t,r,0,n)}function ot(e,t,r,n){return I(e,t,r,1,n)}function st(e,t,r,n){return I(e,t,r,2,n)}function ft(e,t,r,n){return I(e,t,r,3,n)}import Et from"lodash";function x(e,t,r,n=!1){if(e===void 0)return;let i=o=>{if(!c(o))return o;let s={...o};return b(s,t)&&(n?s=Et.merge(s,r):s={...s,...r}),l(s).forEach(a=>{(c(s[a])||Array.isArray(s[a]))&&(s={...s,[a]:x(s[a],t,r)})}),s};return(Array.isArray(e)||c(e))&&!O(t)&&!O(r)?Array.isArray(e)?e.map(o=>i(o)):i(e):e}function at(e,t,r,n){return p(t).forEach(o=>{e=x(e,r,o)}),e}function ct(e,t,r,n){return p(t).forEach(o=>{e=x(e,r,o,!0)}),e}var _={$gt:F,$gte:U,$lt:J,$lte:V,$and:W,$or:B,$xor:G,$includes:Z,$oneOf:k,$fn:L,$re:X,$length:z,$not:q,$has:tt,$hasAny:et},lt={$append:at,$merge:ct,$set:rt,$unset:N,$change:nt,$inc:it,$dec:ot,$mult:st,$div:ft};function pt(e,t,r,n){return l(t).forEach(i=>{if(!lt[i]){console.warn(`unknown operator: ${i}`);return}e=lt[i](e,t[i],r,n)}),e}function b(e,t){return typeof e!=typeof t?!1:Array.isArray(e)&&Array.isArray(t)?e.some(r=>c(r)||Array.isArray(r))||t.some(r=>c(r)||Array.isArray(r))?e.every((r,n)=>b(e[n],t[n])):[...e].map(r=>`${r}`).sort().join(",")===[...t].map(r=>`${r}`).sort().join(","):c(e)&&c(t)?l(t).every(r=>{if(e[r]===t[r])return!0;let n=[];return r.startsWith("$")&&n.push(r),r!=="$not"&&c(t[r])&&!O(t[r])&&(n=n.concat(l(t[r]).filter(i=>i.startsWith("$")))),n.length?n.every(i=>i==="$not"?!_[i](e,t):_[i](e,t)):h(e,r)&&b(e[r],t[r])}):e===t}function y(e,t,r,n=null){if(e===void 0)return;e.__private&&delete e.__private,h(e,r.returnKey)&&(n=e);let i;function o(f){!f||O(f)||(i=p(i),!(Array.isArray(i)&&i.some(d=>d[r.returnKey]===f[r.returnKey]))&&(i=i.concat(f)))}function s(f){!f||(h(f,r.returnKey)&&(n=f),b(f,t)&&o(n),r.deep&&l(f).forEach(d=>{(c(f[d])||Array.isArray(f[d]))&&o(y(f[d],t,r,n))}))}e=p(e);let a=Object.keys(t).some(f=>f.startsWith("$"));if(c(t)&&Array.isArray(e)&&!a&&e.forEach((f,d)=>{h(f,r.returnKey)&&(n=f),l(t).forEach(j=>{c(f)?b(e[d],t[j])&&o(n):b(e,t[j])&&o(n)})}),!O(t)&&Array.isArray(e))e.forEach(f=>s(f));else return e;return i}var At=(e,t)=>{let r=new Map,n;return e=p(e),e.filter(i=>{if(i!==void 0)return n=r.get(i[t]),n?i[t]!=n?(r.delete(i[t]),r.set(i[t],i[t]),!0):!1:(r.set(i[t],i[t]),!0)})};function S(e,t,r,n){if(r={...C(),...r},t=p(t),t=t.filter(a=>Object.keys(a).length>0),!t.length){if(r.clonedData){let a=[];for(let f in e)f!=="__private"&&a.push(ut.cloneDeep(e[f]));return a}return $([...T(e)],r)}let i=[];for(let a of t){let f=[];if(a[u]&&!c(a[u])&&!n.integerIds)f.push(e[a[u]]);else if(a[u]&&!c(a[u])&&n.integerIds){let d=e.__private.id_map[a[u]];d&&f.push(e[d])}else f=y([...T(e)],a,r,null),f===void 0&&(f=[]),f=p(f);i.push(...f)}let o=At(i,u);if(i=$(o,r),!r.clonedData)return i;let s=[];for(let a of i)s.push(ut.cloneDeep(a));return s}import A from"fs";import ht from"path";var M=class{elements=[];push(...t){this.elements.push(...t)}shift(){return this.elements.shift()}length(){return this.elements.length}},v=class{storagePath;name;filePath;queue;constructor(t,r){r.endsWith(".json")||(r+=".json"),this.storagePath=t,this.name=r,this.queue=new M,this.filePath=ht.join(this.storagePath,this.name),this.prepareStorage()}prepareStorage(){A.existsSync(this.storagePath)||A.mkdirSync(this.storagePath),A.existsSync(this.filePath)||A.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{return Object.assign({},JSON.parse(A.readFileSync(this.filePath,"utf8"))||{})}catch{return{}}}write(t){for(this.queue.push([r=>{$t(r,this.filePath)},t]);this.queue.length();){let r=this.queue.shift();r[0](r[1])}}};function $t(e,...t){let n=(process.env.NODE_ENV||"development")==="development"?2:0,i=JSON.stringify(e,null,n);return xt(i,...t)}function xt(e,...t){let r=ht.join(...t);return A.writeFileSync(r,e)}var P=class{collection;inserted=[];removed=[];updated=[];operations=[];constructor(t){this.collection=t}insert(t){let r=this.collection.insert(t);return this.inserted.push(r),this.operations.push("insert"),r}update(t,r,n={}){let i=this.collection.find(t,{...n,project:void 0,join:void 0});return this.updated.push({documents:i,operations:r,options:n}),this.operations.push("update"),this.collection.update(t,r,n)}remove(t,r={}){let n=this.collection.find(t,{...r,project:void 0,join:void 0});return this.collection.remove(t,r),this.removed.push(n),this.operations.push("remove"),n}rollback(){let t=i=>{i.forEach(o=>{o[u]!==void 0?this.collection.remove({[u]:o[u]}):this.collection.remove({...o})})},r=i=>{i.documents.forEach(o=>{o[u]!==void 0?this.collection.assign(o[u],o):this.collection.update({...o},i.operations,i.options)})},n=i=>{i.forEach(o=>{o[u]!==void 0&&this.collection.assign(o[u],o)})};this.operations.reverse().forEach(i=>{switch(i){case"insert":t(this.inserted.pop());break;case"update":r(this.updated.pop());break;case"remove":n(this.removed.pop());break}}),this.inserted=[],this.updated=[],this.removed=[],this.operations=[]}commit(){this.inserted=[],this.updated=[],this.removed=[],this.collection._transaction=null}};function K(e,t,r,n,i,o){n={...C(),...n},t=p(t);let s=[];for(let a of t){let f=[];f=y([...T(e)],a,n,null),f=p(f),s.push(...pt(f,r,a,o))}return n.returnKey===u&&i.timestamps&&s.forEach(a=>{a[H]=Date.now(),o.merge(a[u],a)}),$(s,n)}function C(){return{deep:!0,returnKey:u,clonedData:!0,sort:void 0,skip:void 0,project:void 0}}function mt(e){let t=new Set(l(_));return c(e)?(Object.keys(e).forEach(r=>{if(c(r)&&l(e[r]).every(n=>t.has(n))){delete e[r];return}if(!c(r)&&t.has(r)){delete e[r];return}if(!!c(e[r])){if(l(e[r]).every(n=>t.has(n))){delete e[r];return}l(e[r]).forEach(n=>{t.has(n)?delete e[r][n]:mt(e[r][n])})}}),R(e)):e}var u="_id",vt="_created_at",H="_updated_at",dt=class{storagePath;name;options;data={};_transaction=null;constructor(t=".data",r="db",n={}){this.storagePath=t,this.name=r,n.autosync=n.autosync??!0,n.timestamps=n.timestamps??!0,n.integerIds=n.integerIds??!1,n.adapter=n.adapter??new v(this.storagePath,this.name),this.options=n,this.data=Object.assign(this.data,{__private:{next_id:0,id_map:{}}}),this.initializeData()}initializeData(){this.data=this.options.adapter.read()}assign(t,r){if(t!==void 0){if(this.options.integerIds){let n=t,i=this.data.__private.id_map[n];return i?(this.data[i]=r,this.data[i]):this.insert({...r,[u]:n})[0]}if(typeof t=="string"||typeof t=="number")return this.data[t]=r,this.data[t]}}filter(t){let r=Object.assign({},this.data);return delete r.__private,Object.values(r).filter(n=>{try{return t(n)}catch{return!1}})}find(t,r={}){return S(this.data,t,r,this.options)}update(t,r,n={}){return K(this.data,t,r,n,this.options,this)}upsert(t,r,n={}){let i=this.update(t,r,n);if(i.length)return i;t=mt(t);let o=this.insert(t);return K(o,t,r,n,this.options,this)}remove(t,r={}){let n=this.find(t,{...r,clonedData:!1}),i=n.map(o=>Object.assign({},o));return n.forEach(o=>{if(this.options.integerIds){let s=o[u],a=this.data.__private.id_map[s];delete this.data.__private.id_map[s],delete this.data[a];return}delete this.data[o[u]]}),this.sync(),i}insert(t){return Array.isArray(t)||(t=[t]),t.length?(t=t.map(r=>{let n=this.getId();if(this.options.timestamps&&(r[vt]=Date.now(),r[H]=Date.now()),r[u]===void 0&&(r[u]=n,this.options.integerIds)){let i=this.nextIntegerId();this.data.__private.id_map[i]=n,r[u]=i}return this.data[n]=r,r}),this.options.autosync&&this.sync(),t):[]}merge(t,r){if(!!t){if(this.options.integerIds){let n=this.data.__private.id_map[t];if(!n||this.data[n]===void 0)return;Object.assign(this.data[n],O(r)?{}:r),this.sync();return}this.data[t]!==void 0&&(Object.assign(this.data[t],O(r)?{}:r),this.sync())}}sync(){return this.options.adapter.write(this.data)}drop(){this.data={__private:{next_id:0,id_map:{}}}}getId(){return _t()}nextIntegerId(){return this.data.__private.next_id++}transaction(t){this._transaction=new P(this);try{t(this._transaction)}catch(r){throw this._transaction.rollback(),r}this._transaction.commit()}};export{vt as CREATED_AT_KEY,dt as Collection,u as ID_KEY,H as UPDATED_AT_KEY,C as defaultQueryOptions};
