import k from"dot-wild";import U from"lodash";import it from"dot-wild";import b from"dot-wild";import P from"lodash";function p(r){return Array.isArray(r)?r:r==null?[]:[r]}function l(r){return!!r&&Object.prototype.toString.call(r)==="[object Object]"}function T(r){return l(r)&&u(r).length===0}var E=Object.values,u=Object.keys,O=(r,e)=>r?Object.prototype.hasOwnProperty.call(r,e):!1;function te(r){return typeof r=="function"}function B(r){return l(r)&&u(r).forEach(e=>{!r[e]||!l(r[e])||(B(r[e]),u(r[e]).length===0&&delete r[e])}),r}var He=r=>r.map(e=>t=>t[e]),Je=r=>r.map(e=>e===1?"asc":"desc");function Ue(r,e){let t={$floor:(i,n)=>{let o=b.get(i,n);return typeof o=="number"?Math.floor(o):0},$ceil:(i,n)=>{let o=b.get(i,n);return typeof o=="number"?Math.ceil(o):0},$sub:(i,n)=>{let o;for(let s of n)typeof s=="number"?o===void 0?o=s:o-=s:o===void 0?o=Number(b.get(i,s)??0):o-=Number(b.get(i,s)??0);return o},$add:(i,n)=>{let o;for(let s of n)typeof s=="number"?o===void 0?o=s:o+=s:o===void 0?o=Number(b.get(i,s)??0):o+=Number(b.get(i,s)??0);return o},$mult:(i,n)=>{let o=1;for(let s of n)typeof s=="number"?o*=s:o*=Number(b.get(i,s)??1);return o},$div:(i,n)=>{let o;for(let s of n)typeof s=="number"?o===void 0?o=s:o/=s:o===void 0?o=Number(b.get(i,s)??1):o/=Number(b.get(i,s)??1);return o},$fn:(i,n)=>n(i)};return u(e.aggregate).forEach(i=>{typeof e.aggregate[i]=="object"&&u(e.aggregate[i]).forEach(n=>{n[0]==="$"&&(!t[n]||(r=r.map(o=>(o[i]=t[n](o,e.aggregate[i][n]),o))))})}),r}function I(r,e){if(e.aggregate&&(r=Ue(r,e)),e.project){let n=Object.keys(e.project).reduce((s,a)=>{if(typeof e.project[a]=="number"&&typeof s=="number")return s+e.project[a]},0),o=n===Object.keys(e.project).length?1:n===0?2:0;if(o===1)r=r.map(s=>P.pick(s,u(e.project)));else if(o===2)r=r.map(s=>P.omit(s,u(e.project)));else if(o===0){let s=Object.keys(e.project).filter(a=>e.project[a]===0);r=r.map(a=>P.omit(a,s))}}e.sort&&(r=P.orderBy(r,He(u(e.sort)),Je(E(e.sort)))),e.skip&&typeof e.skip=="number"&&(r=r.slice(e.skip)),e.take&&typeof e.take=="number"&&(r=r.slice(0,e.take)),e.join&&Array.isArray(e.join)&&e.join.forEach(n=>{if(!n.collection)throw new Error("Missing required field in join: collection");if(!n.from)throw new Error("Missing required field in join: from");if(!n.on)throw new Error("Missing required field in join: on");if(!n.as)throw new Error("Missing required field in join: as");let o=n?.options||{},s=n.collection,a=n.collection.createId(),f=!1;r=r.map(c=>{if(n.as.includes(".")){if(!n.as.includes("*"))throw new Error("as field must include * when using dot notation, e.g. items.*.meta");f=!0}f||(c[n.as]=p(c[n.as])),c[a]=[];let d=n.from.includes(".")?b.get(c,n.from):c[n.from];if(d===void 0)return c;if(Array.isArray(d))return d.forEach((m,_)=>{let j={[`${n.on}`]:m};f?c=b.set(c,n.as.replaceAll("*",_.toString()),s.find(j,o)[0]):c[a]=c[a].concat(s.find(j,o))}),f||(c[n.as]=c[a]),delete c[a],c;let y={[`${n.on}`]:d};return f||(c[a]=s.find(y,o),c[n.as]=c[a]),delete c[a],c})});function t(n,o){for(let s in o){let a=b.get(n,s);a==null&&(typeof o[s]=="function"?n=b.set(n,s,o[s](n)):n=b.set(n,s,o[s]))}return n}function i(n,o){for(let s in o){let a=b.get(n,s);Array.isArray(a)&&a.length===0&&(typeof o[s]=="function"?n=b.set(n,s,o[s](n)):n=b.set(n,s,o[s])),typeof a=="string"&&a.trim().length===0&&(typeof o[s]=="function"?n=b.set(n,s,o[s](n)):n=b.set(n,s,o[s])),typeof a=="object"&&Object.keys(a).length===0&&(typeof o[s]=="function"?n=b.set(n,s,o[s](n)):n=b.set(n,s,o[s]))}return n}return e.ifNull&&(r=r.map(n=>t(n,e.ifNull))),e.ifEmpty&&(r=r.map(n=>i(n,e.ifEmpty))),e.ifNullOrEmpty&&(r=r.map(n=>t(n,e.ifNullOrEmpty)).map(n=>i(n,e.ifNullOrEmpty))),r}import Ke from"dot-wild";import We from"dot-wild";function re(r,e){let t=!1;return l(e)&&u(e).forEach(i=>{let n=e[i].$gt;n=p(n);let o=We.get(r,i);o!==void 0&&n.forEach(s=>{typeof o=="string"||typeof o=="number"?o>s&&(t=!0):Array.isArray(o)&&o.length>s&&(t=!0)})}),t}import Xe from"dot-wild";function ne(r,e){let t=!1;return l(e)&&u(e).forEach(i=>{let n=e[i].$gte;n=p(n);let o=Xe.get(r,i);o!==void 0&&n.forEach(s=>{typeof o=="string"||typeof o=="number"?o>=s&&(t=!0):Array.isArray(o)&&o.length>=s&&(t=!0)})}),t}import Le from"dot-wild";function ie(r,e){let t=!1;return l(e)&&u(e).forEach(i=>{let n=e[i].$lt;n=p(n);let o=Le.get(r,i);o!==void 0&&n.forEach(s=>{typeof o=="string"||typeof o=="number"?o<s&&(t=!0):Array.isArray(o)&&o.length<s&&(t=!0)})}),t}import Ze from"dot-wild";function oe(r,e){let t=!1;return l(e)&&u(e).forEach(i=>{let n=e[i].$lte;n=p(n);let o=Ze.get(r,i);o!==void 0&&n.forEach(s=>{typeof o=="string"||typeof o=="number"?o<=s&&(t=!0):Array.isArray(o)&&o.length<=s&&(t=!0)})}),t}import se from"dot-wild";function ae(r,e){let t=[];return l(e)&&u(e).forEach(i=>{if(i!=="$and")return;let n=e[i];n=p(n),n.forEach(o=>{u(o).forEach(s=>{let a=se.get(o,s),f=se.get(r,s);if(typeof a=="function"&&f!==void 0)t.push(a(f));else{let c=g(r,o,{deep:!0,returnKey:h,clonedData:!0},r);t.push(Boolean(c&&c.length))}})})}),!(!t.length||t.length&&t.includes(!1))}import fe from"dot-wild";function ce(r,e){let t=[];return l(e)&&u(e).forEach(i=>{if(i!=="$or")return;let n=e[i];n=p(n),n.forEach(o=>{u(o).forEach(s=>{let a=fe.get(o,s),f=fe.get(r,s);if(typeof a=="function"&&f!==void 0)t.push(a(f));else{let c=g(r,o,{deep:!0,returnKey:h,clonedData:!0},r);t.push(Boolean(c&&c.length))}})})}),t.length?!!(t.length&&t.includes(!0)):!1}import le from"dot-wild";function ue(r,e){let t=[];return l(e)&&u(e).forEach(i=>{if(i!=="$xor")return;let n=e[i];if(n=p(n),n.length!==2)throw new Error(`invalid $xor query. expected exactly two values, found ${n.length}.`);n.forEach(o=>{u(o).forEach(s=>{let a=le.get(o,s)??o[s],f=le.get(r,s);if(typeof a=="function"&&f!==void 0)t.push(a(f));else{let c=g(r,o,{deep:!0,returnKey:h,clonedData:!0},r);t.push(Boolean(c&&c.length))}})})}),t.length===2?t.filter(i=>i).length===1:!1}import Ge from"dot-wild";function pe(r,e){let t;return l(e)&&u(e).forEach(i=>{if(l(e[i])){let n=Ge.get(r,i);if(n===void 0)return;u(e[i]).forEach(o=>{o==="$fn"&&(t=!0,p(e[i][o]).forEach(s=>{s(n)||(t=!1)}))})}}),t!==void 0?t:!1}import ke from"dot-wild";function de(r,e){let t;return l(e)&&u(e).forEach(i=>{if(l(e[i])){let n=ke.get(r,i);if(n===void 0)return;u(e[i]).forEach(o=>{o==="$re"&&(t=!0,p(e[i][o]).forEach(s=>{s.test(n)||(t=!1)}))})}}),t!==void 0?t:!1}import he from"dot-wild";function me(r,e){let t=[];return l(e)&&u(e).forEach(i=>{let n=e[i].$includes;n=p(n),he.get(r,i)&&n.forEach(o=>{t.push(he.get(r,i).includes(o))})}),!(!t.length||t.length&&t.includes(!1))}import ze from"dot-wild";function ge(r,e){let t=[];return l(e)&&u(e).forEach(i=>{let n=e[i].$oneOf;n=p(n);let o=ze.get(r,i);o!==void 0&&t.push(n.includes(o))}),!(!t.length||t.length&&t.includes(!1))}import qe from"dot-wild";function be(r,e){let t=!1;return l(e)&&u(e).forEach(i=>{let n=e[i].$length,o=qe.get(r,i);o!==void 0&&(Array.isArray(o)||typeof o=="string")&&o.length===n&&(t=!0)}),t}function ye(r,e){let t=[];return l(e)&&u(e).forEach(i=>{if(i!=="$not")return;if(!l(e[i]))throw new Error(`$not operator requires an object as its value, received: ${e[i]}`);let n=p(e[i]);t.push(n.every(o=>{if(l(o)){let s=g(r,o,{deep:!0,returnKey:h,clonedData:!0},r);return!(s&&s.length)}return O(r,o)}))}),t.every(i=>!i)||!1}import et from"dot-wild";function Te(r,e){let t=!1;return l(e)&&u(e).forEach(i=>{if(i!=="$has")return;let n=e[i];n=p(n),t=n.every(o=>et.get(r,o)!==void 0)}),t}import tt from"dot-wild";function Oe(r,e){let t=!1;return l(e)&&u(e).forEach(i=>{if(i!=="$hasAny")return;let n=e[i];n=p(n),t=n.some(o=>tt.get(r,o))}),t}var A=(r,e,t,i=!1)=>{if(r===void 0)return;let n=o=>{if(!l(o))return o;let s={...o};return v(s,e)&&u(t).forEach(a=>{i?s={...s,[a]:t[a]}:O(s,a)&&(s={...s,[a]:t[a]})}),u(s).forEach(a=>{(l(s[a])||Array.isArray(s[a]))&&(s={...s,[a]:A(s[a],e,t,i)})}),s};return(Array.isArray(r)||l(r))&&!T(e)&&!T(t)?Array.isArray(r)?r.map(o=>n(o)):n(r):r};function _e(r,e,t,i){return p(e).forEach(o=>{if(!l(o)&&!Array.isArray(o)){let s={};u(t).forEach(a=>{s[a]=o}),r=A(r,t,s,!0);return}r=A(r,t,o,!0)}),r}import rt from"dot-wild";function H(r,e,t,i){return p(e).forEach(o=>{if(Array.isArray(o))return H(r,o,t,i);r=r.map(s=>rt.set(s,o,void 0))}),r}function je(r,e,t,i){return p(e).forEach(o=>{if(!l(o)&&!Array.isArray(o)){let s={};u(t).forEach(a=>{s[a]=o}),r=A(r,t,s,!1)}else r=A(r,t,o,!1)}),r}function V(r,e,t,i,n){let o=p(e),s=g(r,t,{deep:!0,returnKey:h,clonedData:!1});return o.forEach(a=>{if(l(a)&&u(a).forEach(f=>{s.forEach(c=>{let d=g([c],t,{returnKey:f,deep:!0,clonedData:!1});(d?.length?d:s).forEach(m=>{if(O(m,f))i===0?m[f]+=a[f]:i===1?m[f]-=a[f]:i===2?m[f]*=a[f]:i===3&&(m[f]/=a[f]);else{let _=u(t)[0],j=g([m],t,{returnKey:_,deep:!0,clonedData:!1});j&&j.forEach(x=>{i===0?x[f]=a[f]:i===1?x[f]=-a[f]:i===2?x[f]=a[f]:i===3&&(x[f]=1/a[f])})}})})}),!l(a)){if(!s||!s.length)return;u(t).forEach(f=>{s.forEach(c=>{let d=g([c],t,{returnKey:f,deep:!0,clonedData:!1});(d?.length?d:s).forEach(m=>{O(m,f)?i===0?m[f]+=a:i===1?m[f]-=a:i===2?m[f]*=a:i===3&&(m[f]/=a):i===0?m[f]=a:i===1?m[f]=-a:i===2?m[f]=a:i===3&&(m[f]=1/a)})})})}}),r}function ve(r,e,t,i){return V(r,e,t,0,i)}function xe(r,e,t,i){return V(r,e,t,1,i)}function Ee(r,e,t,i){return V(r,e,t,2,i)}function Ae(r,e,t,i){return V(r,e,t,3,i)}import nt from"lodash";function J(r,e,t,i=!1){if(r===void 0)return;let n=o=>{if(!l(o))return o;let s={...o};return v(s,e)&&(i?s=nt.merge(s,t):s={...s,...t}),u(s).forEach(a=>{(l(s[a])||Array.isArray(s[a]))&&(s={...s,[a]:J(s[a],e,t)})}),s};return(Array.isArray(r)||l(r))&&!T(e)&&!T(t)?Array.isArray(r)?r.map(o=>n(o)):n(r):r}function $e(r,e,t,i){return p(e).forEach(o=>{r=J(r,t,o,!0)}),r}function Ce(r,e,t,i){if(typeof e!="function")throw new Error("$map expected a function, e.g. { $map: (doc) => doc }");return r.map((n,o,s)=>e(n,o,s))}import we from"dot-wild";function Ie(r,e,t,i){if(te(e))return r.filter((n,o,s)=>e(n,o,s)?!0:(n[h]&&i.remove({[h]:n[h]}),!1));if(l(e))return r.map(n=>(Object.keys(e).forEach(o=>{let s=we.get(n,o);if(!Array.isArray(s))throw new Error(`$filter when providing an object to filter on, the key being operated on in the source document must be an array: ${o} was not an array`);let a=s.filter((f,c,d)=>e[o](f,c,d));n=we.set(n,o,a)}),n));throw new Error("$filter expected either a function, e.g. { $filter: (doc) => doc }, or an array path with a function key, e.g. { $filter: { anArray: (doc) => doc } }")}import K from"dot-wild";function De(r,e,t,i){return p(e).forEach(o=>{l(o)&&Object.keys(o).forEach(s=>{r=r.map(a=>{if(K.get(a,s)!==void 0){let f=K.get(a,s),c=o[s];if(Array.isArray(c)){let d=f.concat(c);a=K.set(a,s,d)}else{let d=f.concat([c]);a=K.set(a,s,d)}}return a})})}),r}import N from"dot-wild";function Se(r,e,t,i){return p(e).forEach(o=>{l(o)&&Object.keys(o).forEach(s=>{r=r.map(a=>{if(N.get(a,s)!==void 0){let f=N.get(a,s),c=o[s];if(Array.isArray(c)){let d=c.concat(f);a=N.set(a,s,d)}else{let d=[c].concat(f);a=N.set(a,s,d)}}return a})})}),r}var D={$gt:re,$gte:ne,$lt:ie,$lte:oe,$and:ae,$or:ce,$xor:ue,$includes:me,$oneOf:ge,$fn:pe,$re:de,$length:be,$not:ye,$has:Te,$hasAny:Oe},Pe={$merge:$e,$map:Ce,$filter:Ie,$push:De,$unshift:Se,$set:_e,$unset:H,$change:je,$inc:ve,$dec:xe,$mult:Ee,$div:Ae};function Ve(r,e,t,i){return u(e).forEach(n=>{if(!Pe[n]){console.warn(`unknown operator: ${n}`);return}r=Pe[n](r,e[n],t,i)}),r}function v(r,e){if(typeof r!=typeof e)return!1;let t=(i,n)=>{if(i[n]===e[n])return!0;let o=[];return n.startsWith("$")&&o.push(n),n!=="$not"&&l(e[n])&&!T(e[n])&&(o=o.concat(u(e[n]).filter(s=>s.startsWith("$")))),o.length?o.every(s=>s==="$not"?!D[s](i,e):D[s](i,e)):n.includes(".")?Ke.get(i,n)===e[n]:O(i,n)&&v(i[n],e[n])};return Array.isArray(r)&&Array.isArray(e)?r.some(i=>l(i)||Array.isArray(i))||e.some(i=>l(i)||Array.isArray(i))?r.every((i,n)=>v(r[n],e[n])):[...r].map(i=>`${i}`).sort().join(",")===[...e].map(i=>`${i}`).sort().join(","):Array.isArray(r)&&l(e)?Object.keys(e).every(i=>t(r,i)):l(r)&&l(e)?u(e).every(i=>t(r,i)):r===e}function g(r,e,t,i=null){if(r===void 0)return;r.__private&&delete r.__private,O(r,t.returnKey)&&(i=r);let n,o=Object.keys(e).some(f=>f.startsWith("$"));function s(f){if(!(!f||T(f))){if(n=p(n),f=p(f),Array.isArray(n)&&Array.isArray(f)){let c=n.map(d=>d[t.returnKey]);if(f.some(d=>c.includes(d[t.returnKey])))return}n=n.concat(f)}}function a(f){!f||(O(f,t.returnKey)&&(i=f),v(f,e)?s(i):t.deep&&!o&&u(f).forEach(c=>{(l(f[c])||Array.isArray(f[c]))&&(O(e,c)?s(g(f[c],e[c],t,i)):s(g(f[c],e,t,i)))}))}if(r=p(r),l(e)&&Array.isArray(r)&&!o&&r.forEach((f,c)=>{O(f,t.returnKey)&&(i=f),u(e).forEach(d=>{if(typeof d=="string"&&d.includes(".")){let y=Ke.get(f,d);y!==void 0&&s(g(y,e[d],t,i))}else l(f)?v(r[c],e[d])&&s(i):v(r,e[d])&&s(i)})}),!T(e)&&Array.isArray(r))r.forEach(f=>a(f));else return r;return n}var ot=(r,e)=>{let t=new Map,i;return r=p(r),r.filter(n=>{if(n!==void 0)return i=t.get(n[e]),i?n[e]!=i?(t.delete(n[e]),t.set(n[e],n[e]),!0):!1:(t.set(n[e],n[e]),!0)})};function W(r,e,t,i,n){if(t={...Q(),...t},e=p(e),e=e.filter(c=>Object.keys(c).length>0),!e.length){if(t.clonedData){let c=[];for(let d in r)d!=="__private"&&c.push(U.cloneDeep(r[d]));return c}return I([...E(r)],t)}let o=[...E(r)].slice(1),s=[];for(let c of e){let d=[];if(c[h]&&!l(c[h])&&!i.integerIds)d.push(r[c[h]]);else if(c[h]&&!l(c[h])&&i.integerIds){let y=r.__private.id_map[c[h]];y&&d.push(r[y])}else{let y=R(U.cloneDeep(c)),m=Object.fromEntries(Object.entries(it.flatten(y)).map(([_,j])=>[_.replace(/\\./g,"."),j]));Object.keys(m).some(_=>n.indices[_])?Object.keys(n.indices).forEach(_=>{let j=_.includes(".")?m[_]:c[_];if(j){let x=r.__private.index.valuesToCuid?.[_]?.[j];if(x){let Ye=x?.map(Be=>r[Be]);d.push(...g(Ye,c,t,i))}else d.push(...g(o,c,t,n))}}):(d=g(o,c,t,null),d===void 0&&(d=[]),d=p(d))}s.push(...d)}let a=ot(s,h);if(s=I(a,t),!t.clonedData)return s;let f=[];for(let c of s)f.push(U.cloneDeep(c));return f}import $ from"fs";import Ne from"path";var S=class{elements=[];push(...e){this.elements.push(...e)}shift(){return this.elements.shift()}length(){return this.elements.length}},C=class{storagePath;name;filePath;queue;constructor(e,t){t.endsWith(".json")||(t+=".json"),this.storagePath=e,this.name=t,this.queue=new S,this.filePath=Ne.join(this.storagePath,this.name),this.prepareStorage()}prepareStorage(){$.existsSync(this.storagePath)||$.mkdirSync(this.storagePath),$.existsSync(this.filePath)||$.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{return Object.assign({},JSON.parse($.readFileSync(this.filePath,"utf8"))||{})}catch{return{}}}write(e){for(this.queue.push([t=>{st(t,this.filePath)},e]);this.queue.length();){let t=this.queue.shift();t[0](t[1])}}};function st(r,...e){let i=(process.env.NODE_ENV||"development")==="development"?2:0,n=JSON.stringify(r,null,i);return at(n,...e)}function at(r,...e){let t=Ne.join(...e);return $.writeFileSync(t,r)}var M=class{collection;inserted=[];removed=[];updated=[];operations=[];constructor(e){this.collection=e}insert(e){let t=this.collection.insert(e);return this.inserted.push(t),this.operations.push("insert"),t}update(e,t,i={}){let n=this.collection.find(e,{...i,project:void 0,join:void 0});return this.updated.push({documents:n,operations:t,options:i}),this.operations.push("update"),this.collection.update(e,t,i)}remove(e,t={}){let i=this.collection.find(e,{...t,project:void 0,join:void 0});return this.collection.remove(e,t),this.removed.push(i),this.operations.push("remove"),i}rollback(){let e=n=>{n.forEach(o=>{o[h]!==void 0?this.collection.remove({[h]:o[h]}):this.collection.remove({...o})})},t=n=>{n.documents.forEach(o=>{o[h]!==void 0?this.collection.assign(o[h],o):this.collection.update({...o},n.operations,n.options)})},i=n=>{n.forEach(o=>{o[h]!==void 0&&this.collection.assign(o[h],o)})};this.operations.reverse().forEach(n=>{switch(n){case"insert":e(this.inserted.pop());break;case"update":t(this.updated.pop());break;case"remove":i(this.removed.pop());break}}),this.inserted=[],this.updated=[],this.removed=[],this.operations=[]}commit(){this.inserted=[],this.updated=[],this.removed=[],this.collection._transaction=null}};import Qe from"dot-wild";function X(r,e,t,i,n,o){i={...Q(),...i},e=p(e);let s=[];for(let a of e){let f=[];f=g([...E(r)],a,i,null),f=p(f),s.push(...Ve(f,t,a,o))}return i.returnKey===h&&n.timestamps&&s.forEach(a=>{let f;if(n.integerIds){let c=a[h];f=r.__private.id_map[c]}else f=a[h];Object.keys(o.indices).forEach(c=>{if(Qe.get(a,c)){let d=r.__private.index.cuidToValues[f][c],y=String(Qe.get(a,c));d!==y&&(r.__private.index.valuesToCuid[c][y]=r.__private.index.valuesToCuid[c][y]||[],r.__private.index.valuesToCuid[c][y].push(f),r.__private.index.valuesToCuid[c][d]=r.__private.index.valuesToCuid[c][d].filter(m=>m!==m),r.__private.index.valuesToCuid[c][d].length===0&&delete r.__private.index.valuesToCuid[c][d],r.__private.index.cuidToValues[f][c]=y)}}),a[L]=Date.now(),o.merge(a[h],a)}),I(s,i)}var Z=256,G=[];for(;Z--;)G[Z]=(Z+256).toString(16).substring(1);function ft(r,e){let t="000000"+r;return t.substr(t.length-e)}function Re(r){let e=r.len||16,t="",i=0,n=Math.pow(36,4),o=r.init+Math.ceil(n/2);function s(){return o=o<=n?o:0,o++,(o-1).toString(16)}return function(){if(!t||i===256){for(t="",i=(1+e)/2|0;i--;)t+=G[256*Math.random()|0];t=t.substring(i=0,e)}return`a${Date.now().toString(36)}${ft(s(),6)}${G[i++]}${t}`}}function Q(){return{deep:!0,returnKey:h,clonedData:!0,sort:void 0,skip:void 0,project:void 0}}function R(r){let e=new Set(u(D));return l(r)?(Object.keys(r).forEach(t=>{if(l(t)&&u(r[t]).every(i=>e.has(i))){delete r[t];return}if(!l(t)&&e.has(t)){delete r[t];return}if(!!l(r[t])){if(u(r[t]).every(i=>e.has(i))){delete r[t];return}u(r[t]).forEach(i=>{e.has(i)?delete r[t][i]:R(r[t][i])})}}),B(r)):r}var h="_id",ct="_created_at",L="_updated_at",z=r=>r!==void 0&&(typeof r=="string"||typeof r=="number"||typeof r=="boolean"),q=class{storagePath;name;options;data={};_transaction=null;indices={};createId;constructor(e=".data",t="db",i={}){this.storagePath=e,this.name=t,i.autosync=i.autosync??!0,i.timestamps=i.timestamps??!0,i.integerIds=i.integerIds??!1,i.adapter=i.adapter??new C(this.storagePath,this.name),this.options=i;let n=()=>({current:0,next_id:0,id_map:{},index:{valuesToCuid:{},cuidToValues:{}}});this.adapterRead(),this.data.__private||(this.data.__private=n()),this.createId=Re({init:this.data.__private.current,len:4})}adapterRead(){this.data=this.options.adapter.read()}assign(e,t){if(e!==void 0){if(this.options.integerIds){let i=e,n=this.data.__private.id_map[i];return n?(this.data[n]=t,this.data[n]):this.insert({...t,[h]:i})[0]}if(typeof e=="string"||typeof e=="number")return this.data[e]=t,this.data[e]}}filter(e){let t=Object.assign({},this.data);return delete t.__private,Object.values(t).filter(i=>{try{return e(i)}catch{return!1}})}find(e,t={}){return W(this.data,e,t,this.options,this)}update(e,t,i={}){return X(this.data,e,t,i,this.options,this)}upsert(e,t,i={}){let n=this.update(e,t,i);if(n.length)return n;e=R(e);let o=this.insert(e);return X(o,e,t,i,this.options,this)}remove(e,t={}){let i=this.find(e,{...t,clonedData:!1}),n=i.map(o=>Object.assign({},o));return i.forEach(o=>{let s;if(this.options.integerIds){let a=o[h];s=this.data.__private.id_map[a],delete this.data.__private.id_map[a]}else s=o[h];Object.keys(this.indices).forEach(a=>{let f=k.get(o,a);z(f)&&(this.data.__private.index.valuesToCuid[a][f]=this.data.__private.index.valuesToCuid[a][f].filter(c=>c!==s),this.data.__private.index.valuesToCuid[a][f].length===0&&delete this.data.__private.index.valuesToCuid[a][f],delete this.data.__private.index.cuidToValues[s]),f===void 0&&Object.keys(this.data.__private.index.valuesToCuid[a]).forEach(c=>{this.data.__private.index.valuesToCuid[a][c]=this.data.__private.index.valuesToCuid[a][c].filter(d=>d!==s),this.data.__private.index.valuesToCuid[a][c].length===0&&delete this.data.__private.index.valuesToCuid[a][c]})}),delete this.data[s]}),this.sync(),n}insert(e){return Array.isArray(e)||(e=[e]),e.length?(e=e.map(t=>{let i=this.getId();if(this.data.__private.current++,this.options.timestamps&&(t[ct]=Date.now(),t[L]=Date.now()),t[h]===void 0&&(t[h]=i,this.options.integerIds)){let n=this.nextIntegerId();this.data.__private.id_map[n]=i,t[h]=n}return this.data[i]=t,Object.keys(this.indices).forEach(n=>{let o=String(k.get(t,n));if(z(o)){if(this.indices[n].unique&&this.data.__private.index.valuesToCuid?.[n]?.[o]!==void 0)throw new Error(`Unique index violation for key "${n}" and value "${o}"`);this.data.__private.index.valuesToCuid[n]=this.data.__private.index.valuesToCuid[n]||{},this.data.__private.index.valuesToCuid[n][o]=this.data.__private.index.valuesToCuid[n][o]||[],this.data.__private.index.valuesToCuid[n][o].push(i),this.data.__private.index.cuidToValues[i]=this.data.__private.index.cuidToValues[i]||{},this.data.__private.index.cuidToValues[i][n]=o}}),t}),this.options.autosync&&this.sync(),e):[]}merge(e,t){if(!!e){if(this.options.integerIds){let i=this.data.__private.id_map[e];if(!i||this.data[i]===void 0)return;Object.assign(this.data[i],T(t)?{}:t),this.sync();return}this.data[e]!==void 0&&(Object.assign(this.data[e],T(t)?{}:t),this.sync())}}sync(){return this.options.adapter.write(this.data)}drop(){this.data={__private:{current:0,next_id:0,id_map:{},index:{valuesToCuid:{},cuidToValues:{}}}}}getId(){return this.createId()}createIndex(e={}){if(!e.key)throw new Error("createIndex requires a key");e={key:e.key,unique:e.unique??!1};let{key:t,unique:i}=e;if(t.split(".").some(n=>!isNaN(Number(n))))throw new Error(`Cannot use a numeric property as an index key: ${t}`);if(this.indices[t]={unique:i},!this.data.__private.index.valuesToCuid[t])return Object.keys(this.data).forEach(n=>{if(n==="__private")return;let o=String(k.get(this.data[n],t));if(z(o)){if(i&&this.data.__private.index.valuesToCuid?.[t]?.[o]!==void 0)throw new Error(`Unique index violation for key "${t}" and value "${o}"`);this.data.__private.index.valuesToCuid[t]=this.data.__private.index.valuesToCuid[t]||{},this.data.__private.index.valuesToCuid[t][o]=this.data.__private.index.valuesToCuid[t][o]||[],this.data.__private.index.valuesToCuid[t][o].push(n),this.data.__private.index.cuidToValues[n]=this.data.__private.index.cuidToValues[n]||{},this.data.__private.index.cuidToValues[n][t]=o}else throw new Error(`Invalid index value for property ${t}: ${o}`)}),this.sync(),this}removeIndex(e){return this.indices[e]?(delete this.indices[e],this.data.__private.index.valuesToCuid[e]&&delete this.data.__private.index.valuesToCuid[e],Object.keys(this.data.__private.index.cuidToValues).forEach(t=>{this.data.__private.index.cuidToValues[t][e]!==void 0&&delete this.data.__private.index.cuidToValues[t][e],T(this.data.__private.index.cuidToValues[t])&&delete this.data.__private.index.cuidToValues[t]}),this.sync(),!0):!1}nextIntegerId(){return this.data.__private.next_id++}transaction(e){this._transaction=new M(this);try{e(this._transaction)}catch(t){throw this._transaction.rollback(),t}this._transaction.commit()}};import w from"fs";import Me from"path";import ee from"crypto";var F=class{storagePath;name;filePath;queue;constructor(e,t){t.endsWith(".json")||(t+=".json"),this.storagePath=e,this.name=t,this.queue=new S,this.filePath=Me.join(this.storagePath,this.name),this.prepareStorage()}prepareStorage(){w.existsSync(this.storagePath)||w.mkdirSync(this.storagePath),w.existsSync(this.filePath)||w.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{let e=w.readFileSync(this.filePath,"utf8"),t=dt(e);return Object.assign({},JSON.parse(t)||{})}catch{return{}}}write(e){for(this.queue.push([t=>{lt(t,this.filePath)},e]);this.queue.length();){let t=this.queue.shift();t[0](t[1])}}},Fe=String(process.env.ARC_ENCFS_KEY||"Mahpsee2X7TKLe1xwJYmar91pCSaZIY7"),lt=(r,...e)=>{let t=JSON.stringify(r,null,0);return ut(pt(t),...e)},ut=(r,...e)=>w.writeFileSync(Me.join(...e),r),pt=r=>{let e=Buffer.from(ee.randomBytes(16)).toString("hex").slice(0,16),t=ee.createCipheriv("aes-256-cbc",Buffer.from(Fe),e),i=Buffer.concat([t.update(r),t.final()]);return`${e}:${i.toString("hex")}`},dt=r=>{let e=r.includes(":")?r.split(":"):[],t=Buffer.from(e.shift()||"","binary"),i=Buffer.from(e.join(":"),"hex"),n=ee.createDecipheriv("aes-256-cbc",Buffer.from(Fe),t);return Buffer.concat([n.update(i),n.final()]).toString()};var Y=class{storageKey;constructor(e){this.storageKey=`arc_${e}`}read(){try{return Object.assign({},JSON.parse(localStorage.getItem(`arc_${this.storageKey}`)||"{}"))}catch(e){return console.error(`arc: failed to read from key: ${this.storageKey}: ${e}`),{}}}write(e){localStorage.setItem(this.storageKey,JSON.stringify(e))}};export{q as Collection,F as EncryptedFSAdapter,C as FSAdapter,Y as LocalStorageAdapter};
