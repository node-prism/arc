import st from"cuid";import Z from"dot-wild";import U from"lodash";import rt from"dot-wild";import Fe from"cuid";import b from"dot-wild";import P from"lodash";function p(i){return Array.isArray(i)?i:i==null?[]:[i]}function l(i){return!!i&&Object.prototype.toString.call(i)==="[object Object]"}function T(i){return l(i)&&u(i).length===0}var E=Object.values,u=Object.keys,O=(i,e)=>i?Object.prototype.hasOwnProperty.call(i,e):!1;function q(i){return typeof i=="function"}function B(i){return l(i)&&u(i).forEach(e=>{!i[e]||!l(i[e])||(B(i[e]),u(i[e]).length===0&&delete i[e])}),i}var Ye=i=>i.map(e=>t=>t[e]),Be=i=>i.map(e=>e===1?"asc":"desc");function He(i,e){let t={$floor:(n,r)=>{let o=b.get(n,r);return typeof o=="number"?Math.floor(o):0},$ceil:(n,r)=>{let o=b.get(n,r);return typeof o=="number"?Math.ceil(o):0},$sub:(n,r)=>{let o;for(let s of r)typeof s=="number"?o===void 0?o=s:o-=s:o===void 0?o=Number(b.get(n,s)??0):o-=Number(b.get(n,s)??0);return o},$add:(n,r)=>{let o;for(let s of r)typeof s=="number"?o===void 0?o=s:o+=s:o===void 0?o=Number(b.get(n,s)??0):o+=Number(b.get(n,s)??0);return o},$mult:(n,r)=>{let o=1;for(let s of r)typeof s=="number"?o*=s:o*=Number(b.get(n,s)??1);return o},$div:(n,r)=>{let o;for(let s of r)typeof s=="number"?o===void 0?o=s:o/=s:o===void 0?o=Number(b.get(n,s)??1):o/=Number(b.get(n,s)??1);return o},$fn:(n,r)=>r(n)};return u(e.aggregate).forEach(n=>{typeof e.aggregate[n]=="object"&&u(e.aggregate[n]).forEach(r=>{r[0]==="$"&&(!t[r]||(i=i.map(o=>(o[n]=t[r](o,e.aggregate[n][r]),o))))})}),i}function D(i,e){if(e.aggregate&&(i=He(i,e)),e.project){let r=Object.keys(e.project).reduce((s,a)=>{if(typeof e.project[a]=="number"&&typeof s=="number")return s+e.project[a]},0),o=r===Object.keys(e.project).length?1:r===0?2:0;if(o===1)i=i.map(s=>P.pick(s,u(e.project)));else if(o===2)i=i.map(s=>P.omit(s,u(e.project)));else if(o===0){let s=Object.keys(e.project).filter(a=>e.project[a]===0);i=i.map(a=>P.omit(a,s))}}e.sort&&(i=P.orderBy(i,Ye(u(e.sort)),Be(E(e.sort)))),e.skip&&typeof e.skip=="number"&&(i=i.slice(e.skip)),e.take&&typeof e.take=="number"&&(i=i.slice(0,e.take)),e.join&&Array.isArray(e.join)&&e.join.forEach(r=>{if(!r.collection)throw new Error("Missing required field in join: collection");if(!r.from)throw new Error("Missing required field in join: from");if(!r.on)throw new Error("Missing required field in join: on");if(!r.as)throw new Error("Missing required field in join: as");let o=r?.options||{},s=r.collection,a=Fe(),f=!1;i=i.map(c=>{if(r.as.includes(".")){if(!r.as.includes("*"))throw new Error("as field must include * when using dot notation, e.g. items.*.meta");f=!0}f||(c[r.as]=p(c[r.as])),c[a]=[];let d=r.from.includes(".")?b.get(c,r.from):c[r.from];if(d===void 0)return c;if(Array.isArray(d))return d.forEach((m,_)=>{let j={[`${r.on}`]:m};f?c=b.set(c,r.as.replaceAll("*",_.toString()),s.find(j,o)[0]):c[a]=c[a].concat(s.find(j,o))}),f||(c[r.as]=c[a]),delete c[a],c;let y={[`${r.on}`]:d};return f||(c[a]=s.find(y,o),c[r.as]=c[a]),delete c[a],c})});function t(r,o){for(let s in o){let a=b.get(r,s);a==null&&(typeof o[s]=="function"?r=b.set(r,s,o[s](r)):r=b.set(r,s,o[s]))}return r}function n(r,o){for(let s in o){let a=b.get(r,s);Array.isArray(a)&&a.length===0&&(typeof o[s]=="function"?r=b.set(r,s,o[s](r)):r=b.set(r,s,o[s])),typeof a=="string"&&a.trim().length===0&&(typeof o[s]=="function"?r=b.set(r,s,o[s](r)):r=b.set(r,s,o[s])),typeof a=="object"&&Object.keys(a).length===0&&(typeof o[s]=="function"?r=b.set(r,s,o[s](r)):r=b.set(r,s,o[s]))}return r}return e.ifNull&&(i=i.map(r=>t(r,e.ifNull))),e.ifEmpty&&(i=i.map(r=>n(r,e.ifEmpty))),e.ifNullOrEmpty&&(i=i.map(r=>t(r,e.ifNullOrEmpty)).map(r=>n(r,e.ifNullOrEmpty))),i}import Pe from"dot-wild";import Je from"dot-wild";function ee(i,e){let t=!1;return l(e)&&u(e).forEach(n=>{let r=e[n].$gt;r=p(r);let o=Je.get(i,n);o!==void 0&&r.forEach(s=>{typeof o=="string"||typeof o=="number"?o>s&&(t=!0):Array.isArray(o)&&o.length>s&&(t=!0)})}),t}import Ue from"dot-wild";function te(i,e){let t=!1;return l(e)&&u(e).forEach(n=>{let r=e[n].$gte;r=p(r);let o=Ue.get(i,n);o!==void 0&&r.forEach(s=>{typeof o=="string"||typeof o=="number"?o>=s&&(t=!0):Array.isArray(o)&&o.length>=s&&(t=!0)})}),t}import We from"dot-wild";function re(i,e){let t=!1;return l(e)&&u(e).forEach(n=>{let r=e[n].$lt;r=p(r);let o=We.get(i,n);o!==void 0&&r.forEach(s=>{typeof o=="string"||typeof o=="number"?o<s&&(t=!0):Array.isArray(o)&&o.length<s&&(t=!0)})}),t}import Le from"dot-wild";function ie(i,e){let t=!1;return l(e)&&u(e).forEach(n=>{let r=e[n].$lte;r=p(r);let o=Le.get(i,n);o!==void 0&&r.forEach(s=>{typeof o=="string"||typeof o=="number"?o<=s&&(t=!0):Array.isArray(o)&&o.length<=s&&(t=!0)})}),t}import ne from"dot-wild";function oe(i,e){let t=[];return l(e)&&u(e).forEach(n=>{if(n!=="$and")return;let r=e[n];r=p(r),r.forEach(o=>{u(o).forEach(s=>{let a=ne.get(o,s),f=ne.get(i,s);if(typeof a=="function"&&f!==void 0)t.push(a(f));else{let c=g(i,o,{deep:!0,returnKey:h,clonedData:!0},i);t.push(Boolean(c&&c.length))}})})}),!(!t.length||t.length&&t.includes(!1))}import se from"dot-wild";function ae(i,e){let t=[];return l(e)&&u(e).forEach(n=>{if(n!=="$or")return;let r=e[n];r=p(r),r.forEach(o=>{u(o).forEach(s=>{let a=se.get(o,s),f=se.get(i,s);if(typeof a=="function"&&f!==void 0)t.push(a(f));else{let c=g(i,o,{deep:!0,returnKey:h,clonedData:!0},i);t.push(Boolean(c&&c.length))}})})}),t.length?!!(t.length&&t.includes(!0)):!1}import fe from"dot-wild";function ce(i,e){let t=[];return l(e)&&u(e).forEach(n=>{if(n!=="$xor")return;let r=e[n];if(r=p(r),r.length!==2)throw new Error(`invalid $xor query. expected exactly two values, found ${r.length}.`);r.forEach(o=>{u(o).forEach(s=>{let a=fe.get(o,s)??o[s],f=fe.get(i,s);if(typeof a=="function"&&f!==void 0)t.push(a(f));else{let c=g(i,o,{deep:!0,returnKey:h,clonedData:!0},i);t.push(Boolean(c&&c.length))}})})}),t.length===2?t.filter(n=>n).length===1:!1}import Xe from"dot-wild";function le(i,e){let t;return l(e)&&u(e).forEach(n=>{if(l(e[n])){let r=Xe.get(i,n);if(r===void 0)return;u(e[n]).forEach(o=>{o==="$fn"&&(t=!0,p(e[n][o]).forEach(s=>{s(r)||(t=!1)}))})}}),t!==void 0?t:!1}import Ze from"dot-wild";function ue(i,e){let t;return l(e)&&u(e).forEach(n=>{if(l(e[n])){let r=Ze.get(i,n);if(r===void 0)return;u(e[n]).forEach(o=>{o==="$re"&&(t=!0,p(e[n][o]).forEach(s=>{s.test(r)||(t=!1)}))})}}),t!==void 0?t:!1}import pe from"dot-wild";function de(i,e){let t=[];return l(e)&&u(e).forEach(n=>{let r=e[n].$includes;r=p(r),pe.get(i,n)&&r.forEach(o=>{t.push(pe.get(i,n).includes(o))})}),!(!t.length||t.length&&t.includes(!1))}import Ge from"dot-wild";function he(i,e){let t=[];return l(e)&&u(e).forEach(n=>{let r=e[n].$oneOf;r=p(r);let o=Ge.get(i,n);o!==void 0&&t.push(r.includes(o))}),!(!t.length||t.length&&t.includes(!1))}import ke from"dot-wild";function me(i,e){let t=!1;return l(e)&&u(e).forEach(n=>{let r=e[n].$length,o=ke.get(i,n);o!==void 0&&(Array.isArray(o)||typeof o=="string")&&o.length===r&&(t=!0)}),t}function ge(i,e){let t=[];return l(e)&&u(e).forEach(n=>{if(n!=="$not")return;if(!l(e[n]))throw new Error(`$not operator requires an object as its value, received: ${e[n]}`);let r=p(e[n]);t.push(r.every(o=>{if(l(o)){let s=g(i,o,{deep:!0,returnKey:h,clonedData:!0},i);return!(s&&s.length)}return O(i,o)}))}),t.every(n=>!n)||!1}import ze from"dot-wild";function be(i,e){let t=!1;return l(e)&&u(e).forEach(n=>{if(n!=="$has")return;let r=e[n];r=p(r),t=r.every(o=>ze.get(i,o)!==void 0)}),t}import qe from"dot-wild";function ye(i,e){let t=!1;return l(e)&&u(e).forEach(n=>{if(n!=="$hasAny")return;let r=e[n];r=p(r),t=r.some(o=>qe.get(i,o))}),t}var A=(i,e,t,n=!1)=>{if(i===void 0)return;let r=o=>{if(!l(o))return o;let s={...o};return v(s,e)&&u(t).forEach(a=>{n?s={...s,[a]:t[a]}:O(s,a)&&(s={...s,[a]:t[a]})}),u(s).forEach(a=>{(l(s[a])||Array.isArray(s[a]))&&(s={...s,[a]:A(s[a],e,t,n)})}),s};return(Array.isArray(i)||l(i))&&!T(e)&&!T(t)?Array.isArray(i)?i.map(o=>r(o)):r(i):i};function Te(i,e,t,n){return p(e).forEach(o=>{if(!l(o)&&!Array.isArray(o)){let s={};u(t).forEach(a=>{s[a]=o}),i=A(i,t,s,!0);return}i=A(i,t,o,!0)}),i}import et from"dot-wild";function H(i,e,t,n){return p(e).forEach(o=>{if(Array.isArray(o))return H(i,o,t,n);i=i.map(s=>et.set(s,o,void 0))}),i}function Oe(i,e,t,n){return p(e).forEach(o=>{if(!l(o)&&!Array.isArray(o)){let s={};u(t).forEach(a=>{s[a]=o}),i=A(i,t,s,!1)}else i=A(i,t,o,!1)}),i}function V(i,e,t,n,r){let o=p(e),s=g(i,t,{deep:!0,returnKey:h,clonedData:!1});return o.forEach(a=>{if(l(a)&&u(a).forEach(f=>{s.forEach(c=>{let d=g([c],t,{returnKey:f,deep:!0,clonedData:!1});(d?.length?d:s).forEach(m=>{if(O(m,f))n===0?m[f]+=a[f]:n===1?m[f]-=a[f]:n===2?m[f]*=a[f]:n===3&&(m[f]/=a[f]);else{let _=u(t)[0],j=g([m],t,{returnKey:_,deep:!0,clonedData:!1});j&&j.forEach(x=>{n===0?x[f]=a[f]:n===1?x[f]=-a[f]:n===2?x[f]=a[f]:n===3&&(x[f]=1/a[f])})}})})}),!l(a)){if(!s||!s.length)return;u(t).forEach(f=>{s.forEach(c=>{let d=g([c],t,{returnKey:f,deep:!0,clonedData:!1});(d?.length?d:s).forEach(m=>{O(m,f)?n===0?m[f]+=a:n===1?m[f]-=a:n===2?m[f]*=a:n===3&&(m[f]/=a):n===0?m[f]=a:n===1?m[f]=-a:n===2?m[f]=a:n===3&&(m[f]=1/a)})})})}}),i}function _e(i,e,t,n){return V(i,e,t,0,n)}function je(i,e,t,n){return V(i,e,t,1,n)}function ve(i,e,t,n){return V(i,e,t,2,n)}function xe(i,e,t,n){return V(i,e,t,3,n)}import tt from"lodash";function J(i,e,t,n=!1){if(i===void 0)return;let r=o=>{if(!l(o))return o;let s={...o};return v(s,e)&&(n?s=tt.merge(s,t):s={...s,...t}),u(s).forEach(a=>{(l(s[a])||Array.isArray(s[a]))&&(s={...s,[a]:J(s[a],e,t)})}),s};return(Array.isArray(i)||l(i))&&!T(e)&&!T(t)?Array.isArray(i)?i.map(o=>r(o)):r(i):i}function Ee(i,e,t,n){return p(e).forEach(o=>{i=J(i,t,o,!0)}),i}function Ae(i,e,t,n){if(typeof e!="function")throw new Error("$map expected a function, e.g. { $map: (doc) => doc }");return i.map((r,o,s)=>e(r,o,s))}import $e from"dot-wild";function Ce(i,e,t,n){if(q(e))return i.filter((r,o,s)=>e(r,o,s)?!0:(r[h]&&n.remove({[h]:r[h]}),!1));if(l(e))return i.map(r=>(Object.keys(e).forEach(o=>{let s=$e.get(r,o);if(!Array.isArray(s))throw new Error(`$filter when providing an object to filter on, the key being operated on in the source document must be an array: ${o} was not an array`);let a=s.filter((f,c,d)=>e[o](f,c,d));r=$e.set(r,o,a)}),r));throw new Error("$filter expected either a function, e.g. { $filter: (doc) => doc }, or an array path with a function key, e.g. { $filter: { anArray: (doc) => doc } }")}import K from"dot-wild";function we(i,e,t,n){return p(e).forEach(o=>{l(o)&&Object.keys(o).forEach(s=>{i=i.map(a=>{if(K.get(a,s)!==void 0){let f=K.get(a,s),c=o[s];if(Array.isArray(c)){let d=f.concat(c);a=K.set(a,s,d)}else{let d=f.concat([c]);a=K.set(a,s,d)}}return a})})}),i}import N from"dot-wild";function De(i,e,t,n){return p(e).forEach(o=>{l(o)&&Object.keys(o).forEach(s=>{i=i.map(a=>{if(N.get(a,s)!==void 0){let f=N.get(a,s),c=o[s];if(Array.isArray(c)){let d=c.concat(f);a=N.set(a,s,d)}else{let d=[c].concat(f);a=N.set(a,s,d)}}return a})})}),i}var I={$gt:ee,$gte:te,$lt:re,$lte:ie,$and:oe,$or:ae,$xor:ce,$includes:de,$oneOf:he,$fn:le,$re:ue,$length:me,$not:ge,$has:be,$hasAny:ye},Ie={$merge:Ee,$map:Ae,$filter:Ce,$push:we,$unshift:De,$set:Te,$unset:H,$change:Oe,$inc:_e,$dec:je,$mult:ve,$div:xe};function Se(i,e,t,n){return u(e).forEach(r=>{if(!Ie[r]){console.warn(`unknown operator: ${r}`);return}i=Ie[r](i,e[r],t,n)}),i}function v(i,e){if(typeof i!=typeof e)return!1;let t=(n,r)=>{if(n[r]===e[r])return!0;let o=[];return r.startsWith("$")&&o.push(r),r!=="$not"&&l(e[r])&&!T(e[r])&&(o=o.concat(u(e[r]).filter(s=>s.startsWith("$")))),o.length?o.every(s=>s==="$not"?!I[s](n,e):I[s](n,e)):r.includes(".")?Pe.get(n,r)===e[r]:O(n,r)&&v(n[r],e[r])};return Array.isArray(i)&&Array.isArray(e)?i.some(n=>l(n)||Array.isArray(n))||e.some(n=>l(n)||Array.isArray(n))?i.every((n,r)=>v(i[r],e[r])):[...i].map(n=>`${n}`).sort().join(",")===[...e].map(n=>`${n}`).sort().join(","):Array.isArray(i)&&l(e)?Object.keys(e).every(n=>t(i,n)):l(i)&&l(e)?u(e).every(n=>t(i,n)):i===e}function g(i,e,t,n=null){if(i===void 0)return;i.__private&&delete i.__private,O(i,t.returnKey)&&(n=i);let r,o=Object.keys(e).some(f=>f.startsWith("$"));function s(f){if(!(!f||T(f))){if(r=p(r),f=p(f),Array.isArray(r)&&Array.isArray(f)){let c=r.map(d=>d[t.returnKey]);if(f.some(d=>c.includes(d[t.returnKey])))return}r=r.concat(f)}}function a(f){!f||(O(f,t.returnKey)&&(n=f),v(f,e)?s(n):t.deep&&!o&&u(f).forEach(c=>{(l(f[c])||Array.isArray(f[c]))&&(O(e,c)?s(g(f[c],e[c],t,n)):s(g(f[c],e,t,n)))}))}if(i=p(i),l(e)&&Array.isArray(i)&&!o&&i.forEach((f,c)=>{O(f,t.returnKey)&&(n=f),u(e).forEach(d=>{if(typeof d=="string"&&d.includes(".")){let y=Pe.get(f,d);y!==void 0&&s(g(y,e[d],t,n))}else l(f)?v(i[c],e[d])&&s(n):v(i,e[d])&&s(n)})}),!T(e)&&Array.isArray(i))i.forEach(f=>a(f));else return i;return r}var it=(i,e)=>{let t=new Map,n;return i=p(i),i.filter(r=>{if(r!==void 0)return n=t.get(r[e]),n?r[e]!=n?(t.delete(r[e]),t.set(r[e],r[e]),!0):!1:(t.set(r[e],r[e]),!0)})};function W(i,e,t,n,r){if(t={...Q(),...t},e=p(e),e=e.filter(c=>Object.keys(c).length>0),!e.length){if(t.clonedData){let c=[];for(let d in i)d!=="__private"&&c.push(U.cloneDeep(i[d]));return c}return D([...E(i)],t)}let o=[...E(i)].slice(1),s=[];for(let c of e){let d=[];if(c[h]&&!l(c[h])&&!n.integerIds)d.push(i[c[h]]);else if(c[h]&&!l(c[h])&&n.integerIds){let y=i.__private.id_map[c[h]];y&&d.push(i[y])}else{let y=R(U.cloneDeep(c)),m=Object.fromEntries(Object.entries(rt.flatten(y)).map(([_,j])=>[_.replace(/\\./g,"."),j]));Object.keys(m).some(_=>r.indices[_])?Object.keys(r.indices).forEach(_=>{let j=_.includes(".")?m[_]:c[_];if(j){let x=i.__private.index.valuesToCuid?.[_]?.[j];if(x){let Re=x?.map(Me=>i[Me]);d.push(...g(Re,c,t,n))}else d.push(...g(o,c,t,r))}}):(d=g(o,c,t,null),d===void 0&&(d=[]),d=p(d))}s.push(...d)}let a=it(s,h);if(s=D(a,t),!t.clonedData)return s;let f=[];for(let c of s)f.push(U.cloneDeep(c));return f}import $ from"fs";import Ve from"path";var S=class{elements=[];push(...e){this.elements.push(...e)}shift(){return this.elements.shift()}length(){return this.elements.length}},C=class{storagePath;name;filePath;queue;constructor(e,t){t.endsWith(".json")||(t+=".json"),this.storagePath=e,this.name=t,this.queue=new S,this.filePath=Ve.join(this.storagePath,this.name),this.prepareStorage()}prepareStorage(){$.existsSync(this.storagePath)||$.mkdirSync(this.storagePath),$.existsSync(this.filePath)||$.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{return Object.assign({},JSON.parse($.readFileSync(this.filePath,"utf8"))||{})}catch{return{}}}write(e){for(this.queue.push([t=>{nt(t,this.filePath)},e]);this.queue.length();){let t=this.queue.shift();t[0](t[1])}}};function nt(i,...e){let n=(process.env.NODE_ENV||"development")==="development"?2:0,r=JSON.stringify(i,null,n);return ot(r,...e)}function ot(i,...e){let t=Ve.join(...e);return $.writeFileSync(t,i)}var M=class{collection;inserted=[];removed=[];updated=[];operations=[];constructor(e){this.collection=e}insert(e){let t=this.collection.insert(e);return this.inserted.push(t),this.operations.push("insert"),t}update(e,t,n={}){let r=this.collection.find(e,{...n,project:void 0,join:void 0});return this.updated.push({documents:r,operations:t,options:n}),this.operations.push("update"),this.collection.update(e,t,n)}remove(e,t={}){let n=this.collection.find(e,{...t,project:void 0,join:void 0});return this.collection.remove(e,t),this.removed.push(n),this.operations.push("remove"),n}rollback(){let e=r=>{r.forEach(o=>{o[h]!==void 0?this.collection.remove({[h]:o[h]}):this.collection.remove({...o})})},t=r=>{r.documents.forEach(o=>{o[h]!==void 0?this.collection.assign(o[h],o):this.collection.update({...o},r.operations,r.options)})},n=r=>{r.forEach(o=>{o[h]!==void 0&&this.collection.assign(o[h],o)})};this.operations.reverse().forEach(r=>{switch(r){case"insert":e(this.inserted.pop());break;case"update":t(this.updated.pop());break;case"remove":n(this.removed.pop());break}}),this.inserted=[],this.updated=[],this.removed=[],this.operations=[]}commit(){this.inserted=[],this.updated=[],this.removed=[],this.collection._transaction=null}};import Ke from"dot-wild";function L(i,e,t,n,r,o){n={...Q(),...n},e=p(e);let s=[];for(let a of e){let f=[];f=g([...E(i)],a,n,null),f=p(f),s.push(...Se(f,t,a,o))}return n.returnKey===h&&r.timestamps&&s.forEach(a=>{let f;if(r.integerIds){let c=a[h];f=i.__private.id_map[c]}else f=a[h];Object.keys(o.indices).forEach(c=>{if(Ke.get(a,c)){let d=i.__private.index.cuidToValues[f][c],y=String(Ke.get(a,c));d!==y&&(i.__private.index.valuesToCuid[c][y]=i.__private.index.valuesToCuid[c][y]||[],i.__private.index.valuesToCuid[c][y].push(f),i.__private.index.valuesToCuid[c][d]=i.__private.index.valuesToCuid[c][d].filter(m=>m!==m),i.__private.index.valuesToCuid[c][d].length===0&&delete i.__private.index.valuesToCuid[c][d],i.__private.index.cuidToValues[f][c]=y)}}),a[X]=Date.now(),o.merge(a[h],a)}),D(s,n)}function Q(){return{deep:!0,returnKey:h,clonedData:!0,sort:void 0,skip:void 0,project:void 0}}function R(i){let e=new Set(u(I));return l(i)?(Object.keys(i).forEach(t=>{if(l(t)&&u(i[t]).every(n=>e.has(n))){delete i[t];return}if(!l(t)&&e.has(t)){delete i[t];return}if(!!l(i[t])){if(u(i[t]).every(n=>e.has(n))){delete i[t];return}u(i[t]).forEach(n=>{e.has(n)?delete i[t][n]:R(i[t][n])})}}),B(i)):i}var h="_id",at="_created_at",X="_updated_at",G=i=>i!==void 0&&(typeof i=="string"||typeof i=="number"),k=class{storagePath;name;options;data={};_transaction=null;indices={};constructor(e=".data",t="db",n={}){this.storagePath=e,this.name=t,n.autosync=n.autosync??!0,n.timestamps=n.timestamps??!0,n.integerIds=n.integerIds??!1,n.adapter=n.adapter??new C(this.storagePath,this.name),this.options=n;let r=()=>({next_id:0,id_map:{},index:{valuesToCuid:{},cuidToValues:{}}});this.adapterRead(),this.data.__private||(this.data.__private=r())}adapterRead(){this.data=this.options.adapter.read()}assign(e,t){if(e!==void 0){if(this.options.integerIds){let n=e,r=this.data.__private.id_map[n];return r?(this.data[r]=t,this.data[r]):this.insert({...t,[h]:n})[0]}if(typeof e=="string"||typeof e=="number")return this.data[e]=t,this.data[e]}}filter(e){let t=Object.assign({},this.data);return delete t.__private,Object.values(t).filter(n=>{try{return e(n)}catch{return!1}})}find(e,t={}){return W(this.data,e,t,this.options,this)}update(e,t,n={}){return L(this.data,e,t,n,this.options,this)}upsert(e,t,n={}){let r=this.update(e,t,n);if(r.length)return r;e=R(e);let o=this.insert(e);return L(o,e,t,n,this.options,this)}remove(e,t={}){let n=this.find(e,{...t,clonedData:!1}),r=n.map(o=>Object.assign({},o));return n.forEach(o=>{let s;if(this.options.integerIds){let a=o[h];s=this.data.__private.id_map[a],delete this.data.__private.id_map[a]}else s=o[h];Object.keys(this.indices).forEach(a=>{let f=Z.get(o,a);G(f)&&(this.data.__private.index.valuesToCuid[a][f]=this.data.__private.index.valuesToCuid[a][f].filter(c=>c!==s),this.data.__private.index.valuesToCuid[a][f].length===0&&delete this.data.__private.index.valuesToCuid[a][f],delete this.data.__private.index.cuidToValues[s]),f===void 0&&Object.keys(this.data.__private.index.valuesToCuid[a]).forEach(c=>{this.data.__private.index.valuesToCuid[a][c]=this.data.__private.index.valuesToCuid[a][c].filter(d=>d!==s),this.data.__private.index.valuesToCuid[a][c].length===0&&delete this.data.__private.index.valuesToCuid[a][c]})}),delete this.data[s]}),this.sync(),r}insert(e){return Array.isArray(e)||(e=[e]),e.length?(e=e.map(t=>{let n=this.getId();if(this.options.timestamps&&(t[at]=Date.now(),t[X]=Date.now()),t[h]===void 0&&(t[h]=n,this.options.integerIds)){let r=this.nextIntegerId();this.data.__private.id_map[r]=n,t[h]=r}return this.data[n]=t,Object.keys(this.indices).forEach(r=>{let o=String(Z.get(t,r));if(G(o)){if(this.indices[r].unique&&this.data.__private.index.valuesToCuid?.[r]?.[o]!==void 0)throw new Error(`Unique index violation for key "${r}" and value "${o}"`);this.data.__private.index.valuesToCuid[r]=this.data.__private.index.valuesToCuid[r]||{},this.data.__private.index.valuesToCuid[r][o]=this.data.__private.index.valuesToCuid[r][o]||[],this.data.__private.index.valuesToCuid[r][o].push(n),this.data.__private.index.cuidToValues[n]=this.data.__private.index.cuidToValues[n]||{},this.data.__private.index.cuidToValues[n][r]=o}}),t}),this.options.autosync&&this.sync(),e):[]}merge(e,t){if(!!e){if(this.options.integerIds){let n=this.data.__private.id_map[e];if(!n||this.data[n]===void 0)return;Object.assign(this.data[n],T(t)?{}:t),this.sync();return}this.data[e]!==void 0&&(Object.assign(this.data[e],T(t)?{}:t),this.sync())}}sync(){return this.options.adapter.write(this.data)}drop(){this.data={__private:{next_id:0,id_map:{},index:{valuesToCuid:{},cuidToValues:{}}}}}getId(){return st()}createIndex(e={}){if(!e.key)throw new Error("createIndex requires a key");e={key:e.key,unique:e.unique??!1};let{key:t,unique:n}=e;if(t.split(".").some(r=>!isNaN(Number(r))))throw new Error(`Cannot use a numeric property as an index key: ${t}`);if(this.indices[t]={unique:n},!this.data.__private.index.valuesToCuid[t])return Object.keys(this.data).forEach(r=>{if(r==="__private")return;let o=String(Z.get(this.data[r],t));if(G(o)){if(n&&this.data.__private.index.valuesToCuid?.[t]?.[o]!==void 0)throw new Error(`Unique index violation for key "${t}" and value "${o}"`);this.data.__private.index.valuesToCuid[t]=this.data.__private.index.valuesToCuid[t]||{},this.data.__private.index.valuesToCuid[t][o]=this.data.__private.index.valuesToCuid[t][o]||[],this.data.__private.index.valuesToCuid[t][o].push(r),this.data.__private.index.cuidToValues[r]=this.data.__private.index.cuidToValues[r]||{},this.data.__private.index.cuidToValues[r][t]=o}else throw new Error(`Invalid index value for property ${t}: ${o}`)}),this.sync(),this}removeIndex(e){return this.indices[e]?(delete this.indices[e],this.data.__private.index.valuesToCuid[e]&&delete this.data.__private.index.valuesToCuid[e],Object.keys(this.data.__private.index.cuidToValues).forEach(t=>{this.data.__private.index.cuidToValues[t][e]!==void 0&&delete this.data.__private.index.cuidToValues[t][e],T(this.data.__private.index.cuidToValues[t])&&delete this.data.__private.index.cuidToValues[t]}),this.sync(),!0):!1}nextIntegerId(){return this.data.__private.next_id++}transaction(e){this._transaction=new M(this);try{e(this._transaction)}catch(t){throw this._transaction.rollback(),t}this._transaction.commit()}};import w from"fs";import Ne from"path";import z from"crypto";var F=class{storagePath;name;filePath;queue;constructor(e,t){t.endsWith(".json")||(t+=".json"),this.storagePath=e,this.name=t,this.queue=new S,this.filePath=Ne.join(this.storagePath,this.name),this.prepareStorage()}prepareStorage(){w.existsSync(this.storagePath)||w.mkdirSync(this.storagePath),w.existsSync(this.filePath)||w.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{let e=w.readFileSync(this.filePath,"utf8"),t=ut(e);return Object.assign({},JSON.parse(t)||{})}catch{return{}}}write(e){for(this.queue.push([t=>{ft(t,this.filePath)},e]);this.queue.length();){let t=this.queue.shift();t[0](t[1])}}},Qe=String(process.env.ARC_ENCFS_KEY||"Mahpsee2X7TKLe1xwJYmar91pCSaZIY7"),ft=(i,...e)=>{let t=JSON.stringify(i,null,0);return ct(lt(t),...e)},ct=(i,...e)=>w.writeFileSync(Ne.join(...e),i),lt=i=>{let e=Buffer.from(z.randomBytes(16)).toString("hex").slice(0,16),t=z.createCipheriv("aes-256-cbc",Buffer.from(Qe),e),n=Buffer.concat([t.update(i),t.final()]);return`${e}:${n.toString("hex")}`},ut=i=>{let e=i.includes(":")?i.split(":"):[],t=Buffer.from(e.shift()||"","binary"),n=Buffer.from(e.join(":"),"hex"),r=z.createDecipheriv("aes-256-cbc",Buffer.from(Qe),t);return Buffer.concat([r.update(n),r.final()]).toString()};var Y=class{storageKey;constructor(e){this.storageKey=`arc_${e}`}read(){try{return Object.assign({},JSON.parse(localStorage.getItem(`arc_${this.storageKey}`)||"{}"))}catch(e){return console.error(`arc: failed to read from key: ${this.storageKey}: ${e}`),{}}}write(e){localStorage.setItem(this.storageKey,JSON.stringify(e))}};export{k as Collection,F as EncryptedFSAdapter,C as FSAdapter,Y as LocalStorageAdapter};
