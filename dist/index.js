import st from"cuid";import Z from"dot-wild";import U from"lodash";import rt from"dot-wild";import Fe from"cuid";import b from"dot-wild";import P from"lodash";function p(r){return Array.isArray(r)?r:r==null?[]:[r]}function l(r){return!!r&&Object.prototype.toString.call(r)==="[object Object]"}function T(r){return l(r)&&u(r).length===0}var E=Object.values,u=Object.keys,O=(r,e)=>r?Object.prototype.hasOwnProperty.call(r,e):!1;function q(r){return typeof r=="function"}function B(r){return l(r)&&u(r).forEach(e=>{!r[e]||!l(r[e])||(B(r[e]),u(r[e]).length===0&&delete r[e])}),r}var Ye=r=>r.map(e=>t=>t[e]),Be=r=>r.map(e=>e===1?"asc":"desc");function He(r,e){let t={$floor:(n,i)=>{let o=b.get(n,i);return typeof o=="number"?Math.floor(o):0},$ceil:(n,i)=>{let o=b.get(n,i);return typeof o=="number"?Math.ceil(o):0},$sub:(n,i)=>{let o;for(let s of i)typeof s=="number"?o===void 0?o=s:o-=s:o===void 0?o=Number(b.get(n,s)??0):o-=Number(b.get(n,s)??0);return o},$add:(n,i)=>{let o;for(let s of i)typeof s=="number"?o===void 0?o=s:o+=s:o===void 0?o=Number(b.get(n,s)??0):o+=Number(b.get(n,s)??0);return o},$mult:(n,i)=>{let o=1;for(let s of i)typeof s=="number"?o*=s:o*=Number(b.get(n,s)??1);return o},$div:(n,i)=>{let o;for(let s of i)typeof s=="number"?o===void 0?o=s:o/=s:o===void 0?o=Number(b.get(n,s)??1):o/=Number(b.get(n,s)??1);return o},$fn:(n,i)=>i(n)};return u(e.aggregate).forEach(n=>{typeof e.aggregate[n]=="object"&&u(e.aggregate[n]).forEach(i=>{i[0]==="$"&&(!t[i]||(r=r.map(o=>(o[n]=t[i](o,e.aggregate[n][i]),o))))})}),r}function D(r,e){if(e.aggregate&&(r=He(r,e)),e.project){let i=Object.keys(e.project).reduce((s,a)=>{if(typeof e.project[a]=="number"&&typeof s=="number")return s+e.project[a]},0),o=i===Object.keys(e.project).length?1:i===0?2:0;if(o===1)r=r.map(s=>P.pick(s,u(e.project)));else if(o===2)r=r.map(s=>P.omit(s,u(e.project)));else if(o===0){let s=Object.keys(e.project).filter(a=>e.project[a]===0);r=r.map(a=>P.omit(a,s))}}e.sort&&(r=P.orderBy(r,Ye(u(e.sort)),Be(E(e.sort)))),e.skip&&typeof e.skip=="number"&&(r=r.slice(e.skip)),e.take&&typeof e.take=="number"&&(r=r.slice(0,e.take)),e.join&&Array.isArray(e.join)&&e.join.forEach(i=>{if(!i.collection)throw new Error("Missing required field in join: collection");if(!i.from)throw new Error("Missing required field in join: from");if(!i.on)throw new Error("Missing required field in join: on");if(!i.as)throw new Error("Missing required field in join: as");let o=i?.options||{},s=i.collection,a=Fe(),f=!1;r=r.map(c=>{if(i.as.includes(".")){if(!i.as.includes("*"))throw new Error("as field must include * when using dot notation, e.g. items.*.meta");f=!0}f||(c[i.as]=p(c[i.as])),c[a]=[];let d=i.from.includes(".")?b.get(c,i.from):c[i.from];if(d===void 0)return c;if(Array.isArray(d))return d.forEach((m,_)=>{let j={[`${i.on}`]:m};f?c=b.set(c,i.as.replaceAll("*",_.toString()),s.find(j,o)[0]):c[a]=c[a].concat(s.find(j,o))}),f||(c[i.as]=c[a]),delete c[a],c;let y={[`${i.on}`]:d};return f||(c[a]=s.find(y,o),c[i.as]=c[a]),delete c[a],c})});function t(i,o){for(let s in o){let a=b.get(i,s);a==null&&(typeof o[s]=="function"?i=b.set(i,s,o[s](i)):i=b.set(i,s,o[s]))}return i}function n(i,o){for(let s in o){let a=b.get(i,s);Array.isArray(a)&&a.length===0&&(typeof o[s]=="function"?i=b.set(i,s,o[s](i)):i=b.set(i,s,o[s])),typeof a=="string"&&a.trim().length===0&&(typeof o[s]=="function"?i=b.set(i,s,o[s](i)):i=b.set(i,s,o[s])),typeof a=="object"&&Object.keys(a).length===0&&(typeof o[s]=="function"?i=b.set(i,s,o[s](i)):i=b.set(i,s,o[s]))}return i}return e.ifNull&&(r=r.map(i=>t(i,e.ifNull))),e.ifEmpty&&(r=r.map(i=>n(i,e.ifEmpty))),e.ifNullOrEmpty&&(r=r.map(i=>t(i,e.ifNullOrEmpty)).map(i=>n(i,e.ifNullOrEmpty))),r}import Pe from"dot-wild";import Je from"dot-wild";function ee(r,e){let t=!1;return l(e)&&u(e).forEach(n=>{let i=e[n].$gt;i=p(i);let o=Je.get(r,n);o!==void 0&&i.forEach(s=>{typeof o=="string"||typeof o=="number"?o>s&&(t=!0):Array.isArray(o)&&o.length>s&&(t=!0)})}),t}import Ue from"dot-wild";function te(r,e){let t=!1;return l(e)&&u(e).forEach(n=>{let i=e[n].$gte;i=p(i);let o=Ue.get(r,n);o!==void 0&&i.forEach(s=>{typeof o=="string"||typeof o=="number"?o>=s&&(t=!0):Array.isArray(o)&&o.length>=s&&(t=!0)})}),t}import We from"dot-wild";function re(r,e){let t=!1;return l(e)&&u(e).forEach(n=>{let i=e[n].$lt;i=p(i);let o=We.get(r,n);o!==void 0&&i.forEach(s=>{typeof o=="string"||typeof o=="number"?o<s&&(t=!0):Array.isArray(o)&&o.length<s&&(t=!0)})}),t}import Le from"dot-wild";function ie(r,e){let t=!1;return l(e)&&u(e).forEach(n=>{let i=e[n].$lte;i=p(i);let o=Le.get(r,n);o!==void 0&&i.forEach(s=>{typeof o=="string"||typeof o=="number"?o<=s&&(t=!0):Array.isArray(o)&&o.length<=s&&(t=!0)})}),t}import ne from"dot-wild";function oe(r,e){let t=[];return l(e)&&u(e).forEach(n=>{if(n!=="$and")return;let i=e[n];i=p(i),i.forEach(o=>{u(o).forEach(s=>{let a=ne.get(o,s),f=ne.get(r,s);if(typeof a=="function"&&f!==void 0)t.push(a(f));else{let c=g(r,o,{deep:!0,returnKey:h,clonedData:!0},r);t.push(Boolean(c&&c.length))}})})}),!(!t.length||t.length&&t.includes(!1))}import se from"dot-wild";function ae(r,e){let t=[];return l(e)&&u(e).forEach(n=>{if(n!=="$or")return;let i=e[n];i=p(i),i.forEach(o=>{u(o).forEach(s=>{let a=se.get(o,s),f=se.get(r,s);if(typeof a=="function"&&f!==void 0)t.push(a(f));else{let c=g(r,o,{deep:!0,returnKey:h,clonedData:!0},r);t.push(Boolean(c&&c.length))}})})}),t.length?!!(t.length&&t.includes(!0)):!1}import fe from"dot-wild";function ce(r,e){let t=[];return l(e)&&u(e).forEach(n=>{if(n!=="$xor")return;let i=e[n];if(i=p(i),i.length!==2)throw new Error(`invalid $xor query. expected exactly two values, found ${i.length}.`);i.forEach(o=>{u(o).forEach(s=>{let a=fe.get(o,s)??o[s],f=fe.get(r,s);if(typeof a=="function"&&f!==void 0)t.push(a(f));else{let c=g(r,o,{deep:!0,returnKey:h,clonedData:!0},r);t.push(Boolean(c&&c.length))}})})}),t.length===2?t.filter(n=>n).length===1:!1}import Xe from"dot-wild";function le(r,e){let t;return l(e)&&u(e).forEach(n=>{if(l(e[n])){let i=Xe.get(r,n);if(i===void 0)return;u(e[n]).forEach(o=>{o==="$fn"&&(t=!0,p(e[n][o]).forEach(s=>{s(i)||(t=!1)}))})}}),t!==void 0?t:!1}import Ze from"dot-wild";function ue(r,e){let t;return l(e)&&u(e).forEach(n=>{if(l(e[n])){let i=Ze.get(r,n);if(i===void 0)return;u(e[n]).forEach(o=>{o==="$re"&&(t=!0,p(e[n][o]).forEach(s=>{s.test(i)||(t=!1)}))})}}),t!==void 0?t:!1}import pe from"dot-wild";function de(r,e){let t=[];return l(e)&&u(e).forEach(n=>{let i=e[n].$includes;i=p(i),pe.get(r,n)&&i.forEach(o=>{t.push(pe.get(r,n).includes(o))})}),!(!t.length||t.length&&t.includes(!1))}import Ge from"dot-wild";function he(r,e){let t=[];return l(e)&&u(e).forEach(n=>{let i=e[n].$oneOf;i=p(i);let o=Ge.get(r,n);o!==void 0&&t.push(i.includes(o))}),!(!t.length||t.length&&t.includes(!1))}import ke from"dot-wild";function me(r,e){let t=!1;return l(e)&&u(e).forEach(n=>{let i=e[n].$length,o=ke.get(r,n);o!==void 0&&(Array.isArray(o)||typeof o=="string")&&o.length===i&&(t=!0)}),t}function ge(r,e){let t=[];return l(e)&&u(e).forEach(n=>{if(n!=="$not")return;if(!l(e[n]))throw new Error(`$not operator requires an object as its value, received: ${e[n]}`);let i=p(e[n]);t.push(i.every(o=>{if(l(o)){let s=g(r,o,{deep:!0,returnKey:h,clonedData:!0},r);return!(s&&s.length)}return O(r,o)}))}),t.every(n=>!n)||!1}import ze from"dot-wild";function be(r,e){let t=!1;return l(e)&&u(e).forEach(n=>{if(n!=="$has")return;let i=e[n];i=p(i),t=i.every(o=>ze.get(r,o)!==void 0)}),t}import qe from"dot-wild";function ye(r,e){let t=!1;return l(e)&&u(e).forEach(n=>{if(n!=="$hasAny")return;let i=e[n];i=p(i),t=i.some(o=>qe.get(r,o))}),t}var A=(r,e,t,n=!1)=>{if(r===void 0)return;let i=o=>{if(!l(o))return o;let s={...o};return v(s,e)&&u(t).forEach(a=>{n?s={...s,[a]:t[a]}:O(s,a)&&(s={...s,[a]:t[a]})}),u(s).forEach(a=>{(l(s[a])||Array.isArray(s[a]))&&(s={...s,[a]:A(s[a],e,t,n)})}),s};return(Array.isArray(r)||l(r))&&!T(e)&&!T(t)?Array.isArray(r)?r.map(o=>i(o)):i(r):r};function Te(r,e,t,n){return p(e).forEach(o=>{if(!l(o)&&!Array.isArray(o)){let s={};u(t).forEach(a=>{s[a]=o}),r=A(r,t,s,!0);return}r=A(r,t,o,!0)}),r}import et from"dot-wild";function H(r,e,t,n){return p(e).forEach(o=>{if(Array.isArray(o))return H(r,o,t,n);r=r.map(s=>et.set(s,o,void 0))}),r}function Oe(r,e,t,n){return p(e).forEach(o=>{if(!l(o)&&!Array.isArray(o)){let s={};u(t).forEach(a=>{s[a]=o}),r=A(r,t,s,!1)}else r=A(r,t,o,!1)}),r}function V(r,e,t,n,i){let o=p(e),s=g(r,t,{deep:!0,returnKey:h,clonedData:!1});return o.forEach(a=>{if(l(a)&&u(a).forEach(f=>{s.forEach(c=>{let d=g([c],t,{returnKey:f,deep:!0,clonedData:!1});(d?.length?d:s).forEach(m=>{if(O(m,f))n===0?m[f]+=a[f]:n===1?m[f]-=a[f]:n===2?m[f]*=a[f]:n===3&&(m[f]/=a[f]);else{let _=u(t)[0],j=g([m],t,{returnKey:_,deep:!0,clonedData:!1});j&&j.forEach(x=>{n===0?x[f]=a[f]:n===1?x[f]=-a[f]:n===2?x[f]=a[f]:n===3&&(x[f]=1/a[f])})}})})}),!l(a)){if(!s||!s.length)return;u(t).forEach(f=>{s.forEach(c=>{let d=g([c],t,{returnKey:f,deep:!0,clonedData:!1});(d?.length?d:s).forEach(m=>{O(m,f)?n===0?m[f]+=a:n===1?m[f]-=a:n===2?m[f]*=a:n===3&&(m[f]/=a):n===0?m[f]=a:n===1?m[f]=-a:n===2?m[f]=a:n===3&&(m[f]=1/a)})})})}}),r}function _e(r,e,t,n){return V(r,e,t,0,n)}function je(r,e,t,n){return V(r,e,t,1,n)}function ve(r,e,t,n){return V(r,e,t,2,n)}function xe(r,e,t,n){return V(r,e,t,3,n)}import tt from"lodash";function J(r,e,t,n=!1){if(r===void 0)return;let i=o=>{if(!l(o))return o;let s={...o};return v(s,e)&&(n?s=tt.merge(s,t):s={...s,...t}),u(s).forEach(a=>{(l(s[a])||Array.isArray(s[a]))&&(s={...s,[a]:J(s[a],e,t)})}),s};return(Array.isArray(r)||l(r))&&!T(e)&&!T(t)?Array.isArray(r)?r.map(o=>i(o)):i(r):r}function Ee(r,e,t,n){return p(e).forEach(o=>{r=J(r,t,o,!0)}),r}function Ae(r,e,t,n){if(typeof e!="function")throw new Error("$map expected a function, e.g. { $map: (doc) => doc }");return r.map((i,o,s)=>e(i,o,s))}import $e from"dot-wild";function Ce(r,e,t,n){if(q(e))return r.filter((i,o,s)=>e(i,o,s)?!0:(i[h]&&n.remove({[h]:i[h]}),!1));if(l(e))return r.map(i=>(Object.keys(e).forEach(o=>{let s=$e.get(i,o);if(!Array.isArray(s))throw new Error(`$filter when providing an object to filter on, the key being operated on in the source document must be an array: ${o} was not an array`);let a=s.filter((f,c,d)=>e[o](f,c,d));i=$e.set(i,o,a)}),i));throw new Error("$filter expected either a function, e.g. { $filter: (doc) => doc }, or an array path with a function key, e.g. { $filter: { anArray: (doc) => doc } }")}import K from"dot-wild";function we(r,e,t,n){return p(e).forEach(o=>{l(o)&&Object.keys(o).forEach(s=>{r=r.map(a=>{if(K.get(a,s)!==void 0){let f=K.get(a,s),c=o[s];if(Array.isArray(c)){let d=f.concat(c);a=K.set(a,s,d)}else{let d=f.concat([c]);a=K.set(a,s,d)}}return a})})}),r}import N from"dot-wild";function De(r,e,t,n){return p(e).forEach(o=>{l(o)&&Object.keys(o).forEach(s=>{r=r.map(a=>{if(N.get(a,s)!==void 0){let f=N.get(a,s),c=o[s];if(Array.isArray(c)){let d=c.concat(f);a=N.set(a,s,d)}else{let d=[c].concat(f);a=N.set(a,s,d)}}return a})})}),r}var S={$gt:ee,$gte:te,$lt:re,$lte:ie,$and:oe,$or:ae,$xor:ce,$includes:de,$oneOf:he,$fn:le,$re:ue,$length:me,$not:ge,$has:be,$hasAny:ye},Se={$merge:Ee,$map:Ae,$filter:Ce,$push:we,$unshift:De,$set:Te,$unset:H,$change:Oe,$inc:_e,$dec:je,$mult:ve,$div:xe};function Ie(r,e,t,n){return u(e).forEach(i=>{if(!Se[i]){console.warn(`unknown operator: ${i}`);return}r=Se[i](r,e[i],t,n)}),r}function v(r,e){if(typeof r!=typeof e)return!1;let t=(n,i)=>{if(n[i]===e[i])return!0;let o=[];return i.startsWith("$")&&o.push(i),i!=="$not"&&l(e[i])&&!T(e[i])&&(o=o.concat(u(e[i]).filter(s=>s.startsWith("$")))),o.length?o.every(s=>s==="$not"?!S[s](n,e):S[s](n,e)):i.includes(".")?Pe.get(n,i)===e[i]:O(n,i)&&v(n[i],e[i])};return Array.isArray(r)&&Array.isArray(e)?r.some(n=>l(n)||Array.isArray(n))||e.some(n=>l(n)||Array.isArray(n))?r.every((n,i)=>v(r[i],e[i])):[...r].map(n=>`${n}`).sort().join(",")===[...e].map(n=>`${n}`).sort().join(","):Array.isArray(r)&&l(e)?Object.keys(e).every(n=>t(r,n)):l(r)&&l(e)?u(e).every(n=>t(r,n)):r===e}function g(r,e,t,n=null){if(r===void 0)return;r.__private&&delete r.__private,O(r,t.returnKey)&&(n=r);let i,o=Object.keys(e).some(f=>f.startsWith("$"));function s(f){if(!(!f||T(f))){if(i=p(i),f=p(f),Array.isArray(i)&&Array.isArray(f)){let c=i.map(d=>d[t.returnKey]);if(f.some(d=>c.includes(d[t.returnKey])))return}i=i.concat(f)}}function a(f){!f||(O(f,t.returnKey)&&(n=f),v(f,e)?s(n):t.deep&&!o&&u(f).forEach(c=>{(l(f[c])||Array.isArray(f[c]))&&(O(e,c)?s(g(f[c],e[c],t,n)):s(g(f[c],e,t,n)))}))}if(r=p(r),l(e)&&Array.isArray(r)&&!o&&r.forEach((f,c)=>{O(f,t.returnKey)&&(n=f),u(e).forEach(d=>{if(typeof d=="string"&&d.includes(".")){let y=Pe.get(f,d);y!==void 0&&s(g(y,e[d],t,n))}else l(f)?v(r[c],e[d])&&s(n):v(r,e[d])&&s(n)})}),!T(e)&&Array.isArray(r))r.forEach(f=>a(f));else return r;return i}var it=(r,e)=>{let t=new Map,n;return r=p(r),r.filter(i=>{if(i!==void 0)return n=t.get(i[e]),n?i[e]!=n?(t.delete(i[e]),t.set(i[e],i[e]),!0):!1:(t.set(i[e],i[e]),!0)})};function W(r,e,t,n,i){if(t={...Q(),...t},e=p(e),e=e.filter(c=>Object.keys(c).length>0),!e.length){if(t.clonedData){let c=[];for(let d in r)d!=="__private"&&c.push(U.cloneDeep(r[d]));return c}return D([...E(r)],t)}let o=[...E(r)].slice(1),s=[];for(let c of e){let d=[];if(c[h]&&!l(c[h])&&!n.integerIds)d.push(r[c[h]]);else if(c[h]&&!l(c[h])&&n.integerIds){let y=r.__private.id_map[c[h]];y&&d.push(r[y])}else{let y=R(U.cloneDeep(c)),m=Object.fromEntries(Object.entries(rt.flatten(y)).map(([_,j])=>[_.replace(/\\./g,"."),j]));Object.keys(m).some(_=>i.indices[_])?Object.keys(i.indices).forEach(_=>{let j=_.includes(".")?m[_]:c[_];if(j){let x=r.__private.index.valuesToCuid?.[_]?.[j];if(x){let Re=x?.map(Me=>r[Me]);d.push(...g(Re,c,t,n))}else d.push(...g(o,c,t,i))}}):(d=g(o,c,t,null),d===void 0&&(d=[]),d=p(d))}s.push(...d)}let a=it(s,h);if(s=D(a,t),!t.clonedData)return s;let f=[];for(let c of s)f.push(U.cloneDeep(c));return f}import $ from"fs";import Ve from"path";var I=class{elements=[];push(...e){this.elements.push(...e)}shift(){return this.elements.shift()}length(){return this.elements.length}},C=class{storagePath;name;filePath;queue;constructor(e,t){t.endsWith(".json")||(t+=".json"),this.storagePath=e,this.name=t,this.queue=new I,this.filePath=Ve.join(this.storagePath,this.name),this.prepareStorage()}prepareStorage(){$.existsSync(this.storagePath)||$.mkdirSync(this.storagePath),$.existsSync(this.filePath)||$.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{return Object.assign({},JSON.parse($.readFileSync(this.filePath,"utf8"))||{})}catch{return{}}}write(e){for(this.queue.push([t=>{nt(t,this.filePath)},e]);this.queue.length();){let t=this.queue.shift();t[0](t[1])}}};function nt(r,...e){let n=(process.env.NODE_ENV||"development")==="development"?2:0,i=JSON.stringify(r,null,n);return ot(i,...e)}function ot(r,...e){let t=Ve.join(...e);return $.writeFileSync(t,r)}var M=class{collection;inserted=[];removed=[];updated=[];operations=[];constructor(e){this.collection=e}insert(e){let t=this.collection.insert(e);return this.inserted.push(t),this.operations.push("insert"),t}update(e,t,n={}){let i=this.collection.find(e,{...n,project:void 0,join:void 0});return this.updated.push({documents:i,operations:t,options:n}),this.operations.push("update"),this.collection.update(e,t,n)}remove(e,t={}){let n=this.collection.find(e,{...t,project:void 0,join:void 0});return this.collection.remove(e,t),this.removed.push(n),this.operations.push("remove"),n}rollback(){let e=i=>{i.forEach(o=>{o[h]!==void 0?this.collection.remove({[h]:o[h]}):this.collection.remove({...o})})},t=i=>{i.documents.forEach(o=>{o[h]!==void 0?this.collection.assign(o[h],o):this.collection.update({...o},i.operations,i.options)})},n=i=>{i.forEach(o=>{o[h]!==void 0&&this.collection.assign(o[h],o)})};this.operations.reverse().forEach(i=>{switch(i){case"insert":e(this.inserted.pop());break;case"update":t(this.updated.pop());break;case"remove":n(this.removed.pop());break}}),this.inserted=[],this.updated=[],this.removed=[],this.operations=[]}commit(){this.inserted=[],this.updated=[],this.removed=[],this.collection._transaction=null}};import Ke from"dot-wild";function L(r,e,t,n,i,o){n={...Q(),...n},e=p(e);let s=[];for(let a of e){let f=[];f=g([...E(r)],a,n,null),f=p(f),s.push(...Ie(f,t,a,o))}return n.returnKey===h&&i.timestamps&&s.forEach(a=>{let f;if(i.integerIds){let c=a[h];f=r.__private.id_map[c]}else f=a[h];Object.keys(o.indices).forEach(c=>{if(Ke.get(a,c)){let d=r.__private.index.cuidToValues[f][c],y=String(Ke.get(a,c));d!==y&&(r.__private.index.valuesToCuid[c][y]=r.__private.index.valuesToCuid[c][y]||[],r.__private.index.valuesToCuid[c][y].push(f),r.__private.index.valuesToCuid[c][d]=r.__private.index.valuesToCuid[c][d].filter(m=>m!==m),r.__private.index.valuesToCuid[c][d].length===0&&delete r.__private.index.valuesToCuid[c][d],r.__private.index.cuidToValues[f][c]=y)}}),a[X]=Date.now(),o.merge(a[h],a)}),D(s,n)}function Q(){return{deep:!0,returnKey:h,clonedData:!0,sort:void 0,skip:void 0,project:void 0}}function R(r){let e=new Set(u(S));return l(r)?(Object.keys(r).forEach(t=>{if(l(t)&&u(r[t]).every(n=>e.has(n))){delete r[t];return}if(!l(t)&&e.has(t)){delete r[t];return}if(!!l(r[t])){if(u(r[t]).every(n=>e.has(n))){delete r[t];return}u(r[t]).forEach(n=>{e.has(n)?delete r[t][n]:R(r[t][n])})}}),B(r)):r}var h="_id",at="_created_at",X="_updated_at",G=r=>r!==void 0&&(typeof r=="string"||typeof r=="number"||typeof r=="boolean"),k=class{storagePath;name;options;data={};_transaction=null;indices={};constructor(e=".data",t="db",n={}){this.storagePath=e,this.name=t,n.autosync=n.autosync??!0,n.timestamps=n.timestamps??!0,n.integerIds=n.integerIds??!1,n.adapter=n.adapter??new C(this.storagePath,this.name),this.options=n;let i=()=>({next_id:0,id_map:{},index:{valuesToCuid:{},cuidToValues:{}}});this.adapterRead(),this.data.__private||(this.data.__private=i())}adapterRead(){this.data=this.options.adapter.read()}assign(e,t){if(e!==void 0){if(this.options.integerIds){let n=e,i=this.data.__private.id_map[n];return i?(this.data[i]=t,this.data[i]):this.insert({...t,[h]:n})[0]}if(typeof e=="string"||typeof e=="number")return this.data[e]=t,this.data[e]}}filter(e){let t=Object.assign({},this.data);return delete t.__private,Object.values(t).filter(n=>{try{return e(n)}catch{return!1}})}find(e,t={}){return W(this.data,e,t,this.options,this)}update(e,t,n={}){return L(this.data,e,t,n,this.options,this)}upsert(e,t,n={}){let i=this.update(e,t,n);if(i.length)return i;e=R(e);let o=this.insert(e);return L(o,e,t,n,this.options,this)}remove(e,t={}){let n=this.find(e,{...t,clonedData:!1}),i=n.map(o=>Object.assign({},o));return n.forEach(o=>{let s;if(this.options.integerIds){let a=o[h];s=this.data.__private.id_map[a],delete this.data.__private.id_map[a]}else s=o[h];Object.keys(this.indices).forEach(a=>{let f=Z.get(o,a);G(f)&&(this.data.__private.index.valuesToCuid[a][f]=this.data.__private.index.valuesToCuid[a][f].filter(c=>c!==s),this.data.__private.index.valuesToCuid[a][f].length===0&&delete this.data.__private.index.valuesToCuid[a][f],delete this.data.__private.index.cuidToValues[s]),f===void 0&&Object.keys(this.data.__private.index.valuesToCuid[a]).forEach(c=>{this.data.__private.index.valuesToCuid[a][c]=this.data.__private.index.valuesToCuid[a][c].filter(d=>d!==s),this.data.__private.index.valuesToCuid[a][c].length===0&&delete this.data.__private.index.valuesToCuid[a][c]})}),delete this.data[s]}),this.sync(),i}insert(e){return Array.isArray(e)||(e=[e]),e.length?(e=e.map(t=>{let n=this.getId();if(this.options.timestamps&&(t[at]=Date.now(),t[X]=Date.now()),t[h]===void 0&&(t[h]=n,this.options.integerIds)){let i=this.nextIntegerId();this.data.__private.id_map[i]=n,t[h]=i}return this.data[n]=t,Object.keys(this.indices).forEach(i=>{let o=String(Z.get(t,i));if(G(o)){if(this.indices[i].unique&&this.data.__private.index.valuesToCuid?.[i]?.[o]!==void 0)throw new Error(`Unique index violation for key "${i}" and value "${o}"`);this.data.__private.index.valuesToCuid[i]=this.data.__private.index.valuesToCuid[i]||{},this.data.__private.index.valuesToCuid[i][o]=this.data.__private.index.valuesToCuid[i][o]||[],this.data.__private.index.valuesToCuid[i][o].push(n),this.data.__private.index.cuidToValues[n]=this.data.__private.index.cuidToValues[n]||{},this.data.__private.index.cuidToValues[n][i]=o}}),t}),this.options.autosync&&this.sync(),e):[]}merge(e,t){if(!!e){if(this.options.integerIds){let n=this.data.__private.id_map[e];if(!n||this.data[n]===void 0)return;Object.assign(this.data[n],T(t)?{}:t),this.sync();return}this.data[e]!==void 0&&(Object.assign(this.data[e],T(t)?{}:t),this.sync())}}sync(){return this.options.adapter.write(this.data)}drop(){this.data={__private:{next_id:0,id_map:{},index:{valuesToCuid:{},cuidToValues:{}}}}}getId(){return st()}createIndex(e={}){if(!e.key)throw new Error("createIndex requires a key");e={key:e.key,unique:e.unique??!1};let{key:t,unique:n}=e;if(t.split(".").some(i=>!isNaN(Number(i))))throw new Error(`Cannot use a numeric property as an index key: ${t}`);if(this.indices[t]={unique:n},!this.data.__private.index.valuesToCuid[t])return Object.keys(this.data).forEach(i=>{if(i==="__private")return;let o=String(Z.get(this.data[i],t));if(G(o)){if(n&&this.data.__private.index.valuesToCuid?.[t]?.[o]!==void 0)throw new Error(`Unique index violation for key "${t}" and value "${o}"`);this.data.__private.index.valuesToCuid[t]=this.data.__private.index.valuesToCuid[t]||{},this.data.__private.index.valuesToCuid[t][o]=this.data.__private.index.valuesToCuid[t][o]||[],this.data.__private.index.valuesToCuid[t][o].push(i),this.data.__private.index.cuidToValues[i]=this.data.__private.index.cuidToValues[i]||{},this.data.__private.index.cuidToValues[i][t]=o}else throw new Error(`Invalid index value for property ${t}: ${o}`)}),this.sync(),this}removeIndex(e){return this.indices[e]?(delete this.indices[e],this.data.__private.index.valuesToCuid[e]&&delete this.data.__private.index.valuesToCuid[e],Object.keys(this.data.__private.index.cuidToValues).forEach(t=>{this.data.__private.index.cuidToValues[t][e]!==void 0&&delete this.data.__private.index.cuidToValues[t][e],T(this.data.__private.index.cuidToValues[t])&&delete this.data.__private.index.cuidToValues[t]}),this.sync(),!0):!1}nextIntegerId(){return this.data.__private.next_id++}transaction(e){this._transaction=new M(this);try{e(this._transaction)}catch(t){throw this._transaction.rollback(),t}this._transaction.commit()}};import w from"fs";import Ne from"path";import z from"crypto";var F=class{storagePath;name;filePath;queue;constructor(e,t){t.endsWith(".json")||(t+=".json"),this.storagePath=e,this.name=t,this.queue=new I,this.filePath=Ne.join(this.storagePath,this.name),this.prepareStorage()}prepareStorage(){w.existsSync(this.storagePath)||w.mkdirSync(this.storagePath),w.existsSync(this.filePath)||w.writeFileSync(this.filePath,JSON.stringify({}))}read(){try{let e=w.readFileSync(this.filePath,"utf8"),t=ut(e);return Object.assign({},JSON.parse(t)||{})}catch{return{}}}write(e){for(this.queue.push([t=>{ft(t,this.filePath)},e]);this.queue.length();){let t=this.queue.shift();t[0](t[1])}}},Qe=String(process.env.ARC_ENCFS_KEY||"Mahpsee2X7TKLe1xwJYmar91pCSaZIY7"),ft=(r,...e)=>{let t=JSON.stringify(r,null,0);return ct(lt(t),...e)},ct=(r,...e)=>w.writeFileSync(Ne.join(...e),r),lt=r=>{let e=Buffer.from(z.randomBytes(16)).toString("hex").slice(0,16),t=z.createCipheriv("aes-256-cbc",Buffer.from(Qe),e),n=Buffer.concat([t.update(r),t.final()]);return`${e}:${n.toString("hex")}`},ut=r=>{let e=r.includes(":")?r.split(":"):[],t=Buffer.from(e.shift()||"","binary"),n=Buffer.from(e.join(":"),"hex"),i=z.createDecipheriv("aes-256-cbc",Buffer.from(Qe),t);return Buffer.concat([i.update(n),i.final()]).toString()};var Y=class{storageKey;constructor(e){this.storageKey=`arc_${e}`}read(){try{return Object.assign({},JSON.parse(localStorage.getItem(`arc_${this.storageKey}`)||"{}"))}catch(e){return console.error(`arc: failed to read from key: ${this.storageKey}: ${e}`),{}}}write(e){localStorage.setItem(this.storageKey,JSON.stringify(e))}};export{k as Collection,F as EncryptedFSAdapter,C as FSAdapter,Y as LocalStorageAdapter};
